<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ekip Takip Pro (Stabil)</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4facfe">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>

    <style>
        :root { --primary: #2c3e50; --accent: #3498db; --grad: linear-gradient(135deg, #667eea 0%, #764ba2 100%); --bg: #f3f5f9; }
        body { font-family: 'Poppins', sans-serif; background: var(--bg); margin: 0; padding-bottom: 100px; color: #333; -webkit-tap-highlight-color: transparent; }

        /* LOGIN */
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--grad); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .login-box { background: white; padding: 30px; border-radius: 20px; width: 85%; max-width: 350px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .login-box input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #eee; border-radius: 8px; box-sizing: border-box; }
        .login-box button { width: 100%; padding: 12px; background: #764ba2; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }

        /* APP */
        .hidden { display: none !important; } .admin-only { display: none; }
        .app-header { padding: 20px; display: flex; justify-content: space-between; align-items: center; background: white; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .icon-btn { border: none; background: #f0f2f5; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; font-size: 1.2rem; }

        .container { max-width: 800px; margin: 20px auto; padding: 0 15px; }
        .view-section { display: none; animation: fadeIn 0.3s; } .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* CARDS */
        .card { background: white; border-radius: 15px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.03); }
        .hero-card { background: var(--grad); color: white; border-radius: 20px; padding: 20px; margin-bottom: 20px; text-align: center; }
        .hero-stats { display: flex; justify-content: space-around; margin-top: 15px; }
        .stat-item span { font-size: 1.5rem; font-weight: bold; display: block; }
        
        /* LISTS */
        .info-item { padding: 12px; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center; }
        .info-item:last-child { border-bottom: none; }
        .badge { padding: 4px 8px; border-radius: 6px; font-size: 0.7rem; font-weight: bold; }
        .badge-green { background: #d1fae5; color: #065f46; } .badge-red { background: #fee2e2; color: #991b1b; } .badge-orange { background: #ffedd5; color: #9a3412; }

        /* CALENDAR */
        .cal-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; }
        .day { background: white; height: 70px; border-radius: 8px; padding: 4px; font-size: 0.8rem; cursor: pointer; border: 1px solid #eee; display: flex; flex-direction: column; overflow: hidden; }
        .day.today { border-color: #764ba2; font-weight: bold; }
        .dot { width: 100%; height: 4px; background: #764ba2; margin-top: 2px; border-radius: 2px; }
        
        /* FORMS */
        input, select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 10px; box-sizing: border-box; }
        .btn { padding: 10px 15px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; width: 100%; margin-bottom: 5px; }
        .btn-primary { background: var(--grad); color: white; }
        .btn-sm { padding: 5px 10px; font-size: 0.8rem; width: auto; }
        .btn-outline-red { background: transparent; border: 1px solid #e74c3c; color: #e74c3c; }
        .btn-outline-blue { background: transparent; border: 1px solid #3498db; color: #3498db; }

        /* NAV BAR */
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: white; display: flex; justify-content: space-around; padding: 10px 0; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); z-index: 1000; }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: #999; font-size: 0.7rem; cursor: pointer; }
        .nav-item.active { color: #764ba2; }
        .nav-item span { font-size: 1.4rem; margin-bottom: 2px; }

        /* MODAL */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; display: none; align-items: center; justify-content: center; }
        .modal-content { background: white; width: 90%; max-width: 400px; padding: 20px; border-radius: 15px; max-height: 80vh; overflow-y: auto; }
        
        /* Multi Select */
        .ms-area { border: 1px solid #ddd; padding: 10px; border-radius: 8px; max-height: 100px; overflow-y: auto; margin-bottom: 10px; }
        .ms-opt { display: flex; align-items: center; margin-bottom: 5px; } .ms-opt input { width: auto; margin-right: 10px; }
    </style>
</head>
<body>

<div id="login-screen">
    <div class="login-box">
        <h2>Ekip Takip</h2>
        <input type="email" id="lemail" placeholder="E-Posta">
        <input type="password" id="lpass" placeholder="≈ûifre">
        <button onclick="login()">Giri≈ü Yap</button>
        <p onclick="document.getElementById('reg-form').classList.toggle('hidden')" style="margin-top:15px; font-size:0.8rem; cursor:pointer; color:#764ba2;">Hesap Olu≈ütur</p>
        <div id="reg-form" class="hidden" style="margin-top:10px;">
            <input type="text" id="rname" placeholder="Ad Soyad">
            <input type="text" id="rtitle" placeholder="√únvan">
            <input type="email" id="remail" placeholder="E-Posta">
            <input type="password" id="rpass" placeholder="≈ûifre">
            <button onclick="register()">Kaydol</button>
        </div>
    </div>
</div>

<div id="app-screen" class="hidden">
    <div class="app-header">
        <h2 style="margin:0;" id="userDisplay">Kullanƒ±cƒ±</h2>
        <div>
            <button class="icon-btn" onclick="requestPerm()">üîî</button>
            <button class="icon-btn" onclick="logout()">üö™</button>
        </div>
    </div>

    <div class="container">
        
        <div id="tab-calendar" class="view-section active">
            <div class="hero-card">
                <h3 id="todayLabel" style="margin:0;">Bug√ºn</h3>
                <div class="hero-stats">
                    <div class="stat-item"><span id="s-total">0</span>Ekip</div>
                    <div class="stat-item"><span id="s-active">0</span>Sahada</div>
                    <div class="stat-item"><span id="s-idle">0</span>Bo≈üta</div>
                </div>
            </div>
            <div class="card">
                <div class="cal-nav">
                    <button class="icon-btn" onclick="moveMonth(-1)">‚óÄ</button>
                    <h3 id="monthLabel" style="margin:0;">Takvim</h3>
                    <button class="icon-btn" onclick="moveMonth(1)">‚ñ∂</button>
                </div>
                <div class="cal-grid" id="calGrid"></div>
            </div>
        </div>

        <div id="tab-projects" class="view-section">
            <div class="admin-only card">
                <h3>Yeni Proje</h3>
                <input type="text" id="p-name" placeholder="Proje Adƒ±">
                <select id="p-manager"></select>
                <div style="display:flex; gap:5px;"><input type="date" id="p-start"><input type="date" id="p-end"></div>
                <div style="display:flex; gap:5px;"><input type="number" id="p-cost" placeholder="Maliyet"><input type="number" id="p-offer" placeholder="Teklif"></div>
                <button class="btn btn-primary" onclick="addProject()">Kaydet</button>
            </div>
            <div class="card" id="projectList"></div>
        </div>

        <div id="tab-team" class="view-section">
            <div class="card" id="teamList"></div>
        </div>

        <div id="tab-devices" class="view-section">
            <div class="admin-only card">
                <h3>Yeni Cihaz</h3>
                <input type="text" id="d-name" placeholder="Cihaz Adƒ±">
                <input type="text" id="d-serial" placeholder="Seri No">
                <input type="date" id="d-calib">
                <button class="btn btn-primary" onclick="addDevice()">Ekle</button>
            </div>
            <div class="card" id="deviceList"></div>
        </div>

        <div id="tab-vehicles" class="view-section">
            <div class="admin-only card">
                <h3>Yeni Ara√ß</h3>
                <input type="text" id="v-plate" placeholder="Plaka">
                <input type="text" id="v-info" placeholder="Model">
                <input type="date" id="v-insp">
                <button class="btn btn-primary" onclick="addVehicle()">Ekle</button>
            </div>
            <div class="card" id="vehicleList"></div>
        </div>

        <div id="tab-users" class="view-section admin-only">
            <div class="card">
                <h3>Kullanƒ±cƒ± Ekle</h3>
                <input type="text" id="u-name" placeholder="Ad Soyad">
                <input type="text" id="u-title" placeholder="√únvan">
                <input type="email" id="u-email" placeholder="E-Posta">
                <select id="u-role"><option value="staff">Personel</option><option value="admin">Y√∂netici</option></select>
                <button class="btn btn-primary" onclick="addUser()">Ekle</button>
            </div>
            <div class="card" id="userList"></div>
        </div>

        <div id="tab-reports" class="view-section admin-only">
            <div class="card">
                <label>Rapor D√∂nemi:</label>
                <input type="month" id="r-date" onchange="renderLogs()">
                <h3>Zimmet Kayƒ±tlarƒ±</h3>
                <div id="logList" style="max-height:300px; overflow-y:auto; font-size:0.8rem;"></div>
            </div>
            <div class="card">
                <h3>Personel √áalƒ±≈üma G√ºnleri</h3>
                <div id="effortList"></div>
            </div>
        </div>

    </div>

    <div class="bottom-nav">
        <div class="nav-item active" onclick="goTab('calendar')"><span>üìÖ</span>Takvim</div>
        <div class="nav-item" onclick="goTab('projects')"><span>üìÇ</span>Proje</div>
        <div class="nav-item" onclick="goTab('team')"><span>üë•</span>Ekip</div>
        <div class="nav-item" onclick="goTab('vehicles')"><span>üöó</span>Ara√ß</div>
        <div class="nav-item" onclick="goTab('devices')"><span>üß∞</span>Cihaz</div>
        <div class="nav-item admin-only" onclick="goTab('users')"><span>‚öôÔ∏è</span>Yetki</div>
        <div class="nav-item admin-only" onclick="goTab('reports')"><span>üìä</span>Rapor</div>
    </div>
</div>

<div class="modal" id="taskModal">
    <div class="modal-content">
        <h3>G√∂revler</h3>
        <div id="taskList" style="margin-bottom:15px;"></div>
        <div class="admin-only">
            <hr>
            <h4>Yeni Atama</h4>
            <label>Personel</label><div class="ms-area" id="ms-person"></div>
            <label>Proje</label><select id="t-proj"></select>
            <input type="text" id="t-loc" placeholder="Konum">
            <label>Ara√ß</label><div class="ms-area" id="ms-plate"></div>
            <label>Cihaz</label><div class="ms-area" id="ms-device"></div>
            <button class="btn btn-primary" onclick="saveTask()">Kaydet</button>
        </div>
        <button class="btn" onclick="document.getElementById('taskModal').style.display='none'" style="margin-top:10px;">Kapat</button>
    </div>
</div>

<div class="modal" id="custodyModal">
    <div class="modal-content">
        <h3>Zimmet Ver</h3>
        <p id="custodyName"></p>
        <select id="c-person"></select>
        <button class="btn btn-primary" onclick="doCustody()">Kaydet</button>
        <button class="btn" onclick="document.getElementById('custodyModal').style.display='none'">ƒ∞ptal</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, deleteDoc, updateDoc, doc, onSnapshot, query, orderBy, setDoc, getDoc, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // --- SENƒ∞N ≈ûƒ∞FRELERƒ∞N (Gƒ∞Rƒ∞LMƒ∞≈û HALDE) ---
    const firebaseConfig = {
      apiKey: "AIzaSyD4XZR8JAMe-Qr2Oj2UGnp9mFc8En38gxY",
      authDomain: "ekiptakipapp.firebaseapp.com",
      projectId: "ekiptakipapp",
      storageBucket: "ekiptakipapp.firebasestorage.app",
      messagingSenderId: "55716082808",
      appId: "1:55716082808:web:b144b953684fc9f80c698d",
      measurementId: "G-S6Q0H5RHR7"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    window.OneSignalDeferred = window.OneSignalDeferred || [];
    OneSignalDeferred.push(function(OneSignal) {
        OneSignal.init({ appId: "08d90e98-c6b4-429c-aab5-f11164ddc881" });
    });

    let currentUser, userRole, projects=[], tasks=[], users=[], vehicles=[], devices=[], logs=[];
    let curDate = new Date(), selDate = new Date().toISOString().split('T')[0];
    let custodyId, custodyType;

    // AUTH
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            const docSnap = await getDoc(doc(db, "users", user.email));
            if (docSnap.exists()) {
                currentUser = docSnap.data(); userRole = currentUser.role;
                document.getElementById('welcomeUser').innerText = currentUser.name;
                document.querySelectorAll('.admin-only').forEach(e => e.style.display = userRole==='admin'?'block':'none');
                document.querySelectorAll('.nav-item.admin-only').forEach(e => e.style.display = userRole==='admin'?'flex':'none'); // Nav fix
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('app-screen').classList.remove('hidden');
                OneSignalDeferred.push(function(OneSignal) { OneSignal.login(user.email); });
                startData();
            } else {
                // ƒ∞lk kurulum i√ßin admin yap
                await setDoc(doc(db, "users", user.email), {name: "Y√∂netici", email: user.email, role: "admin"});
                window.location.reload();
            }
        } else {
            document.getElementById('login-screen').classList.remove('hidden');
            document.getElementById('app-screen').classList.add('hidden');
        }
    });

    window.login = () => signInWithEmailAndPassword(auth, document.getElementById('lemail').value, document.getElementById('lpass').value).catch(e=>alert(e.message));
    window.logout = () => signOut(auth).then(()=>window.location.reload());
    window.register = async () => {
        try {
            const em = document.getElementById('remail').value;
            await createUserWithEmailAndPassword(auth, em, document.getElementById('rpass').value);
            await setDoc(doc(db, "users", em), { 
                name: document.getElementById('rname').value, 
                title: document.getElementById('rtitle').value, 
                email: em, role: "admin" 
            });
        } catch(e) { alert(e.message); }
    }

    function startData() {
        const sub = (c, arr, r) => onSnapshot(collection(db, c), s => { arr.length=0; s.forEach(d=>arr.push({id:d.id,...d.data()})); r(); updateDrops(); });
        sub("projects", projects, renderProjects);
        sub("vehicles", vehicles, renderVehicles);
        sub("devices", devices, renderDevices);
        sub("users", users, renderUsers);
        onSnapshot(collection(db, "tasks"), s => { 
            tasks=[]; s.forEach(d=>tasks.push({id:d.id,...d.data()})); 
            renderCal(); renderTeam(); updateStats(); 
        });
        onSnapshot(query(collection(db, "logs"), orderBy("date", "desc"), limit(100)), s => {
            logs=[]; s.forEach(d=>logs.push(d.data())); renderLogs();
        });
    }

    // TABS
    window.goTab = (t) => {
        document.querySelectorAll('.view-section').forEach(e=>e.classList.remove('active'));
        document.getElementById('tab-'+t).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('active'));
        event.currentTarget.classList.add('active');
        if(t==='reports') renderLogs();
    }

    // CALENDAR
    window.moveMonth = (m) => { curDate.setMonth(curDate.getMonth()+m); renderCal(); }
    function renderCal() {
        const m = curDate.getMonth(), y = curDate.getFullYear();
        document.getElementById('monthLabel').innerText = `${m+1}/${y}`;
        const fd = new Date(y, m, 1).getDay(), days = new Date(y, m+1, 0).getDate();
        let h = "";
        for(let i=0; i<(fd===0?6:fd-1); i++) h+=`<div></div>`;
        for(let d=1; d<=days; d++) {
            const dk = `${d}-${m}-${y}`;
            const dt = tasks.filter(t=>t.date===dk);
            let dots = ""; dt.forEach(t=>{ if(Array.isArray(t.person)) t.person.forEach(p=>dots+=`<div class="dot"></div>`); else dots+=`<div class="dot"></div>`; });
            h += `<div class="day ${dk===selDate?'today':''}" onclick="openDay('${dk}')"><b>${d}</b>${dots}</div>`;
        }
        document.getElementById('calGrid').innerHTML = h;
    }
    window.openDay = (dk) => {
        selDate = dk;
        document.getElementById('taskModal').style.display = 'flex';
        const dt = tasks.filter(t=>t.date===dk);
        document.getElementById('taskList').innerHTML = dt.map(t=>`
            <div class="info-item">
                <div><strong>${Array.isArray(t.person)?t.person.join(', '):t.person}</strong><br>${t.projectName}</div>
                ${userRole==='admin'?`<button onclick="delTask('${t.id}')" style="color:red;border:none;">üóë</button>`:''}
            </div>`).join('') || 'Kayƒ±t yok';
    }

    // TASKS
    window.saveTask = async () => {
        const per = Array.from(document.querySelectorAll('#ms-person input:checked')).map(i=>i.value);
        const dev = Array.from(document.querySelectorAll('#ms-device input:checked')).map(i=>i.value);
        const plate = Array.from(document.querySelectorAll('#ms-plate input:checked')).map(i=>i.value);
        const pid = document.getElementById('t-proj').value;
        if(!pid || per.length===0) return alert("Se√ßim eksik");
        
        const pname = projects.find(p=>p.id===pid).name;
        // Zimmet Check
        let warn = "";
        dev.forEach(dn => {
            const d = devices.find(x=>x.name===dn);
            if(d && d.currentHolder && !per.includes(d.currentHolder)) warn += `${dn} cihazƒ± ${d.currentHolder}'de!\n`;
        });
        if(warn && !confirm(warn + "Yine de atansƒ±n mƒ±?")) return;

        await addDoc(collection(db, "tasks"), {
            date: selDate, person: per, projectName: pname, projectId: pid,
            location: document.getElementById('t-loc').value, device: dev, plate: plate
        });
        
        // Notify
        const emails = users.filter(u => per.includes(u.name)).map(u => u.email);
        if(emails.length>0) sendPush(emails, `${selDate}: ${pname} g√∂revi.`);
        
        document.getElementById('taskModal').style.display='none';
    }
    window.delTask = (id) => deleteDoc(doc(db,"tasks",id)).then(()=>document.getElementById('taskModal').style.display='none');

    // LISTS RENDERS
    function renderProjects() {
        document.getElementById('projectList').innerHTML = projects.map(p=>`
            <div class="info-item">
                <div><strong>${p.name}</strong><br><small>${p.start||'-'} / ${p.end||'-'}</small></div>
                <div style="text-align:right;">Kar: ${p.offer-p.cost}<br>${userRole==='admin'?`<button onclick="delItem('projects','${p.id}')" style="color:red;border:none;">üóë</button>`:''}</div>
            </div>`).join('');
    }
    function renderVehicles() {
        document.getElementById('vehicleList').innerHTML = vehicles.map(v=>`
            <div class="info-item">
                <div><strong>${v.plate}</strong> ${v.info}<br><small>Muayene: ${v.inspectionDate||'-'}</small></div>
                <div>${v.currentHolder ? `<span class="badge badge-orange">${v.currentHolder}</span>` : `<span class="badge badge-green">BO≈ûTA</span>`}
                ${userRole==='admin' ? (v.currentHolder ? `<button class="btn-sm btn-outline-red" onclick="dropItem('vehicles','${v.id}','${v.plate}')">ƒ∞ade</button>` : `<button class="btn-sm btn-outline-blue" onclick="openCustody('vehicle','${v.id}','${v.plate}')">Ver</button>`) : ''}
                ${userRole==='admin' ? `<button onclick="delItem('vehicles','${v.id}')" style="color:red;border:none;">üóë</button>` : ''}</div>
            </div>`).join('');
    }
    function renderDevices() {
        document.getElementById('deviceList').innerHTML = devices.map(d=>`
            <div class="info-item">
                <div><strong>${d.name}</strong> (${d.serial})<br><small>Kalibrasyon: ${d.calib||'-'}</small></div>
                <div>${d.currentHolder ? `<span class="badge badge-orange">${d.currentHolder}</span>` : `<span class="badge badge-green">BO≈ûTA</span>`}
                ${userRole==='admin' ? (d.currentHolder ? `<button class="btn-sm btn-outline-red" onclick="dropItem('devices','${d.id}','${d.name}')">ƒ∞ade</button>` : `<button class="btn-sm btn-outline-blue" onclick="openCustody('device','${d.id}','${d.name}')">Ver</button>`) : ''}
                ${userRole==='admin' ? `<button onclick="delItem('devices','${d.id}')" style="color:red;border:none;">üóë</button>` : ''}</div>
            </div>`).join('');
    }
    function renderTeam() {
        const today = getCurrentDateStr();
        const todayTasks = tasks.filter(t=>t.date===today);
        
        document.getElementById('teamList').innerHTML = users.map(u=>{
            // Bug√ºn var mƒ±?
            const at = todayTasks.find(t=>Array.isArray(t.person)?t.person.includes(u.name):t.person===u.name);
            // Gelecek
            const future = tasks.filter(t=> parseDate(t.date) > parseDate(today) && (Array.isArray(t.person)?t.person.includes(u.name):t.person===u.name)).sort((a,b)=>parseDate(a.date)-parseDate(b.date))[0];
            
            return `<div class="info-item">
                <div><strong>${u.name}</strong> <small>(${u.title||''})</small><br>
                ${future ? `<small style="color:orange">Sonraki: ${future.date} - ${future.projectName}</small>` : ''}
                </div>
                <span class="badge ${at?'badge-red':'badge-green'}">${at?'SAHADA':'BO≈ûTA'}</span>
            </div>`;
        }).join('');
    }
    function renderUsers() {
        document.getElementById('userList').innerHTML = users.map(u=>`
            <div class="info-item">
                <div><strong>${u.name}</strong><br><small>${u.email}</small></div>
                <div><span class="badge badge-gray">${u.role}</span> ${userRole==='admin'?`<button onclick="delItem('users','${u.email}')" style="color:red;border:none;">üóë</button>`:''}</div>
            </div>`).join('');
    }

    // ZIMMET
    window.openCustody = (type, id, name) => { custodyType=type; custodyId=id; document.getElementById('custodyName').innerText=name; document.getElementById('custodyModal').style.display='flex'; }
    window.doCustody = async () => {
        const p = document.getElementById('c-person').value;
        const col = custodyType==='vehicle'?'vehicles':'devices';
        await updateDoc(doc(db, col, custodyId), { currentHolder: p });
        await addLog(custodyType, document.getElementById('custodyName').innerText, 'take', p);
        document.getElementById('custodyModal').style.display='none';
    }
    window.dropItem = async (col, id, name) => {
        if(!confirm("ƒ∞ade alƒ±nsƒ±n mƒ±?")) return;
        await updateDoc(doc(db, col, id), { currentHolder: null });
        await addLog(col === 'vehicles' ? 'vehicle' : 'device', name, 'return', 'Admin');
    }

    // ADDERS
    window.addProject = () => addDoc(collection(db,"projects"),{name:document.getElementById('p-name').value, manager:document.getElementById('p-manager').value, start:document.getElementById('p-start').value, end:document.getElementById('p-end').value, cost:document.getElementById('p-cost').value, offer:document.getElementById('p-offer').value}).then(()=>document.getElementById('p-name').value="");
    window.addVehicle = () => addDoc(collection(db,"vehicles"),{plate:document.getElementById('v-plate').value, info:document.getElementById('v-info').value, inspectionDate:document.getElementById('v-insp').value, currentHolder:null}).then(()=>document.getElementById('v-plate').value="");
    window.addDevice = () => addDoc(collection(db,"devices"),{name:document.getElementById('d-name').value, serial:document.getElementById('d-serial').value, calib:document.getElementById('d-calib').value, currentHolder:null}).then(()=>document.getElementById('d-name').value="");
    window.addUser = () => setDoc(doc(db,"users",document.getElementById('u-email').value),{name:document.getElementById('u-name').value, title:document.getElementById('u-title').value, email:document.getElementById('u-email').value, role:document.getElementById('u-role').value}).then(()=>alert('Eklendi'));
    window.delItem = (c,id) => { if(confirm("Sil?")) deleteDoc(doc(db,c,id)); }

    // HELPERS
    function updateDrops() {
        const fill = (id,arr,k) => { if(document.getElementById(id)) document.getElementById(id).innerHTML=arr.map(i=>`<div class="ms-opt"><input type="checkbox" value="${i[k]}">${i[k]}</div>`).join(''); }
        const fillSel = (id,arr,k) => { if(document.getElementById(id)) document.getElementById(id).innerHTML=arr.map(i=>`<option>${i[k]}</option>`).join(''); }
        
        fillSel('p-manager', users, 'name');
        fillSel('c-person', users, 'name');
        fill('ms-person', users, 'name');
        fill('ms-plate', vehicles, 'plate');
        fill('ms-device', devices, 'name');
        
        if(document.getElementById('t-proj')) document.getElementById('t-proj').innerHTML = `<option value="">Se√ß</option>` + projects.map(p=>`<option value="${p.id}">${p.name}</option>`).join('');
    }
    function updateStats() {
        const today=getCurrentDateStr(), dt=tasks.filter(t=>t.date===today);
        let act=0; dt.forEach(t=>{ if(Array.isArray(t.person)) act+=t.person.length; else act++; });
        document.getElementById('s-total').innerText=users.length; document.getElementById('s-active').innerText=act; document.getElementById('s-idle').innerText=Math.max(0, users.length-act);
    }
    
    // RAPOR
    async function addLog(type, item, act, per) { await addDoc(collection(db,"logs"), {date:new Date().toISOString(), type, item, action:act, person:per}); }
    window.renderLogs = () => {
        const ym = document.getElementById('r-date').value; // YYYY-MM
        if(!ym) return;
        const fl = logs.filter(l=>l.date.startsWith(ym));
        document.getElementById('logList').innerHTML = fl.map(l=>`<div><small>${l.date.slice(0,16).replace('T',' ')}</small> <strong>${l.person}</strong> ${l.action==='take'?'Aldƒ±':'Verdi'}: ${l.item}</div>`).join('');
        
        // Efor
        const counts={}; users.forEach(u=>counts[u.name]=0);
        tasks.forEach(t=>{
             const tym = parseDate(t.date).toISOString().slice(0,7);
             if(tym===ym) {
                 if(Array.isArray(t.person)) t.person.forEach(p=>{if(counts[p]!==undefined)counts[p]++});
                 else if(counts[t.person]!==undefined) counts[t.person]++;
             }
        });
        document.getElementById('effortList').innerHTML = Object.keys(counts).map(k=>`<div>${k}: <strong>${counts[k]} G√ºn</strong></div>`).join('');
    }

    async function sendPush(emails, msg) {
        try { await fetch('https://onesignal.com/api/v1/notifications', {
            method:'POST', headers:{'Authorization':'Basic os_v2_app_bdmq5gggwrbjzkvv6eiwjxoiqfdusl6xjs3ej45uxfpqouat22pacfo2jydfmyjfy4yti7xbfsrpk24f6gbptzzfmayrp27sr72ulnq', 'content-type':'application/json'},
            body: JSON.stringify({app_id:"08d90e98-c6b4-429c-aab5-f11164ddc881", include_aliases:{"external_id":emails}, target_channel:"push", contents:{"en":msg}, headings:{"en":"Ekip Takip"}})
        }); } catch(e){}
    }

    function getCurrentDateStr() { const d=new Date(); return `${d.getDate()}-${d.getMonth()}-${d.getFullYear()}`; }
    function parseDate(s) { const p=s.split('-'); return new Date(p[2], p[1], p[0]); }
    window.requestNotificationPermission=()=>{Notification.requestPermission().then(p=>{if(p==='granted')alert('A√ßƒ±k')})};
</script>
</body>
</html>
