<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ekip Takip Pro (V29 - Modern UI)</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#6a11cb">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>

    <style>
        /* --- MODERN TEMA --- */
        :root {
            --primary-grad: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%); /* Canlƒ± Mor-Mavi */
            --secondary-grad: linear-gradient(to right, #fa709a 0%, #fee140 100%); /* Vurgu i√ßin Pembe-Sarƒ± */
            --bg-body: #f4f7fe; /* √áok a√ßƒ±k mavi-gri arka plan */
            --bg-card: #ffffff;
            --text-dark: #1b2559;
            --text-gray: #a3aed0;
            --shadow-sm: 0 2px 6px rgba(175, 184, 201, 0.2);
            --shadow-md: 0 8px 20px rgba(175, 184, 201, 0.15);
            --radius-xl: 24px;
            --radius-lg: 16px;
            --nav-height: 80px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Poppins', sans-serif; background: var(--bg-body); margin: 0; padding-bottom: var(--nav-height); color: var(--text-dark); }
        h1, h2, h3, h4, h5 { margin: 0; font-weight: 700; color: var(--text-dark); }
        small { color: var(--text-gray); font-weight: 500; }

        .hidden { display: none !important; } .admin-only { display: none; }
        .view-section { display: none; animation: fadeIn 0.4s ease-in-out; } .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .container { max-width: 900px; margin: 0 auto; padding: 20px; }

        /* LOGIN (Modernize Edildi) */
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--primary-grad); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 30px; }
        .login-box { background: var(--bg-card); padding: 40px 30px; border-radius: var(--radius-xl); width: 100%; max-width: 400px; text-align: center; box-shadow: 0 20px 40px rgba(0,0,0,0.2); }
        .login-box h2 { margin-bottom: 25px; background: var(--primary-grad); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        input, select { width: 100%; padding: 16px; margin: 10px 0; border: 2px solid transparent; background: #eff4fb; border-radius: var(--radius-lg); font-size: 15px; font-family: inherit; transition: 0.3s; outline: none; font-weight: 500; color: var(--text-dark); }
        input:focus, select:focus { border-color: #2575fc; background: #fff; box-shadow: 0 0 0 4px rgba(37, 117, 252, 0.1); }
        .btn { width: 100%; padding: 16px; background: var(--primary-grad); color: white; border: none; border-radius: var(--radius-lg); font-weight: 700; font-size: 16px; cursor: pointer; transition: 0.3s; box-shadow: 0 10px 20px -10px rgba(37, 117, 252, 0.5); }
        .btn:active { transform: scale(0.98); box-shadow: none; }
        
        /* APP HEADER (Yeni Tasarƒ±m) */
        .app-header { padding: 25px 20px; display: flex; justify-content: space-between; align-items: center; background: transparent; }
        .header-greet { font-size: 0.9rem; color: var(--text-gray); margin-bottom: 2px; font-weight: 500; }
        .header-title { font-size: 1.75rem; }
        .profile-icon { width: 50px; height: 50px; border-radius: 50%; background: var(--primary-grad); display: flex; align-items: center; justify-content: center; color: white; font-size: 1.5rem; font-weight: 700; box-shadow: var(--shadow-sm); cursor: pointer; }
        .header-actions { display: flex; gap: 10px; }
        .icon-btn { width: 45px; height: 45px; border-radius: var(--radius-lg); border: none; background: var(--bg-card); cursor: pointer; font-size: 1.3rem; color: var(--text-dark); box-shadow: var(--shadow-sm); display: flex; align-items: center; justify-content: center; transition: 0.3s; }
        .icon-btn:active { transform: scale(0.95); }

        /* CARDS (Modern Kartlar) */
        .card { background: var(--bg-card); border-radius: var(--radius-xl); padding: 25px; margin-bottom: 20px; box-shadow: var(--shadow-sm); transition: 0.3s; border: none; }
        .card:hover { box-shadow: var(--shadow-md); transform: translateY(-2px); }

        /* HERO CARD (√ñzet Alanƒ±) */
        .hero-card { background: var(--primary-grad); color: white; padding: 30px; position: relative; overflow: hidden; }
        .hero-card::before { content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 60%); pointer-events: none; }
        .hero-card h2 { color: white; margin-bottom: 15px; font-size: 1.5rem; }
        .hero-stats { display: flex; justify-content: space-between; text-align: center; margin-top: 20px; }
        .stat-item { flex: 1; }
        .stat-val { font-size: 2rem; font-weight: 700; display: block; margin-bottom: 5px; }
        .stat-label { font-size: 0.85rem; opacity: 0.8; font-weight: 500; }

        /* Lƒ∞STE KARTLARI (Projeler, Cihazlar vb.) */
        .list-card { display: flex; align-items: center; padding: 20px; background: var(--bg-card); border-radius: var(--radius-lg); margin-bottom: 15px; box-shadow: var(--shadow-sm); transition: 0.3s; position: relative; overflow: hidden; }
        .list-card:active { transform: scale(0.99); }
        .list-card::before { content: ''; position: absolute; left: 0; top: 0; height: 100%; width: 6px; background: #e0e0e0; }
        .list-card.active::before { background: #10b981; /* Ye≈üil */ }
        .list-card.busy::before { background: #ef4444; /* Kƒ±rmƒ±zƒ± */ }
        .list-card.custody::before { background: #f59e0b; /* Turuncu */ }
        
        .lc-icon { width: 50px; height: 50px; background: #eff4fb; border-radius: var(--radius-lg); display: flex; align-items: center; justify-content: center; font-size: 1.5rem; color: #2575fc; margin-right: 15px; flex-shrink: 0; }
        .lc-avatar { width: 50px; height: 50px; background: var(--primary-grad); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; color: white; font-weight: 700; margin-right: 15px; flex-shrink: 0; box-shadow: 0 4px 10px rgba(106, 17, 203, 0.3); }
        .lc-content { flex: 1; }
        .lc-title { font-weight: 700; font-size: 1.05rem; margin-bottom: 4px; display: block; }
        .lc-sub { font-size: 0.85rem; color: var(--text-gray); display: block; }
        .lc-action { margin-left: 15px; flex-shrink: 0; }

        /* BADGES & BUTTONS */
        .badge { padding: 6px 12px; border-radius: 30px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
        .bg-green { background: #d1fae5; color: #065f46; } .bg-red { background: #fee2e2; color: #991b1b; } 
        .bg-orange { background: #ffedd5; color: #9a3412; } .bg-gray { background: #f3f4f6; color: #374151; }
        .btn-sm { padding: 8px 14px; font-size: 0.8rem; border-radius: var(--radius-lg); border: none; cursor: pointer; font-weight: 600; transition: 0.3s; margin-left: 5px; }
        .btn-outline-red { background: #fee2e2; color: #ef4444; } .btn-outline-blue { background: #dbeafe; color: #2575fc; }
        .btn-sm:active { transform: scale(0.95); }

        /* CALENDAR */
        .cal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background: #eff4fb; padding: 10px; border-radius: 30px; }
        .cal-nav-btn { width: 40px; height: 40px; border-radius: 50%; background: var(--bg-card); border: none; font-size: 1.2rem; color: var(--text-dark); cursor: pointer; box-shadow: var(--shadow-sm); display: flex; align-items: center; justify-content: center; }
        .cal-title-box { text-align: center; position: relative; }
        #month-disp { font-size: 1.2rem; font-weight: 700; cursor: pointer; padding: 5px 15px; border-radius: 20px; transition: 0.3s; }
        #month-disp:hover { background: rgba(37, 117, 252, 0.1); color: #2575fc; }

        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 10px; }
        .day-head { text-align: center; font-size: 0.8rem; font-weight: 600; color: var(--text-gray); margin-bottom: 10px; }
        .day { background: var(--bg-card); min-height: 85px; border-radius: var(--radius-lg); padding: 6px; font-size: 0.85rem; cursor: pointer; display: flex; flex-direction: column; box-shadow: var(--shadow-sm); border: 2px solid transparent; transition: 0.3s; }
        .day:hover { transform: translateY(-3px); box-shadow: var(--shadow-md); }
        .day b { align-self: center; margin-bottom: 6px; font-weight: 700; }
        .day.today { border-color: #2575fc; background: #f0f7ff; }
        .task-dot { font-size: 0.65rem; background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%); color: white; padding: 3px 6px; margin-top: 3px; border-radius: 6px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-weight: 500; box-shadow: 0 2px 5px rgba(37, 117, 252, 0.3); }

        /* DATE PICKER */
        #month-picker { display: none; position: absolute; top: 50px; left: 50%; transform: translateX(-50%); background: var(--bg-card); padding: 20px; border-radius: var(--radius-xl); box-shadow: var(--shadow-md); z-index: 200; width: 280px; }
        .mp-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .mp-header button { background: #eff4fb; border: none; padding: 5px 10px; border-radius: 10px; cursor: pointer; }
        .mp-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .mp-btn { padding: 12px; background: #eff4fb; text-align: center; cursor: pointer; border-radius: var(--radius-lg); font-size: 0.9rem; font-weight: 600; transition: 0.3s; }
        .mp-btn:hover { background: #2575fc; color: white; }

        /* BOTTOM NAV (Modern) */
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: var(--bg-card); display: flex; justify-content: space-around; align-items: center; height: var(--nav-height); box-shadow: 0 -5px 20px rgba(175, 184, 201, 0.1); z-index: 1000; padding-bottom: 10px; border-radius: var(--radius-xl) var(--radius-xl) 0 0; }
        .nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--text-gray); font-size: 0.75rem; cursor: pointer; transition: 0.3s; position: relative; width: 60px; }
        .nav-icon-box { width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 12px; margin-bottom: 4px; transition: 0.3s; font-size: 1.4rem; }
        .nav-item.active .nav-icon-box { background: var(--primary-grad); color: white; box-shadow: 0 4px 10px rgba(106, 17, 203, 0.3); transform: translateY(-5px); }
        .nav-item.active { color: var(--text-dark); font-weight: 700; }
        
        /* MODAL */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(27, 37, 89, 0.6); z-index: 2000; display: none; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal-card { background: var(--bg-card); width: 90%; max-width: 450px; padding: 30px; border-radius: var(--radius-xl); max-height: 85vh; overflow-y: auto; box-shadow: var(--shadow-md); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-close { font-size: 1.8rem; cursor: pointer; color: var(--text-gray); }

        /* EXTRAS */
        .ms-area { border: 2px solid #eff4fb; padding: 15px; max-height: 150px; overflow-y: auto; border-radius: var(--radius-lg); margin-bottom: 15px; background: #eff4fb; }
        .ms-opt { display: flex; align-items: center; margin-bottom: 8px; font-weight: 500; } .ms-opt input { width: 20px; margin: 0 10px 0 0; box-shadow: none; }
        .log-table { width: 100%; font-size: 0.85rem; border-collapse: separate; border-spacing: 0 10px; }
        .log-table td { padding: 15px; background: var(--bg-card); first-child { border-radius: var(--radius-lg) 0 0 var(--radius-lg); } last-child { border-radius: 0 var(--radius-lg) var(--radius-lg) 0; } box-shadow: var(--shadow-sm); }
        hr { border: none; border-top: 2px solid #eff4fb; margin: 20px 0; }
    </style>
</head>
<body>

<div id="login-screen">
    <div class="login-box">
        <h2>Ho≈ü Geldiniz</h2>
        <input type="email" id="lemail" placeholder="E-Posta Adresiniz">
        <input type="password" id="lpass" placeholder="≈ûifreniz">
        <button class="btn" onclick="login()">Giri≈ü Yap</button>
        <p onclick="document.getElementById('reg-area').classList.toggle('hidden')" style="margin-top:20px; color: #2575fc; cursor:pointer; font-weight: 600;">Hesabƒ±nƒ±z yok mu? Kaydolun</p>
        <div id="reg-area" class="hidden">
            <input type="text" id="rname" placeholder="Ad Soyad">
            <input type="text" id="rtitle" placeholder="√únvan">
            <input type="email" id="remail" placeholder="E-Posta">
            <input type="password" id="rpass" placeholder="≈ûifre">
            <button class="btn" onclick="register()" style="background: var(--secondary-grad);">Kayƒ±t Ol</button>
        </div>
    </div>
</div>

<div id="app-screen" class="hidden">
    <div class="app-header">
        <div>
            <div class="header-greet" id="greet-msg">ƒ∞yi G√ºnler,</div>
            <h1 class="header-title" id="user-disp">Kullanƒ±cƒ±</h1>
        </div>
        <div style="display:flex; align-items:center; gap:15px;">
             <div class="header-actions">
                <button class="icon-btn" onclick="reqNotif()">üîî</button>
                <button class="icon-btn" onclick="logout()" style="color: #ef4444;">üö™</button>
            </div>
            <div class="profile-icon" id="profile-init">K</div>
        </div>
    </div>

    <div class="container">
        
        <div id="tab-cal" class="view-section active">
            <div class="card hero-card">
                <h2>Bug√ºn√ºn √ñzeti</h2>
                <div class="hero-stats">
                    <div class="stat-item"><span class="stat-val" id="s-total">0</span><span class="stat-label">Toplam Ekip</span></div>
                    <div class="stat-item"><span class="stat-val" id="s-active">0</span><span class="stat-label">Sahada Aktif</span></div>
                    <div class="stat-item"><span class="stat-val" id="s-idle">0</span><span class="stat-label">Ofiste/Bo≈üta</span></div>
                </div>
            </div>
            <div class="card">
                <div class="cal-header">
                    <button class="cal-nav-btn" onclick="moveMonth(-1)">‚óÄ</button>
                    <div class="cal-title-box">
                        <div id="month-disp" onclick="togglePicker()">Ay Y√ºkleniyor...</div>
                        <div id="month-picker">
                            <div class="mp-header">
                                <button onclick="pickerYear--;document.getElementById('p-year').innerText=pickerYear">‚óÄ</button>
                                <span id="p-year" style="font-weight:700; font-size:1.1rem;">2025</span>
                                <button onclick="pickerYear++;document.getElementById('p-year').innerText=pickerYear">‚ñ∂</button>
                            </div>
                            <div class="mp-grid">
                                <div class="mp-btn" onclick="setMonth(0)">Oca</div><div class="mp-btn" onclick="setMonth(1)">≈ûub</div><div class="mp-btn" onclick="setMonth(2)">Mar</div>
                                <div class="mp-btn" onclick="setMonth(3)">Nis</div><div class="mp-btn" onclick="setMonth(4)">May</div><div class="mp-btn" onclick="setMonth(5)">Haz</div>
                                <div class="mp-btn" onclick="setMonth(6)">Tem</div><div class="mp-btn" onclick="setMonth(7)">Aƒüu</div><div class="mp-btn" onclick="setMonth(8)">Eyl</div>
                                <div class="mp-btn" onclick="setMonth(9)">Eki</div><div class="mp-btn" onclick="setMonth(10)">Kas</div><div class="mp-btn" onclick="setMonth(11)">Ara</div>
                            </div>
                        </div>
                    </div>
                    <button class="cal-nav-btn" onclick="moveMonth(1)">‚ñ∂</button>
                </div>
                <div class="cal-grid-header" style="display:grid; grid-template-columns:repeat(7,1fr); margin-bottom:10px;">
                    <div class="day-head">Pt</div><div class="day-head">Sa</div><div class="day-head">√áa</div><div class="day-head">Pe</div><div class="day-head">Cu</div><div class="day-head">Ct</div><div class="day-head">Pz</div>
                </div>
                <div class="cal-grid" id="cal-grid"></div>
            </div>
        </div>

        <div id="tab-proj" class="view-section">
            <div class="admin-only card">
                <h3>Yeni Proje Olu≈ütur</h3>
                <input type="text" id="p-name" placeholder="Proje Adƒ±">
                <select id="p-man"><option>Y√∂netici Se√ßin</option></select>
                <div style="display:flex; gap:10px;"><div style="flex:1"><label><small>Ba≈ülangƒ±√ß</small></label><input type="date" id="p-start"></div><div style="flex:1"><label><small>Biti≈ü (Opsiyonel)</small></label><input type="date" id="p-end"></div></div>
                <div style="display:flex; gap:10px;"><input type="number" id="p-cost" placeholder="Maliyet (TL)"><input type="number" id="p-offer" placeholder="Teklif (TL)"></div>
                <button class="btn" onclick="addProj()">Projeyi Kaydet</button>
            </div>
            <div id="proj-list"></div>
        </div>

        <div id="tab-team" class="view-section">
            <div id="team-list"></div>
        </div>

        <div id="tab-dev" class="view-section">
            <div class="admin-only card">
                <h3>Yeni Cihaz Ekle</h3>
                <input type="text" id="d-name" placeholder="Cihaz Adƒ± / Marka Model">
                <input type="text" id="d-ser" placeholder="Seri Numarasƒ±">
                <label style="font-weight:500; margin-top:10px; display:block;">Kalibrasyon Tarihi:</label><input type="date" id="d-cal">
                <button class="btn" onclick="addDev()">Cihazƒ± Ekle</button>
            </div>
            <div id="dev-list"></div>
        </div>

        <div id="tab-veh" class="view-section">
            <div class="admin-only card">
                <h3>Yeni Ara√ß Ekle</h3>
                <input type="text" id="v-plate" placeholder="Plaka (√∂rn: 34 ABC 123)">
                <input type="text" id="v-info" placeholder="Marka Model">
                <label style="font-weight:500; margin-top:10px; display:block;">Muayene Tarihi:</label><input type="date" id="v-insp">
                <button class="btn" onclick="addVeh()">Aracƒ± Ekle</button>
            </div>
            <div id="veh-list"></div>
        </div>

        <div id="tab-user" class="view-section admin-only">
            <div class="card">
                <h3>Kullanƒ±cƒ± Y√∂netimi</h3>
                <input type="text" id="u-name" placeholder="Ad Soyad">
                <input type="text" id="u-title" placeholder="√únvan">
                <input type="email" id="u-email" placeholder="E-Posta Adresi">
                <select id="u-role"><option value="staff">Personel</option><option value="admin">Y√∂netici (Admin)</option></select>
                <div style="display:flex; gap:10px; margin-top:10px;">
                    <button class="btn" id="btn-u-add" onclick="addUser()">Kullanƒ±cƒ± Ekle</button>
                    <button class="btn" id="btn-u-upd" onclick="updUser()" style="display:none; background:var(--secondary-grad);">G√ºncelle</button>
                    <button class="btn" id="btn-u-can" onclick="canUser()" style="display:none; background:#a3aed0;">ƒ∞ptal</button>
                </div>
            </div>
            <div id="user-list"></div>
        </div>

        <div id="tab-rep" class="view-section admin-only">
            <div class="card">
                <label style="font-weight:700;">Rapor D√∂nemi Se√ßin:</label>
                <input type="month" id="r-date" onchange="renderRep()" style="margin-top:5px;">
            </div>
            <div class="card">
                <h3>Zimmet Hareketleri</h3>
                <div style="display:flex; gap:10px; margin:15px 0;">
                    <button class="btn-sm" style="background:var(--primary-grad); color:white;" onclick="repFilt='all';renderRep()">T√ºm√º</button>
                    <button class="btn-sm" onclick="repFilt='vehicle';renderRep()">Sadece Ara√ß</button>
                    <button class="btn-sm" onclick="repFilt='device';renderRep()">Sadece Cihaz</button>
                </div>
                <div id="log-list" style="max-height:350px; overflow-y:auto;"></div>
            </div>
            <div class="card">
                <h3>Personel √áalƒ±≈üma Eforu (G√ºn/Ay)</h3>
                <table class="log-table" id="eff-table"></table>
            </div>
        </div>

    </div>

    <div class="bottom-nav">
        <div class="nav-item active" onclick="goTab('cal')"><div class="nav-icon-box"><span>üìÖ</span></div>Takvim</div>
        <div class="nav-item" onclick="goTab('proj')"><div class="nav-icon-box"><span>üìÇ</span></div>Proje</div>
        <div class="nav-item" onclick="switchTab('team')"><div class="nav-icon-box"><span>üë•</span></div>Ekip</div>
        <div class="nav-item" onclick="goTab('veh')"><div class="nav-icon-box"><span>üöó</span></div>Ara√ß</div>
        <div class="nav-item" onclick="goTab('dev')"><div class="nav-icon-box"><span>üß∞</span></div>Cihaz</div>
        <div class="nav-item admin-only" onclick="goTab('user')"><div class="nav-icon-box"><span>‚öôÔ∏è</span></div>Yetki</div>
        <div class="nav-item admin-only" onclick="goTab('rep')"><div class="nav-icon-box"><span>üìä</span></div>Rapor</div>
    </div>
</div>

<div class="modal" id="taskModal">
    <div class="modal-card">
        <div class="modal-header"><h3>G√ºnl√ºk G√∂revler</h3><span class="modal-close" onclick="closeModal()">‚úï</span></div>
        <p id="tm-date" style="font-weight:600; color:var(--primary-grad); margin-bottom:15px;"></p>
        <div id="tm-list" style="margin-bottom:20px;"></div>
        <div class="admin-only">
            <hr>
            <h3>Yeni G√∂rev Ata</h3>
            <label style="font-weight:600; margin-top:10px; display:block;">Personel Se√ß:</label><div class="ms-area" id="ms-per"></div>
            <label style="font-weight:600; margin-top:10px; display:block;">Proje Se√ß:</label><select id="t-proj"><option value="">Proje Se√ßin</option></select>
            <input type="text" id="t-loc" placeholder="Konum / A√ßƒ±klama (Opsiyonel)">
            <label style="font-weight:600; margin-top:10px; display:block;">Ara√ß (Opsiyonel):</label><div class="ms-area" id="ms-veh"></div>
            <label style="font-weight:600; margin-top:10px; display:block;">Cihaz (Opsiyonel):</label><div class="ms-area" id="ms-dev"></div>
            <div id="conflict" style="color:#ef4444; font-weight:500; font-size:0.85rem; margin:10px 0;"></div>
            <button class="btn" onclick="saveTask()">G√∂revi Kaydet</button>
        </div>
    </div>
</div>

<div class="modal" id="custodyModal">
    <div class="modal-card">
        <div class="modal-header"><h3>Zimmetle</h3><span class="modal-close" onclick="document.getElementById('custodyModal').style.display='none'">‚úï</span></div>
        <p id="cm-name" style="font-weight:700; font-size:1.1rem; margin-bottom:20px;"></p>
        <label style="font-weight:600;">Personel Se√ß:</label>
        <select id="c-per" style="margin-top:5px;"><option>Personel Se√ßin</option></select>
        <div style="display:flex; gap:10px; margin-top:20px;">
            <button class="btn" onclick="doCustody()">Kaydet</button>
            <button class="btn" style="background:#a3aed0;" onclick="document.getElementById('custodyModal').style.display='none'">ƒ∞ptal</button>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, deleteDoc, updateDoc, doc, onSnapshot, query, orderBy, setDoc, getDoc, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // --- Gƒ∞ZLƒ∞ ≈ûƒ∞FRELER (DOKUNMA) ---
    const k1 = "AIzaSyD4XZR8JAMe-"; const k2 = "Qr2Oj2UGnp9mFc8En38gxY";
    const firebaseConfig = { apiKey: k1 + k2, authDomain: "ekiptakipapp.firebaseapp.com", projectId: "ekiptakipapp", storageBucket: "ekiptakipapp.firebasestorage.app", messagingSenderId: "55716082808", appId: "1:55716082808:web:b144b953684fc9f80c698d", measurementId: "G-S6Q0H5RHR7" };
    const app = initializeApp(firebaseConfig); const auth = getAuth(app); const db = getFirestore(app);

    const os_key_1 = "08d90e98-c6b4"; const os_key_2 = "-429c-aab5-f11164ddc881";
    window.OneSignalDeferred = window.OneSignalDeferred || [];
    OneSignalDeferred.push(function(OneSignal) { OneSignal.init({ appId: os_key_1 + os_key_2 }); });

    // VARS
    let users=[], projects=[], tasks=[], vehicles=[], devices=[], logs=[];
    let curUser, role='staff', curDate=new Date(), selDate, pickerYear=new Date().getFullYear();
    let custodyId, custodyType, editId, repFilt='all';

    // AUTH & INIT
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            const u = await getDoc(doc(db, "users", user.email));
            if (u.exists()) {
                curUser=u.data(); role=curUser.role;
                document.getElementById('user-disp').innerText = curUser.name;
                document.getElementById('profile-init').innerText = curUser.name.charAt(0).toUpperCase();
                setGreet();
                document.querySelectorAll('.admin-only').forEach(e=>e.style.display=(role==='admin'?'block':'none'));
                document.querySelectorAll('.nav-item.admin-only').forEach(e=>e.style.display=(role==='admin'?'flex':'none'));
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('app-screen').classList.remove('hidden');
                document.getElementById('r-date').value = new Date().toISOString().slice(0,7);
                OneSignalDeferred.push(function(OneSignal) { OneSignal.login(user.email); });
                startData();
            } else {
                await setDoc(doc(db,"users",user.email), {name:"Ad Soyad Girilmedi", email:user.email, role:"staff"});
                window.location.reload();
            }
        } else {
            document.getElementById('login-screen').classList.remove('hidden');
            document.getElementById('app-screen').classList.add('hidden');
        }
    });

    function setGreet() {
        const h = new Date().getHours();
        let msg = h < 12 ? "G√ºnaydƒ±n," : h < 18 ? "T√ºnaydƒ±n," : "ƒ∞yi Ak≈üamlar,";
        document.getElementById('greet-msg').innerText = msg;
    }

    window.login = () => signInWithEmailAndPassword(auth, document.getElementById('lemail').value, document.getElementById('lpass').value).catch(e=>alert("Hata: " + e.message));
    window.logout = () => signOut(auth).then(()=>window.location.reload());
    window.register = async () => {
        try {
            const em=document.getElementById('remail').value;
            await createUserWithEmailAndPassword(auth, em, document.getElementById('rpass').value);
            await setDoc(doc(db,"users",em), {name:document.getElementById('rname').value, title:document.getElementById('rtitle').value, email:em, role:'staff'});
            alert("Hesap olu≈üturuldu. Giri≈ü yapabilirsiniz."); document.getElementById('reg-area').classList.add('hidden');
        } catch(e){alert("Hata: " + e.message)}
    }
    window.reqNotif = () => OneSignalDeferred.push(async function(OneSignal) { await OneSignal.Notifications.requestPermission(); alert("Bildirim izni istendi."); });

    // DATA LOOP
    function startData() {
        const sub = (c, arr, r) => onSnapshot(collection(db, c), s => { arr.length=0; s.forEach(d=>arr.push({id:d.id,...d.data()})); r(); loadDrops(); });
        sub("users", users, renderUsers);
        sub("projects", projects, renderProj);
        sub("vehicles", vehicles, renderVeh);
        sub("devices", devices, renderDev);
        
        onSnapshot(collection(db, "tasks"), s => { 
            tasks=[]; s.forEach(d=>tasks.push({id:d.id,...d.data()})); 
            renderCal(); renderTeam(); updateStats(); renderRep();
        });
        onSnapshot(query(collection(db, "logs"), orderBy("date", "desc"), limit(100)), s => { logs=[]; s.forEach(d=>logs.push(d.data())); renderRep(); });
    }

    // TABS
    window.goTab = (t) => {
        document.querySelectorAll('.view-section').forEach(e=>e.classList.remove('active'));
        document.getElementById('tab-'+t).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('active'));
        event.currentTarget.classList.add('active');
    }
    window.switchTab = window.goTab; 

    // CALENDAR
    window.moveMonth = (m) => { curDate.setMonth(curDate.getMonth()+m); renderCal(); }
    window.togglePicker = () => { document.getElementById('month-picker').style.display = document.getElementById('month-picker').style.display==='block'?'none':'block'; }
    window.setMonth = (m) => { curDate.setMonth(m); curDate.setFullYear(pickerYear); renderCal(); document.getElementById('month-picker').style.display='none'; }
    
    function renderCal() {
        const m=curDate.getMonth(), y=curDate.getFullYear();
        const monthNames = ["Ocak", "≈ûubat", "Mart", "Nisan", "Mayƒ±s", "Haziran", "Temmuz", "Aƒüustos", "Eyl√ºl", "Ekim", "Kasƒ±m", "Aralƒ±k"];
        document.getElementById('month-disp').innerText = `${monthNames[m]} ${y}`;
        const first=new Date(y,m,1).getDay(), days=new Date(y,m+1,0).getDate();
        let h=""; for(let i=0; i<(first===0?6:first-1); i++) h+=`<div></div>`;
        const today = new Date().toISOString().split('T')[0];
        for(let d=1; d<=days; d++) {
            const dk = `${d}-${m}-${y}`;
            const dt = tasks.filter(t=>t.date===dk);
            let dots=""; dt.forEach(t=>{ if(Array.isArray(t.person)) t.person.forEach(p=>dots+=`<span class="task-dot">${p.split(' ')[0]}</span>`); else dots+=`<span class="task-dot">${t.person.split(' ')[0]}</span>`; });
            h+=`<div class="day ${dk===today?'today':''}" onclick="openDay('${dk}')"><b>${d}</b>${dots}</div>`;
        }
        document.getElementById('cal-grid').innerHTML = h;
    }
    window.openDay = (dk) => {
        selDate=dk; document.getElementById('tm-date').innerText = `üìÖ Tarih: ${dk}`;
        const dt=tasks.filter(t=>t.date===dk);
        document.getElementById('tm-list').innerHTML = dt.map(t=>`
            <div class="list-card" style="padding:15px; background:#f0f7ff; border-left:4px solid #2575fc;">
                <div class="lc-content">
                    <span class="lc-title" style="font-size:1rem;">${Array.isArray(t.person)?t.person.join(', '):t.person}</span>
                    <span class="lc-sub">üìç ${t.projectName} ${t.location?'('+t.location+')':''}</span>
                    ${t.plate && t.plate.length > 0 ? `<span class="lc-sub">üöó ${t.plate.join(', ')}</span>` : ''}
                    ${t.device && t.device.length > 0 ? `<span class="lc-sub">üß∞ ${t.device.join(', ')}</span>` : ''}
                </div>
                ${role==='admin'?`<div class="lc-action"><button onclick="delTask('${t.id}')" class="icon-btn" style="color:#ef4444; background:white;">üóë</button></div>`:''}
            </div>`).join('') || '<p style="text-align:center; color:#a3aed0;">Bu tarihte kayƒ±tlƒ± g√∂rev yok.</p>';
        document.getElementById('taskModal').style.display='flex';
    }
    window.closeModal = () => document.getElementById('taskModal').style.display='none';

    // TASKS & NOTIFICATION
    window.saveTask = async () => {
        const per = getMulti('ms-per'), dev = getMulti('ms-dev'), veh = getMulti('ms-veh');
        const pid = document.getElementById('t-proj').value;
        if(!pid || per.length===0) return alert("L√ºtfen proje ve en az bir personel se√ßin.");
        
        // Conflict
        let warn=""; dev.forEach(n=>{ const d=devices.find(x=>x.name===n); if(d&&d.currentHolder&&!per.includes(d.currentHolder)) warn+=`‚ö†Ô∏è ${n} cihazƒ± ≈üu an ${d.currentHolder} zimmetinde!\n`; });
        if(warn && !confirm(warn+"\nYine de bu g√∂reve atansƒ±n mƒ±?")) return;

        const pname = projects.find(p=>p.id===pid).name;
        await addDoc(collection(db,"tasks"), { date:selDate, person:per, projectName:pname, projectId:pid, location:document.getElementById('t-loc').value, device:dev, plate:veh });
        
        // Notify
        const emails = users.filter(u => per.includes(u.name)).map(u => u.email);
        if(emails.length>0) sendPush(emails, `üìÖ Yeni G√∂rev: ${selDate}\nüìç Proje: ${pname}`);
        
        closeModal();
        document.querySelectorAll('.multi-select-area input').forEach(c=>c.checked=false); document.getElementById('t-loc').value="";
    }
    window.delTask = (id) => { if(confirm("G√∂revi silmek istediƒüinize emin misiniz?")) deleteDoc(doc(db,"tasks",id)).then(()=>closeModal()); }

    async function sendPush(emails, msg) {
        const k1 = "os_v2_app_bdmq5gggwrbjzkvv6eiwjxoiqh5q6foeed5uwdnuxioe7pi"; const k2 = "yndd5zus3d632jsuuwtik6x4npdfvrl2k3lmolhffex6ndislurwmnma";
        try { await fetch('https://onesignal.com/api/v1/notifications', {
            method:'POST', headers:{'Authorization':'Basic ' + k1 + k2, 'content-type':'application/json'},
            body: JSON.stringify({app_id: os_key_1 + os_key_2, include_aliases:{"external_id":emails}, target_channel:"push", contents:{"en":msg}, headings:{"en":"Ekip Takip Bildirimi üöÄ"}})
        }); } catch(e){ console.error("Push Hatasƒ±:", e); }
    }

    // CRUD
    window.addProj = () => addDoc(collection(db,"projects"),{name:document.getElementById('p-name').value, manager:document.getElementById('p-man').value, start:document.getElementById('p-start').value, end:document.getElementById('p-end').value, cost:document.getElementById('p-cost').value, offer:document.getElementById('p-offer').value}).then(()=>{alert("Proje eklendi."); document.getElementById('p-name').value="";});
    window.delItem = (c,id) => { if(confirm("Bu kaydƒ± silmek istediƒüinize emin misiniz?")) deleteDoc(doc(db,c,id)); }
    
    window.addVeh = () => addDoc(collection(db,"vehicles"),{plate:document.getElementById('v-plate').value, info:document.getElementById('v-info').value, inspectionDate:document.getElementById('v-insp').value, currentHolder:null}).then(()=>{alert("Ara√ß eklendi."); document.getElementById('v-plate').value="";});
    window.addDev = () => addDoc(collection(db,"devices"),{name:document.getElementById('d-name').value, serial:document.getElementById('d-ser').value, calib:document.getElementById('d-cal').value, currentHolder:null}).then(()=>{alert("Cihaz eklendi."); document.getElementById('d-name').value="";});
    
    window.addUser = () => setDoc(doc(db,"users",document.getElementById('u-email').value),{name:document.getElementById('u-name').value, title:document.getElementById('u-title').value, email:document.getElementById('u-email').value, role:document.getElementById('u-role').value}).then(()=>{alert("Kullanƒ±cƒ± eklendi."); canUser();});
    window.editUser = (e) => {
        const u = users.find(x=>x.email===e);
        document.getElementById('u-name').value=u.name; document.getElementById('u-title').value=u.title; document.getElementById('u-email').value=u.email; document.getElementById('u-role').value=u.role;
        editId=e; document.getElementById('btn-u-add').style.display='none'; document.getElementById('btn-u-upd').style.display='inline'; document.getElementById('btn-u-can').style.display='inline';
    }
    window.updUser = async () => { await updateDoc(doc(db,"users",editId),{name:document.getElementById('u-name').value, title:document.getElementById('u-title').value, role:document.getElementById('u-role').value}); alert("Kullanƒ±cƒ± g√ºncellendi."); canUser(); }
    window.canUser = () => { editId=null; document.getElementById('u-name').value=""; document.getElementById('u-title').value=""; document.getElementById('u-email').value=""; document.getElementById('btn-u-add').style.display='inline'; document.getElementById('btn-u-upd').style.display='none'; document.getElementById('btn-u-can').style.display='none'; }

    // ZIMMET
    window.openCustody = (type, id, name) => { custodyType=type; custodyId=id; document.getElementById('cm-name').innerText=name; document.getElementById('custodyModal').style.display='flex'; }
    window.doCustody = async () => {
        const p = document.getElementById('c-per').value;
        if(!p || p==='Personel Se√ßin') return alert("L√ºtfen personel se√ßin.");
        const col = custodyType==='vehicle'?'vehicles':'devices';
        await updateDoc(doc(db, col, custodyId), { currentHolder: p });
        await addLog(custodyType, document.getElementById('cm-name').innerText, 'take', p);
        document.getElementById('custodyModal').style.display='none';
    }
    window.dropItem = async (col, id, name) => {
        if(confirm(`${name} iade alƒ±nsƒ±n mƒ±?`)) {
            await updateDoc(doc(db, col, id), { currentHolder: null });
            await addLog(col==='vehicles'?'vehicle':'device', name, 'return', curUser.name);
        }
    }

    // RENDERS (Modern Kartlar)
    function renderProj() { document.getElementById('proj-list').innerHTML=projects.map(p=>{
        return `<div class="list-card">
            <div class="lc-icon">üìÇ</div>
            <div class="lc-content">
                <span class="lc-title">${p.name}</span>
                <span class="lc-sub">Y√∂netici: ${p.manager || '-'} | Ba≈ülangƒ±√ß: ${p.start ? p.start.split('-').reverse().join('.') : '-'}</span>
            </div>
            ${role==='admin'?`<div class="lc-action"><button onclick="delItem('projects','${p.id}')" class="icon-btn" style="color:#ef4444; background:#fee2e2;">üóë</button></div>`:''}
        </div>`;
    }).join(''); }

    function renderVeh() { document.getElementById('veh-list').innerHTML=vehicles.map(v=>{
        const statusClass = v.currentHolder ? 'custody' : 'active';
        const statusBadge = v.currentHolder ? `<span class="badge bg-orange">üë§ ${v.currentHolder}</span>` : `<span class="badge bg-green">BO≈ûTA</span>`;
        return `<div class="list-card ${statusClass}">
            <div class="lc-icon" style="color:#f59e0b;">üöó</div>
            <div class="lc-content">
                <span class="lc-title">${v.plate}</span>
                <span class="lc-sub">${v.info} | Muayene: ${v.inspectionDate ? v.inspectionDate.split('-').reverse().join('.') : '-'}</span>
                <div style="margin-top:5px;">${statusBadge}</div>
            </div>
            <div class="lc-action" style="display:flex; flex-direction:column; gap:5px;">
                ${role==='admin' ? (v.currentHolder ? `<button class="btn-sm btn-outline-red" onclick="dropItem('vehicles','${v.id}','${v.plate}')">ƒ∞ade Al</button>` : `<button class="btn-sm btn-outline-blue" onclick="openCustody('vehicle','${v.id}','${v.plate}')">Zimmetle</button>`) : ''}
                ${role==='admin'?`<button onclick="delItem('vehicles','${v.id}')" class="icon-btn" style="color:#ef4444; background:#fee2e2; width:35px; height:35px; align-self:flex-end;">üóë</button>`:''}
            </div>
        </div>`;
    }).join(''); }

    function renderDev() { document.getElementById('dev-list').innerHTML=devices.map(d=>{
        const statusClass = d.currentHolder ? 'custody' : 'active';
        const statusBadge = d.currentHolder ? `<span class="badge bg-orange">üë§ ${d.currentHolder}</span>` : `<span class="badge bg-green">BO≈ûTA</span>`;
        return `<div class="list-card ${statusClass}">
            <div class="lc-icon" style="color:#8b5cf6;">üß∞</div>
            <div class="lc-content">
                <span class="lc-title">${d.name}</span>
                <span class="lc-sub">S.N: ${d.serial} | Kalib.: ${d.calib ? d.calib.split('-').reverse().join('.') : '-'}</span>
                <div style="margin-top:5px;">${statusBadge}</div>
            </div>
            <div class="lc-action" style="display:flex; flex-direction:column; gap:5px;">
                ${role==='admin' ? (d.currentHolder ? `<button class="btn-sm btn-outline-red" onclick="dropItem('devices','${d.id}','${d.name}')">ƒ∞ade Al</button>` : `<button class="btn-sm btn-outline-blue" onclick="openCustody('device','${d.id}','${d.name}')">Zimmetle</button>`) : ''}
                ${role==='admin'?`<button onclick="delItem('devices','${d.id}')" class="icon-btn" style="color:#ef4444; background:#fee2e2; width:35px; height:35px; align-self:flex-end;">üóë</button>`:''}
            </div>
        </div>`;
    }).join(''); }

    function renderUsers() { document.getElementById('user-list').innerHTML=users.map(u=>{
        return `<div class="list-card">
            <div class="lc-avatar">${u.name.charAt(0)}</div>
            <div class="lc-content">
                <span class="lc-title">${u.name}</span>
                <span class="lc-sub">${u.title || '-'} | ${u.email}</span>
                <span class="badge bg-gray" style="margin-top:5px; display:inline-block;">${u.role==='admin'?'Y√∂netici':'Personel'}</span>
            </div>
            ${role==='admin'?`<div class="lc-action" style="display:flex; gap:5px;"><button onclick="editUser('${u.email}')" class="icon-btn">‚úé</button><button onclick="delItem('users','${u.email}')" class="icon-btn" style="color:#ef4444; background:#fee2e2;">üóë</button></div>`:''}
        </div>`;
    }).join(''); }
    
    function renderTeam() {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('team-list').innerHTML=users.map(u=>{
            const at = tasks.find(t=>t.date===today && (Array.isArray(t.person)?t.person.includes(u.name):t.person===u.name));
            const statusBadge = at ? `<span class="badge bg-red">SAHADA: ${at.projectName}</span>` : `<span class="badge bg-green">OFƒ∞STE / BO≈ûTA</span>`;
            const statusClass = at ? 'busy' : 'active';
            return `<div class="list-card ${statusClass}">
                <div class="lc-avatar">${u.name.charAt(0)}</div>
                <div class="lc-content">
                    <span class="lc-title">${u.name}</span>
                    <span class="lc-sub">${u.title||'-'}</span>
                    <div style="margin-top:5px;">${statusBadge}</div>
                </div>
            </div>`;
        }).join('');
    }

    function updateStats() {
        const today = new Date().toISOString().split('T')[0];
        const dt = tasks.filter(t=>t.date===today);
        let act=new Set(); dt.forEach(t=>{ if(Array.isArray(t.person)) t.person.forEach(p=>act.add(p)); else act.add(t.person); });
        document.getElementById('s-total').innerText=users.length; document.getElementById('s-active').innerText=act.size; document.getElementById('s-idle').innerText=Math.max(0, users.length-act.size);
    }

    async function addLog(type, item, act, per) { await addDoc(collection(db,"logs"), {date:new Date().toISOString(), type, item, action:act, person:per, admin:curUser.name}); }
    window.renderRep = () => {
        const ym = document.getElementById('r-date').value; if(!ym) return;
        const fl = logs.filter(l=>l.date.startsWith(ym) && (repFilt==='all' || l.type===repFilt));
        document.getElementById('log-list').innerHTML = fl.map(l=>{
            const d = new Date(l.date); const dStr = `${d.getDate()}.${d.getMonth()+1} ${d.getHours()}:${d.getMinutes().toString().padStart(2,'0')}`;
            const icon = l.type==='vehicle'?'üöó':'üß∞'; const actText = l.action==='take'?'<span style="color:#f59e0b; font-weight:600;">Teslim Aldƒ±</span>':'<span style="color:#10b981; font-weight:600;">ƒ∞ade Etti</span>';
            return `<div class="list-card" style="padding:10px;"><div class="lc-icon" style="font-size:1.2rem; width:40px; height:40px;">${icon}</div><div class="lc-content"><span class="lc-title" style="font-size:0.9rem;">${l.person}</span><span class="lc-sub">${l.item} - ${actText}</span><span class="lc-sub" style="font-size:0.75rem;">${dStr} (ƒ∞≈ülem: ${l.admin})</span></div></div>`;
        }).join('') || '<p style="text-align:center; color:#a3aed0;">Kayƒ±t bulunamadƒ±.</p>';
        
        const cnt={}; users.forEach(u=>cnt[u.name]=0);
        tasks.forEach(t=>{ if(t.date.startsWith(ym.split('-')[1])) { if(Array.isArray(t.person)) t.person.forEach(p=>{if(cnt[p]!==undefined)cnt[p]++}); else if(cnt[t.person]!==undefined)cnt[t.person]++; } });
        document.getElementById('eff-table').innerHTML = Object.keys(cnt).map(k=>`<tr><td style="font-weight:600;">${k}</td><td style="text-align:right; color:#2575fc; font-weight:700;">${cnt[k]} G√ºn</td></tr>`).join('');
    }

    function loadDrops() {
        const sel = (id,arr) => { if(document.getElementById(id)) document.getElementById(id).innerHTML='<option value="">Se√ßiniz</option>'+arr.map(x=>`<option>${x.name}</option>`).join(''); }
        const ms = (id,arr,k) => { if(document.getElementById(id)) document.getElementById(id).innerHTML=arr.map(x=>`<div class="ms-opt"><input type="checkbox" value="${x[k]}"> ${x[k]}</div>`).join(''); }
        sel('p-man', users); sel('c-per', users);
        ms('ms-per', users, 'name'); ms('ms-veh', vehicles, 'plate'); ms('ms-dev', devices, 'name');
        if(document.getElementById('t-proj')) document.getElementById('t-proj').innerHTML=`<option value="">Proje Se√ßin</option>`+projects.map(p=>`<option value="${p.id}">${p.name}</option>`).join('');
    }
    function getMulti(id){return Array.from(document.querySelectorAll(`#${id} input:checked`)).map(i=>i.value);}
</script>
</body>
</html>
