<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ekip Takip (Stabil S√ºr√ºm)</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2c3e50">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>

    <style>
        :root { --primary: #2c3e50; --accent: #3498db; --bg: #f4f7f6; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Poppins', sans-serif; background: var(--bg); margin: 0; padding-bottom: 90px; color: #333; }

        /* Gƒ∞Rƒ∞≈û */
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--primary); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
        .login-box { background: white; padding: 30px; border-radius: 15px; width: 100%; max-width: 350px; text-align: center; }
        input, select { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; }
        .btn { width: 100%; padding: 12px; background: var(--accent); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 5px; }
        .hidden { display: none !important; }
        .admin-only { display: none; }

        /* NAV */
        .app-header { padding: 15px; background: white; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: white; display: flex; justify-content: space-around; padding: 10px 0; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); z-index: 1000; overflow-x: auto; }
        .nav-item { display: flex; flex-direction: column; align-items: center; min-width: 60px; font-size: 0.7rem; color: #999; cursor: pointer; }
        .nav-item.active { color: var(--accent); font-weight: bold; }
        .nav-item span { font-size: 1.4rem; margin-bottom: 2px; }

        /* CONTAINER */
        .container { max-width: 800px; margin: 15px auto; padding: 0 15px; }
        .view-section { display: none; } .view-section.active { display: block; }
        .card { background: white; padding: 15px; border-radius: 12px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border-left: 5px solid #ccc; }
        .card.active { border-left-color: #27ae60; } .card.busy { border-left-color: #e74c3c; } .card.custody { border-left-color: #f39c12; }

        /* TAKVƒ∞M */
        .cal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; }
        .day { background: white; min-height: 80px; border-radius: 8px; padding: 5px; font-size: 0.8rem; border: 1px solid #eee; cursor: pointer; display: flex; flex-direction: column; }
        .day.today { border-color: var(--accent); font-weight: bold; }
        .task-dot { font-size: 0.6rem; background: #e3f2fd; color: #1565c0; padding: 2px 4px; margin-top: 2px; border-radius: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* MODAL */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; display: none; justify-content: center; align-items: center; }
        .modal-content { background: white; width: 90%; max-width: 400px; padding: 20px; border-radius: 15px; max-height: 85vh; overflow-y: auto; }
        
        /* MULTI SELECT */
        .ms-area { border: 1px solid #ddd; padding: 10px; max-height: 120px; overflow-y: auto; border-radius: 8px; margin-bottom: 10px; }
        .ms-item { display: flex; align-items: center; margin-bottom: 5px; } .ms-item input { width: auto; margin-right: 10px; }
        
        /* K√ú√á√úK BUTONLAR */
        .btn-sm { padding: 5px 10px; font-size: 0.8rem; width: auto; display: inline-block; margin-left: 5px; }
        .btn-red { background: #e74c3c; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .btn-blue { background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer; }
    </style>
</head>
<body>

<div id="login-screen">
    <div class="login-box">
        <h2>Ekip Takip</h2>
        <input type="email" id="lemail" placeholder="E-Posta">
        <input type="password" id="lpass" placeholder="≈ûifre">
        <button onclick="login()">Giri≈ü Yap</button>
        <p onclick="document.getElementById('reg-area').style.display='block'" style="margin-top:15px; color:#3498db; cursor:pointer;">Hesap Olu≈ütur</p>
        <div id="reg-area" style="display:none;">
            <input type="text" id="rname" placeholder="Ad Soyad">
            <input type="text" id="rtitle" placeholder="√únvan">
            <input type="email" id="remail" placeholder="E-Posta">
            <input type="password" id="rpass" placeholder="≈ûifre">
            <button onclick="register()">Kaydol</button>
        </div>
    </div>
</div>

<div id="app-screen" class="hidden">
    <div class="app-header">
        <h3 style="margin:0;" id="user-name">Kullanƒ±cƒ±</h3>
        <div>
            <button class="btn-sm btn-blue" onclick="reqPerm()">üîî</button>
            <button class="btn-sm btn-red" onclick="logout()">√áƒ±kƒ±≈ü</button>
        </div>
    </div>

    <div class="container">
        
        <div id="tab-cal" class="view-section active">
            <div class="cal-header">
                <button class="btn-sm btn-blue" onclick="moveMonth(-1)">‚óÄ</button>
                <h3 style="margin:0;" id="month-display">Ay</h3>
                <button class="btn-sm btn-blue" onclick="moveMonth(1)">‚ñ∂</button>
            </div>
            <div class="cal-grid" id="cal-grid"></div>
        </div>

        <div id="tab-proj" class="view-section">
            <div class="admin-only card">
                <h3>Yeni Proje</h3>
                <input type="text" id="p-name" placeholder="Ad">
                <select id="p-man"></select>
                <div style="display:flex; gap:5px;"><input type="date" id="p-start"><input type="date" id="p-end"></div>
                <div style="display:flex; gap:5px;"><input type="number" id="p-cost" placeholder="Maliyet"><input type="number" id="p-offer" placeholder="Teklif"></div>
                <button class="btn" onclick="addProj()">Kaydet</button>
            </div>
            <div id="proj-list"></div>
        </div>

        <div id="tab-team" class="view-section">
            <div id="team-list"></div>
        </div>

        <div id="tab-veh" class="view-section">
            <div class="admin-only card">
                <h3>Yeni Ara√ß</h3>
                <input type="text" id="v-plate" placeholder="Plaka">
                <input type="text" id="v-info" placeholder="Model">
                <label>Muayene:</label><input type="date" id="v-insp">
                <button class="btn" onclick="addVeh()">Ekle</button>
            </div>
            <div id="veh-list"></div>
        </div>

        <div id="tab-dev" class="view-section">
            <div class="admin-only card">
                <h3>Yeni Cihaz</h3>
                <input type="text" id="d-name" placeholder="Ad">
                <input type="text" id="d-ser" placeholder="Seri No">
                <label>Kalibrasyon:</label><input type="date" id="d-cal">
                <button class="btn" onclick="addDev()">Ekle</button>
            </div>
            <div id="dev-list"></div>
        </div>

        <div id="tab-users" class="view-section admin-only">
            <div class="card">
                <h3>Kullanƒ±cƒ± Ekle</h3>
                <input type="text" id="u-name" placeholder="Ad">
                <input type="text" id="u-title" placeholder="√únvan">
                <input type="email" id="u-email" placeholder="E-Posta">
                <select id="u-role"><option value="staff">Personel</option><option value="admin">Y√∂netici</option></select>
                <button class="btn" onclick="addUser()">Ekle</button>
            </div>
            <div id="user-list"></div>
        </div>
        
         <div id="tab-rep" class="view-section admin-only">
             <div class="card">
                <label>Ay Se√ß:</label><input type="month" id="r-date" onchange="renderRep()">
             </div>
             <div class="card">
                 <h4>Zimmet Ge√ßmi≈üi</h4>
                 <div id="log-list" style="max-height:200px; overflow-y:auto; font-size:0.8rem;"></div>
             </div>
             <div class="card">
                 <h4>Personel Eforu</h4>
                 <div id="eff-list"></div>
             </div>
        </div>
    </div>

    <div class="bottom-nav">
        <div class="nav-item active" onclick="goTab('cal')"><span>üìÖ</span>Takvim</div>
        <div class="nav-item" onclick="goTab('proj')"><span>üìÇ</span>Proje</div>
        <div class="nav-item" onclick="switchTab('team')"><span>üë•</span>Ekip</div>
        <div class="nav-item" onclick="goTab('veh')"><span>üöó</span>Ara√ß</div>
        <div class="nav-item" onclick="goTab('dev')"><span>üß∞</span>Cihaz</div>
        <div class="nav-item admin-only" onclick="goTab('users')"><span>‚öôÔ∏è</span>Yetki</div>
        <div class="nav-item admin-only" onclick="goTab('rep')"><span>üìä</span>Rapor</div>
    </div>
</div>

<div class="modal" id="taskModal">
    <div class="modal-content">
        <div style="display:flex; justify-content:space-between;"><h3>G√∂revler</h3><span onclick="document.getElementById('taskModal').style.display='none'" style="font-size:1.5rem;">‚úï</span></div>
        <p id="tm-date"></p>
        <div id="tm-list" style="margin-bottom:15px;"></div>
        <div class="admin-only">
            <hr>
            <h4>Yeni Atama</h4>
            <label>Personel:</label><div class="ms-area" id="ms-per"></div>
            <label>Proje:</label><select id="t-proj"></select>
            <input type="text" id="t-loc" placeholder="Konum">
            <label>Ara√ß:</label><div class="ms-area" id="ms-veh"></div>
            <label>Cihaz:</label><div class="ms-area" id="ms-dev"></div>
            <div id="conflict-warn" style="color:red; font-size:0.8rem; margin:5px 0;"></div>
            <button class="btn" onclick="saveTask()">Kaydet</button>
        </div>
    </div>
</div>

<div class="modal" id="custodyModal">
    <div class="modal-content">
        <h3>Zimmetle</h3>
        <p id="cm-name"></p>
        <select id="c-per"></select>
        <button class="btn" onclick="doCustody()">Kaydet</button>
        <button class="btn" style="background:#ccc;" onclick="document.getElementById('custodyModal').style.display='none'">ƒ∞ptal</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, deleteDoc, updateDoc, doc, onSnapshot, query, orderBy, setDoc, getDoc, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // CONFIG
    const firebaseConfig = {
      apiKey: "AIzaSyD4XZR8JAMe-Qr2Oj2UGnp9mFc8En38gxY",
      authDomain: "ekiptakipapp.firebaseapp.com",
      projectId: "ekiptakipapp",
      storageBucket: "ekiptakipapp.firebasestorage.app",
      messagingSenderId: "55716082808",
      appId: "1:55716082808:web:b144b953684fc9f80c698d",
      measurementId: "G-S6Q0H5RHR7"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ONESIGNAL
    window.OneSignalDeferred = window.OneSignalDeferred || [];
    OneSignalDeferred.push(function(OneSignal) {
        OneSignal.init({ appId: "08d90e98-c6b4-429c-aab5-f11164ddc881" });
    });

    // VARS
    let users=[], projects=[], tasks=[], vehicles=[], devices=[], logs=[];
    let curUser, role='staff', curDate=new Date(), selDate;
    let custodyId, custodyType;

    // AUTH
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            const u = await getDoc(doc(db, "users", user.email));
            if (u.exists()) {
                curUser=u.data(); role=curUser.role;
                document.getElementById('user-name').innerText = curUser.name.split(' ')[0];
                document.querySelectorAll('.admin-only').forEach(e=>e.style.display=(role==='admin'?'block':'none'));
                document.querySelectorAll('.nav-item.admin-only').forEach(e=>e.style.display=(role==='admin'?'flex':'none'));
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('app-screen').classList.remove('hidden');
                document.getElementById('r-date').value = new Date().toISOString().slice(0,7);
                OneSignalDeferred.push(function(OneSignal) { OneSignal.login(user.email); });
                startListeners();
            } else {
                await setDoc(doc(db,"users",user.email), {name:"Y√∂netici", email:user.email, role:"admin"});
                window.location.reload();
            }
        } else {
            document.getElementById('login-screen').classList.remove('hidden');
            document.getElementById('app-screen').classList.add('hidden');
        }
    });

    window.login = () => signInWithEmailAndPassword(auth, document.getElementById('lemail').value, document.getElementById('lpass').value).catch(e=>alert(e.message));
    window.logout = () => signOut(auth).then(()=>window.location.reload());
    window.register = async () => {
        try {
            const em=document.getElementById('remail').value;
            await createUserWithEmailAndPassword(auth, em, document.getElementById('rpass').value);
            await setDoc(doc(db,"users",em), {name:document.getElementById('rname').value, title:document.getElementById('rtitle').value, email:em, role:'admin'});
        } catch(e){alert(e.message)}
    }
    window.requestPerm = () => Notification.requestPermission().then(p => { if(p==='granted') alert("A√ßƒ±k"); });

    // DATA
    function startListeners() {
        const sub = (c, arr, cb) => onSnapshot(collection(db, c), s => { arr.length=0; s.forEach(d=>arr.push({id:d.id,...d.data()})); cb(); loadDrops(); });
        sub("users", users, renderUsers);
        sub("projects", projects, renderProj);
        sub("vehicles", vehicles, renderVeh);
        sub("devices", devices, renderDev);
        
        onSnapshot(collection(db, "tasks"), s => { tasks=[]; s.forEach(d=>tasks.push({id:d.id,...d.data()})); renderCal(); renderTeam(); renderRep(); });
        onSnapshot(query(collection(db, "logs"), orderBy("date", "desc"), limit(100)), s => { logs=[]; s.forEach(d=>logs.push(d.data())); renderRep(); });
    }

    // UI
    window.goTab = (t) => {
        document.querySelectorAll('.view-section').forEach(e=>e.classList.remove('active'));
        document.getElementById('tab-'+t).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('active'));
        event.currentTarget.classList.add('active');
    }
    window.switchTab = window.goTab; // Alias for compatibility

    // CALENDAR
    window.moveMonth = (m) => { curDate.setMonth(curDate.getMonth()+m); renderCal(); }
    function renderCal() {
        const m=curDate.getMonth(), y=curDate.getFullYear();
        document.getElementById('month-display').innerText = `${m+1}/${y}`; // monthDisplay idi
        const first=new Date(y,m,1).getDay(), days=new Date(y,m+1,0).getDate();
        let h=""; for(let i=0; i<(first===0?6:first-1); i++) h+=`<div></div>`;
        const today = new Date().toISOString().split('T')[0];
        for(let d=1; d<=days; d++) {
            const dk = `${d}-${m}-${y}`;
            const dt = tasks.filter(t=>t.date===dk);
            let dots=""; dt.forEach(t=>{ if(Array.isArray(t.person)) t.person.forEach(p=>dots+=`<span class="task-dot">${p}</span>`); else dots+=`<span class="task-dot">${t.person}</span>`; });
            h+=`<div class="day ${dk===today?'today':''}" onclick="openDay('${dk}')"><b>${d}</b>${dots}</div>`;
        }
        document.getElementById('cal-grid').innerHTML = h; // calGrid idi
    }
    window.openDay = (dk) => {
        selDate=dk; document.getElementById('tm-date').innerText=dk;
        const dt = tasks.filter(t=>t.date===dk);
        document.getElementById('tm-list').innerHTML = dt.map(t=>`
            <div style="padding:10px; background:#f9f9f9; border-radius:8px; margin-bottom:5px;">
                <strong>${Array.isArray(t.person)?t.person.join(', '):t.person}</strong><br>${t.projectName}
                ${role==='admin'?`<button onclick="delTask('${t.id}')" style="color:red;border:none;float:right;">üóë</button>`:''}
            </div>`).join('') || 'G√∂rev Yok';
        document.getElementById('taskModal').style.display='flex';
    }

    // TASKS
    window.saveTask = async () => {
        const per = getMulti('ms-per'), dev = getMulti('ms-dev'), veh = getMulti('ms-veh');
        const pid = document.getElementById('t-proj').value;
        if(!pid || per.length===0) return alert("Eksik");
        
        // Zimmet Check
        let warn=""; dev.forEach(n=>{ const d=devices.find(x=>x.name===n); if(d&&d.currentHolder&&!per.includes(d.currentHolder)) warn+=`${n} cihazƒ± ${d.currentHolder} zimmetinde!\n`; });
        if(warn && !confirm(warn+"Atansƒ±n mƒ±?")) return;

        const pname = projects.find(p=>p.id===pid).name;
        await addDoc(collection(db,"tasks"), { date:selDate, person:per, projectName:pname, projectId:pid, location:document.getElementById('t-loc').value, device:dev, plate:veh });
        
        // Notify
        const emails = users.filter(u => per.includes(u.name)).map(u => u.email);
        if(emails.length>0) sendPush(emails, `${selDate}: ${pname} g√∂revi.`);
        
        document.getElementById('taskModal').style.display='none';
        document.querySelectorAll('.multi-select-area input').forEach(c=>c.checked=false);
    }
    window.delTask = (id) => { if(confirm("Sil?")) deleteDoc(doc(db,"tasks",id)).then(()=>document.getElementById('taskModal').style.display='none'); }

    // CRUD & ZIMMET
    window.addProj = () => addDoc(collection(db,"projects"),{name:document.getElementById('p-name').value, manager:document.getElementById('p-man').value, start:document.getElementById('p-start').value, end:document.getElementById('p-end').value, cost:document.getElementById('p-cost').value, offer:document.getElementById('p-offer').value}).then(()=>document.getElementById('p-name').value="");
    
    window.addVeh = () => addDoc(collection(db,"vehicles"),{plate:document.getElementById('v-plate').value, info:document.getElementById('v-info').value, inspectionDate:document.getElementById('v-insp').value, currentHolder:null}).then(()=>document.getElementById('v-plate').value="");
    window.addDev = () => addDoc(collection(db,"devices"),{name:document.getElementById('d-name').value, serial:document.getElementById('d-ser').value, calib:document.getElementById('d-cal').value, currentHolder:null}).then(()=>document.getElementById('d-name').value="");
    window.addUser = () => setDoc(doc(db,"users",document.getElementById('u-email').value),{name:document.getElementById('u-name').value, title:document.getElementById('u-title').value, email:document.getElementById('u-email').value, role:document.getElementById('u-role').value}).then(()=>alert("Eklendi"));
    
    window.delItem = (c,id) => { if(confirm("Sil?")) deleteDoc(doc(db,c,id)); }
    
    // Zimmet Logic
    window.openCustody = (type, id, name) => { custodyType=type; custodyId=id; document.getElementById('cm-name').innerText=name; document.getElementById('custodyModal').style.display='flex'; }
    window.saveCustody = async () => {
        const p = document.getElementById('c-per').value;
        const col = custodyType==='vehicle'?'vehicles':'devices';
        await updateDoc(doc(db, col, custodyId), { currentHolder: p });
        await addLog(custodyType, document.getElementById('cm-name').innerText, 'take', p);
        document.getElementById('custodyModal').style.display='none';
    }
    window.dropItem = async (col, id, name) => {
        if(confirm("ƒ∞ade?")) {
            await updateDoc(doc(db, col, id), { currentHolder: null });
            await addLog(col==='vehicles'?'vehicle':'device', name, 'return', curUser.name);
        }
    }

    // RENDERERS
    function renderProj() { document.getElementById('proj-list').innerHTML=projects.map(p=>`<div class="card"><strong>${p.name}</strong><br><small>${p.manager}</small> ${role==='admin'?`<button onclick="delItem('projects','${p.id}')" class="btn-sm btn-red">Sil</button>`:''}</div>`).join(''); }
    function renderVeh() { document.getElementById('veh-list').innerHTML=vehicles.map(v=>`<div class="card ${v.currentHolder?'custody':'active'}"><div><strong>${v.plate}</strong> ${v.info}<br><small>Muayene: ${v.inspectionDate||'-'}</small></div><div>${v.currentHolder ? `<span class="badge bg-orange">${v.currentHolder}</span>` : `<span class="badge bg-green">BO≈ûTA</span>`} ${role==='admin' ? (v.currentHolder ? `<button class="btn-sm btn-red" onclick="dropItem('vehicles','${v.id}','${v.plate}')">ƒ∞ade</button>` : `<button class="btn-sm btn-blue" onclick="openCustody('vehicle','${v.id}','${v.plate}')">Zimmet</button>`) : ''} ${role==='admin'?`<button onclick="delItem('vehicles','${v.id}')" class="btn-sm btn-red">Sil</button>`:''}</div></div>`).join(''); }
    function renderDev() { document.getElementById('dev-list').innerHTML=devices.map(d=>`<div class="card ${d.currentHolder?'custody':'active'}"><div><strong>${d.name}</strong> (${d.serial})<br><small>Kalibrasyon: ${d.calib||'-'}</small></div><div>${d.currentHolder ? `<span class="badge bg-orange">${d.currentHolder}</span>` : `<span class="badge bg-green">BO≈ûTA</span>`} ${role==='admin' ? (d.currentHolder ? `<button class="btn-sm btn-red" onclick="dropItem('devices','${d.id}','${d.name}')">ƒ∞ade</button>` : `<button class="btn-sm btn-blue" onclick="openCustody('device','${d.id}','${d.name}')">Zimmet</button>`) : ''} ${role==='admin'?`<button onclick="delItem('devices','${d.id}')" class="btn-sm btn-red">Sil</button>`:''}</div></div>`).join(''); }
    function renderUsers() { document.getElementById('user-list').innerHTML=users.map(u=>`<div class="card"><strong>${u.name}</strong> <small>${u.title||''}</small><br>${u.email} ${role==='admin'?`<button onclick="delItem('users','${u.email}')" class="btn-sm btn-red">Sil</button>`:''}</div>`).join(''); }
    
    function renderTeam() {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('team-list').innerHTML=users.map(u=>{
            const at = tasks.find(t=>t.date===today && (Array.isArray(t.person)?t.person.includes(u.name):t.person===u.name));
            const fut = tasks.filter(t=>t.date>today && (Array.isArray(t.person)?t.person.includes(u.name):t.person===u.name)).sort((a,b)=>a.date.localeCompare(b.date))[0];
            return `<div class="card ${at?'busy':'active'}"><div><strong>${u.name}</strong> <small>(${u.title||''})</small><br>${fut?`<small style="color:orange">Sonraki: ${fut.date} - ${fut.projectName}</small>`:''}</div><span class="badge ${at?'bg-red':'bg-green'}">${at?'SAHADA':'BO≈ûTA'}</span></div>`;
        }).join('');
    }
    
    async function addLog(type, item, act, per) { await addDoc(collection(db,"logs"), {date:new Date().toISOString(), type, item, action:act, person:per}); }
    window.renderLogs = () => {
        const ym = document.getElementById('r-date').value; if(!ym) return;
        const fl = logs.filter(l=>l.date.startsWith(ym));
        document.getElementById('log-list').innerHTML = fl.map(l=>`<div><small>${l.date.slice(0,16).replace('T',' ')}</small> <strong>${l.person}</strong> ${l.action==='take'?'Aldƒ±':'Verdi'}: ${l.item}</div>`).join('');
        // Efor
        const cnt={}; users.forEach(u=>cnt[u.name]=0);
        tasks.forEach(t=>{ if(t.date.startsWith(ym.split('-')[1])) { if(Array.isArray(t.person)) t.person.forEach(p=>{if(cnt[p]!==undefined)cnt[p]++}); else if(cnt[t.person]!==undefined)cnt[t.person]++; } });
        document.getElementById('eff-list').innerHTML = Object.keys(cnt).map(k=>`<div>${k}: <strong>${cnt[k]} G√ºn</strong></div>`).join('');
    }

    // HELPERS
    function loadDrops() {
        const sel = (id,arr) => { if(document.getElementById(id)) document.getElementById(id).innerHTML=arr.map(x=>`<option>${x.name}</option>`).join(''); }
        const ms = (id,arr,k) => { if(document.getElementById(id)) document.getElementById(id).innerHTML=arr.map(x=>`<div class="ms-opt"><input type="checkbox" value="${x[k]}">${x[k]}</div>`).join(''); }
        sel('p-man', users); sel('c-per', users);
        ms('ms-per', users, 'name'); ms('ms-veh', vehicles, 'plate'); ms('ms-dev', devices, 'name');
        if(document.getElementById('t-proj')) document.getElementById('t-proj').innerHTML=`<option value="">Se√ß</option>`+projects.map(p=>`<option value="${p.id}">${p.name}</option>`).join('');
    }
    function getMulti(id){return Array.from(document.querySelectorAll(`#${id} input:checked`)).map(i=>i.value);}
    
    async function sendPush(emails, msg) {
        try { await fetch('https://onesignal.com/api/v1/notifications', {
            method:'POST', headers:{'Authorization':'Basic os_v2_app_bdmq5gggwrbjzkvv6eiwjxoiqh5q6foeed5uwdnuxioe7piyndd5zus3d632jsuuwtik6x4npdfvrl2k3lmolhffex6ndislurwmnma', 'content-type':'application/json'},
            body: JSON.stringify({app_id:"08d90e98-c6b4-429c-aab5-f11164ddc881", include_aliases:{"external_id":emails}, target_channel:"push", contents:{"en":msg}, headings:{"en":"Ekip Takip"}})
        }); } catch(e){}
    }
</script>
</body>
</html>
