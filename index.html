<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ekip Takip Pro (V41 - Desktop Scroll Fix)</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4facfe">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        /* GENEL STƒ∞LLER (KORUNDU) */
        :root { --primary-grad: linear-gradient(135deg, #667eea 0%, #764ba2 100%); --bg-color: #f3f5f9; --text-main: #2d3436; --nav-height: 75px; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Poppins', sans-serif; background-color: var(--bg-color); margin: 0; padding: 0; padding-bottom: 120px; color: var(--text-main); }

        .hidden { display: none !important; } 
        .admin-only { display: none; } 
        .view-section { display: none; animation: fadeIn 0.3s; } 
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* TOAST Bƒ∞LDƒ∞Rƒ∞M */
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 3000; display: none; padding: 15px 20px; border-radius: 10px; color: white; box-shadow: 0 10px 30px rgba(0,0,0,0.2); animation: slideInRight 0.3s; }
        @keyframes slideInRight { from { transform: translateX(100%); } to { transform: translateX(0); } }
        .toast-success { background: #27ae60; }
        .toast-error { background: #e74c3c; }

        /* HEADER */
        .app-header { padding: 20px; display: flex; justify-content: space-between; align-items: center; }
        .header-icons { display: flex; align-items: center; gap: 10px; position: relative; }
        .icon-btn { width: 40px; height: 40px; background: white; border-radius: 50%; display: flex; justify-content: center; align-items: center; border: none; box-shadow: 0 2px 5px rgba(0,0,0,0.1); cursor: pointer; font-size: 1.2rem; position: relative; }
        .notif-badge { position: absolute; top: -5px; right: -5px; background: red; color: white; border-radius: 50%; width: 20px; height: 20px; font-size: 0.7rem; display: none; justify-content: center; align-items: center; border: 2px solid white; }

        /* ALT MEN√ú (SCROLL D√úZELTƒ∞LDƒ∞ + DRAG EKLENDƒ∞) */
        .bottom-nav { 
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: 95%; max-width: 600px; 
            background: white; height: var(--nav-height); border-radius: 25px; display: flex; align-items: center; 
            box-shadow: 0 15px 35px rgba(0,0,0,0.15); z-index: 1000; overflow-x: auto; padding: 0 10px; gap: 15px; 
            -ms-overflow-style: none; scrollbar-width: none; white-space: nowrap; cursor: grab; user-select: none; /* S√ºr√ºkleme i√ßin imle√ß */
        }
        .bottom-nav:active { cursor: grabbing; }
        .bottom-nav::-webkit-scrollbar { display: none; }
        
        .nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 0.7rem; color: #b2bec3; min-width: 60px; cursor: pointer; transition: 0.3s; flex-shrink: 0; }
        .nav-item .icon { font-size: 1.5rem; margin-bottom: 2px; pointer-events: none; /* ƒ∞kon s√ºr√ºklemeyi engellemesin */ }
        .nav-item.active { color: #764ba2; transform: translateY(-3px); font-weight: 600; }

        /* Bƒ∞LDƒ∞Rƒ∞M PENCERESƒ∞ */
        #notification-dropdown { position: absolute; top: 60px; right: 0; width: 300px; background: white; border-radius: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); z-index: 2500; display: none; overflow: hidden; border: 1px solid #eee; }
        .notif-header { background: #f8f9fa; padding: 10px 15px; font-weight: bold; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; }
        .notif-list { max-height: 300px; overflow-y: auto; }
        .notif-item { padding: 10px 15px; border-bottom: 1px solid #f0f0f0; font-size: 0.85rem; }
        .notif-empty { padding: 20px; text-align: center; color: #aaa; font-size: 0.9rem; }

        .container { max-width: 1100px; margin: 0 auto; padding: 0 15px; }
        .modern-card { background: white; border-radius: 20px; padding: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); margin-bottom: 15px; }
        .hero-card { background: var(--primary-grad); border-radius: 25px; padding: 25px; color: white; margin-bottom: 20px; box-shadow: 0 10px 20px rgba(118, 75, 162, 0.3); }
        .hero-stat-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-top: 15px; text-align: center; }
        .hero-stat-item span { font-size: 1.8rem; font-weight: 700; display: block; }

        /* ARAMA & KARTLAR */
        .search-bar { width: 100%; padding: 12px 15px; border-radius: 12px; border: 1px solid #eee; background: #fff url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="%23ccc" viewBox="0 0 16 16"><path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/></svg>') no-repeat right 15px center; margin-bottom: 15px; font-size: 0.9rem; }
        .info-card { background: white; padding: 15px; border-radius: 12px; margin-bottom: 10px; border-left: 5px solid #ccc; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .info-card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
        .info-card.active { border-left-color: #27ae60; } 
        .info-card.busy { border-left-color: #e74c3c; } 
        .info-card.custody { border-left-color: #f39c12; }
        .badge { padding: 4px 8px; border-radius: 6px; font-size: 0.75rem; font-weight: bold; }
        .badge-green { background: #d1fae5; color: #065f46; } 
        .badge-red { background: #fee2e2; color: #991b1b; } 
        .badge-orange { background: #ffedd5; color: #9a3412; } 
        .badge-gray { background: #f3f4f6; color: #374151; }
        
        /* TAKVƒ∞M */
        .calendar-nav-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; }
        .day-head { text-align: center; font-size: 0.8rem; color: #888; margin-bottom: 5px; }
        .day-cell { background: #f8f9fa; min-height: 80px; border-radius: 8px; padding: 4px; font-size: 0.8rem; position: relative; cursor: pointer; display: flex; flex-direction: column; overflow: hidden; }
        .day-cell b { align-self: center; margin-bottom: 4px; color: #333; }
        .day-cell.today { border: 2px solid #764ba2; background: white; }
        .task-dot { font-size: 0.6rem; background: #e0e7ff; color: #4338ca; padding: 2px 4px; margin-bottom: 2px; border-radius: 3px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; }

        /* FORM & TABLO */
        input, select { width: 100%; padding: 12px; border: 1px solid #eee; background: #f9f9f9; border-radius: 10px; margin-bottom: 10px; font-size: 16px; outline: none; }
        .btn-main { width: 100%; padding: 12px; background: var(--primary-grad); color: white; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; margin-bottom: 5px; transition: opacity 0.3s; }
        .btn-main:disabled { opacity: 0.6; cursor: not-allowed; }
        .btn-sm { padding: 5px 10px; font-size: 0.8rem; border-radius: 6px; border: none; cursor: pointer; margin-left: 5px; }
        .filter-btn { padding: 8px 15px; border: 1px solid #eee; border-radius: 20px; background: #fff; cursor: pointer; font-size: 0.8rem; }
        .filter-btn.active { background: var(--primary-grad); color: white; border: none; }
        
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; display: none; justify-content: center; align-items: end; }
        .modal-card { background: white; width: 100%; max-width: 500px; border-radius: 20px 20px 0 0; padding: 25px; max-height: 85vh; overflow-y: auto; }
        #month-picker-modal { display: none; position: absolute; top: 60px; left: 50%; transform: translateX(-50%); width: 300px; background: white; border-radius: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); z-index: 500; padding: 15px; }
        .year-selector { display: flex; justify-content: space-between; margin-bottom: 15px; }
        .month-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .month-btn { padding: 10px; background: #f9f9f9; text-align: center; cursor: pointer; border-radius: 5px; font-size: 0.8rem; }
        
        .multi-select-area { background: #f9f9f9; border: 1px solid #eee; border-radius: 10px; padding: 10px; max-height: 150px; overflow-y: auto; margin-bottom: 10px; }
        .ms-item { display: flex; align-items: center; margin-bottom: 8px; } .ms-item input { width: 20px; margin: 0 10px 0 0; }
        .log-table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
        .log-table th { text-align: left; padding: 10px; background: #f4f6f8; }
        .log-table td { padding: 10px; border-bottom: 1px solid #eee; }
        
        .avatar { width: 40px; height: 40px; background: #eee; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-weight: bold; color: #555; margin-right:10px;}
        .person-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #f0f0f0; }
    </style>
</head>
<body>

<div id="toast-container"></div>

<div id="app-screen">
    <div class="app-header">
        <div><small style="color:#888;">Merhaba,</small><h2 style="margin:0;" id="welcomeUser">Kullanƒ±cƒ±</h2></div>
        
        <div class="header-icons">
            <button class="icon-btn" onclick="toggleNotifications()">
                üîî
                <span id="notif-badge" class="notif-badge">0</span>
            </button>
            
            <button class="icon-btn" onclick="handleLogout()">üö™</button>
            
            <div id="notification-dropdown">
                <div class="notif-header">
                    <span>Bildirimler</span>
                    <button onclick="clearAllNotifications()" style="background:none; border:none; color:#e74c3c; font-size:0.7rem; cursor:pointer;">Temizle</button>
                </div>
                <div id="notif-list" class="notif-list">
                    <div class="notif-empty">Bildirim yok.</div>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        
        <div id="view-calendar" class="view-section active">
            <div class="hero-card">
                <div class="hero-stat-grid">
                    <div class="hero-stat-item"><span id="stat-total">0</span><small>Ekip</small></div>
                    <div class="hero-stat-item"><span id="stat-active">0</span><small>Sahada</small></div>
                    <div class="hero-stat-item"><span id="stat-idle">0</span><small>Bo≈üta</small></div>
                </div>
            </div>
            <div class="modern-card">
                <div class="calendar-nav-row">
                    <button class="icon-btn" style="width:35px; height:35px;" onclick="changeMonth(-1)">‚óÄ</button>
                    <div style="position:relative; text-align:center;">
                        <h3 style="margin:0; cursor:pointer; text-decoration:underline;" id="monthDisplay" onclick="toggleDatePicker()">Takvim</h3>
                        <div id="month-picker-modal">
                            <div class="year-selector"><button onclick="changePickYear(-1)">‚óÄ</button><span id="pick-year-val">2025</span><button onclick="changePickYear(1)">‚ñ∂</button></div>
                            <div class="month-grid">
                                <div class="month-btn" onclick="goToMonth(0)">Oca</div><div class="month-btn" onclick="goToMonth(1)">≈ûub</div><div class="month-btn" onclick="goToMonth(2)">Mar</div>
                                <div class="month-btn" onclick="goToMonth(3)">Nis</div><div class="month-btn" onclick="goToMonth(4)">May</div><div class="month-btn" onclick="goToMonth(5)">Haz</div>
                                <div class="month-btn" onclick="goToMonth(6)">Tem</div><div class="month-btn" onclick="goToMonth(7)">Aƒüu</div><div class="month-btn" onclick="goToMonth(8)">Eyl</div>
                                <div class="month-btn" onclick="goToMonth(9)">Eki</div><div class="month-btn" onclick="goToMonth(10)">Kas</div><div class="month-btn" onclick="goToMonth(11)">Ara</div>
                            </div>
                        </div>
                    </div>
                    <button class="icon-btn" style="width:35px; height:35px;" onclick="changeMonth(1)">‚ñ∂</button>
                </div>
                <div class="calendar-grid" id="calendarGrid"></div>
            </div>
        </div>

        <div id="view-projects" class="view-section">
            <input type="text" class="search-bar" placeholder="Proje Ara..." onkeyup="filterList(this, 'projectListBody', 'div')">
            <div class="admin-only modern-card" id="projectFormContainer">
                <h3 id="projectFormTitle">Yeni Proje</h3>
                <input type="text" id="p-name" placeholder="Proje Adƒ±">
                <select id="p-manager"></select>
                <div style="display:flex; gap:5px;">
                    <div style="flex:1"><label style="font-size:0.7rem;">Ba≈ülangƒ±√ß</label><input type="date" id="p-start"></div>
                    <div style="flex:1"><label style="font-size:0.7rem;">Biti≈ü</label><input type="date" id="p-end"></div>
                </div>
                <div style="display:flex; gap:5px;"><input type="number" id="p-cost" placeholder="Maliyet"><input type="number" id="p-offer" placeholder="Teklif"></div>
                <div style="display:flex; gap:5px;">
                    <button class="btn-main" id="btn-p-save" onclick="submitProject()">Kaydet</button>
                    <button class="btn-main" id="btn-p-update" onclick="updateProjectDB()" style="background:#f39c12; display:none;">G√ºncelle</button>
                    <button class="btn-main" id="btn-p-cancel" onclick="cancelProjectEdit()" style="background:#95a5a6; display:none;">Vazge√ß</button>
                </div>
            </div>
            <div class="modern-card" id="projectListBody"></div>
        </div>

        <div id="view-team" class="view-section">
            <input type="text" class="search-bar" placeholder="Personel Ara..." onkeyup="filterList(this, 'teamListArea', 'div.person-row')">
            <div class="modern-card" id="teamListArea"></div>
        </div>

        <div id="view-vehicles" class="view-section">
            <input type="text" class="search-bar" placeholder="Plaka/Model Ara..." onkeyup="filterList(this, 'vehicleListArea', 'div.info-card')">
            <div class="admin-only modern-card" id="vehicleFormContainer">
                <h3 id="vehicleFormTitle">Yeni Ara√ß</h3>
                <input type="text" id="v-plate" placeholder="Plaka">
                <input type="text" id="v-info" placeholder="Model">
                <label>Muayene Tarihi:</label><input type="date" id="v-inspection">
                <div style="display:flex; gap:5px;">
                    <button class="btn-main" id="btn-v-save" onclick="addVehicle()">Kaydet</button>
                    <button class="btn-main" id="btn-v-update" onclick="updateVehicleDB()" style="background:#f39c12; display:none;">G√ºncelle</button>
                    <button class="btn-main" id="btn-v-cancel" onclick="cancelVehicleEdit()" style="background:#95a5a6; display:none;">Vazge√ß</button>
                </div>
            </div>
            <div class="modern-card"><div id="vehicleListArea" class="card-list"></div></div>
        </div>

        <div id="view-devices" class="view-section">
            <input type="text" class="search-bar" placeholder="Cihaz/Seri No Ara..." onkeyup="filterList(this, 'deviceListArea', 'div.info-card')">
            <div class="admin-only modern-card" id="deviceFormContainer">
                <h3 id="deviceFormTitle">Yeni Cihaz</h3>
                <input type="text" id="d-name" placeholder="Cihaz Adƒ±">
                <input type="text" id="d-serial" placeholder="Seri No">
                <label>Kalibrasyon:</label><input type="date" id="d-calib">
                <div style="display:flex; gap:5px;">
                    <button class="btn-main" id="btn-d-save" onclick="addDevice()">Ekle</button>
                    <button class="btn-main" id="btn-d-update" onclick="updateDeviceDB()" style="background:#f39c12; display:none;">G√ºncelle</button>
                    <button class="btn-main" id="btn-d-cancel" onclick="cancelDeviceEdit()" style="background:#95a5a6; display:none;">Vazge√ß</button>
                </div>
            </div>
            <div class="modern-card"><div id="deviceListArea" class="card-list"></div></div>
        </div>

        <div id="view-users" class="view-section">
            <div class="admin-only modern-card">
                <h3 id="userFormTitle">Kullanƒ±cƒ± Y√∂netimi</h3>
                <input type="text" id="u-name" placeholder="Ad Soyad">
                <input type="text" id="u-title" placeholder="√únvan">
                <input type="email" id="u-email" placeholder="E-Posta">
                <input type="tel" id="u-phone" placeholder="Tel (√ñrn: 90532xxxxxxx)">
                <select id="u-role"><option value="staff">Personel</option><option value="admin">Y√∂netici</option></select>
                <div style="display:flex; gap:5px;">
                    <button class="btn-main" id="btn-user-add" onclick="addUserToDB()">Ekle</button>
                    <button class="btn-main" id="btn-user-update" onclick="updateUserDB()" style="background:#f39c12; display:none;">G√ºncelle</button>
                    <button class="btn-main" id="btn-user-cancel" onclick="cancelUserEdit()" style="background:#95a5a6; display:none;">Vazge√ß</button>
                </div>
            </div>
            <div class="modern-card" id="userListArea"></div>
        </div>

        <div id="view-reports" class="view-section">
            <div class="modern-card">
                <label>D√∂nem:</label>
                <input type="month" id="reportDateSelector" onchange="filterReports()" style="width:100%;">
            </div>
            <div class="modern-card">
                <h3>Zimmet Ge√ßmi≈üi</h3>
                <div class="report-filters" style="display:flex; gap:5px; margin-bottom:10px;">
                    <button class="filter-btn active" onclick="setReportFilter('all', this)">T√ºm√º</button>
                    <button class="filter-btn" onclick="setReportFilter('vehicle', this)">Ara√ß</button>
                    <button class="filter-btn" onclick="setReportFilter('device', this)">Cihaz</button>
                </div>
                <div style="max-height:300px; overflow-y:auto;">
                    <table class="log-table" id="logTable" style="width:100%; font-size:0.8rem;"></table>
                </div>
            </div>
             <div class="modern-card">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h3>Personel Eforu</h3>
                    <button class="btn-sm" style="background:#27ae60; color:white; border:none; border-radius:5px; cursor:pointer;" onclick="exportExcel()">Excel ƒ∞ndir</button>
                </div>
                <table class="log-table" id="personnelReportTable" style="width:100%;"><tbody id="personnelReportBody"></tbody></table>
            </div>
        </div>

        <div id="view-logs" class="view-section">
            <div class="modern-card">
                <h3>Sistem Kayƒ±tlarƒ± (Log)</h3>
                <label>Tarih Se√ß:</label>
                <div style="display:flex; gap:10px; margin-bottom:15px;">
                    <input type="date" id="adminLogDate" onchange="renderAdminLogs(this.value)">
                    <button class="btn-sm" onclick="exportLogsToWord()" style="background:#2980b9; color:white;">Word ƒ∞ndir</button>
                </div>
                <div style="overflow-x:auto;" id="adminLogContainer">
                    <table class="log-table" id="adminLogTable" style="width:100%;">
                        <thead><tr><th>Tarih</th><th>Kullanƒ±cƒ±</th><th>ƒ∞≈ülem</th><th>Detay</th></tr></thead>
                        <tbody id="adminLogBody"><tr><td colspan="4">Tarih se√ßiniz.</td></tr></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="view-profile" class="view-section">
            <div class="modern-card">
                <h3>Profilim</h3>
                <div style="text-align:center; margin-bottom:20px;">
                    <div style="width:80px; height:80px; background:#764ba2; color:white; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:2rem; margin:0 auto;" id="profileAvatar">?</div>
                    <h2 id="profileName" style="margin:10px 0 5px 0;">-</h2>
                    <p id="profileRole" style="color:#888; margin:0;">-</p>
                </div>
                <div style="border-top:1px solid #eee; padding-top:15px;">
                    <h4>≈ûifre Deƒüi≈ütir</h4>
                    <input type="password" id="new-pass" placeholder="Yeni ≈ûifre">
                    <input type="password" id="new-pass-confirm" placeholder="Yeni ≈ûifre (Tekrar)">
                    <button class="btn-main" onclick="updateUserPassword()">≈ûifreyi G√ºncelle</button>
                </div>
            </div>
        </div>

    </div>

    <div class="bottom-nav" id="bottomNav">
        <div class="nav-item active" onclick="switchTab('calendar')"><span class="icon">üìÖ</span>Takvim</div>
        <div class="nav-item" onclick="switchTab('projects')"><span class="icon">üìÇ</span>Proje</div>
        <div class="nav-item" onclick="switchTab('team')"><span class="icon">üë•</span>Ekip</div>
        <div class="nav-item" onclick="switchTab('vehicles')"><span class="icon">üöó</span>Ara√ß</div>
        <div class="nav-item" onclick="switchTab('devices')"><span class="icon">üß∞</span>Cihaz</div>
        <div class="nav-item admin-only" onclick="switchTab('users')"><span class="icon">‚öôÔ∏è</span>Yetki</div>
        <div class="nav-item admin-only" onclick="switchTab('reports')"><span class="icon">üìä</span>Rapor</div>
        <div class="nav-item admin-only" onclick="switchTab('logs')"><span class="icon">üìù</span>Log</div>
        <div class="nav-item" onclick="switchTab('profile')"><span class="icon">üë§</span>Profil</div>
    </div>
</div>

<div class="modal-overlay" id="custodyModal" onclick="if(event.target===this) closeCustodyModal()">
    <div class="modal-card">
        <h3>Zimmetle</h3>
        <p id="custodyItemName" style="color:#666;"></p>
        <label>Personel Se√ß:</label><select id="c-person"></select>
        <button class="btn-main" onclick="saveCustody()">Kaydet</button>
        <button class="btn-main" onclick="closeCustodyModal()" style="background:#95a5a6; margin-top:10px;">ƒ∞ptal</button>
    </div>
</div>

<div class="modal-overlay" id="taskModal" onclick="if(event.target===this) closeModal()">
    <div class="modal-card">
        <div style="display:flex; justify-content:space-between; margin-bottom:20px;"><h2>G√∂revler</h2><span onclick="closeModal()" style="font-size:1.5rem; cursor:pointer;">‚úï</span></div>
        <p id="modalDateText" style="margin-bottom:10px; font-weight:bold; color:#764ba2;"></p>
        
        <div id="dayTaskList" style="margin-bottom:20px;"></div>
        
        <div class="admin-only">
            <h3 id="taskFormTitle">Yeni Atama</h3>
            <div style="display:flex; gap:10px;">
                <div style="flex:1;"><label>Ba≈ülangƒ±√ß</label><input type="date" id="t-start-date"></div>
                <div style="flex:1;"><label>Biti≈ü</label><input type="date" id="t-end-date"></div>
            </div>

            <label>Personel</label><div class="multi-select-area" id="ms-person"></div>
            <label>Proje</label><select id="t-project-select"></select>
            <input type="text" id="t-loc" placeholder="Konum">
            <label>Ara√ßlar</label><div class="multi-select-area" id="ms-plate"></div>
            <label>Cihazlar</label><div class="multi-select-area" id="ms-device"></div>
            <div id="conflictWarning" style="color:red; font-size:0.8rem; margin:10px 0;"></div>
            
            <button class="btn-main" id="btn-save-task" onclick="saveTask()">Kaydet</button>
            <button class="btn-main" id="btn-cancel-task" onclick="cancelTaskEdit()" style="background:#95a5a6; display:none; margin-top:5px;">Vazge√ß</button>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signOut, onAuthStateChanged, updatePassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, deleteDoc, updateDoc, doc, onSnapshot, query, orderBy, setDoc, getDoc, limit, where, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // --- FIREBASE AYARLARI ---
    const k1 = "AIzaSyD4XZR8JAMe-"; const k2 = "Qr2Oj2UGnp9mFc8En38gxY";
    const firebaseConfig = {
      apiKey: k1 + k2,
      authDomain: "ekiptakipapp.firebaseapp.com",
      projectId: "ekiptakipapp",
      storageBucket: "ekiptakipapp.firebasestorage.app",
      messagingSenderId: "55716082808",
      appId: "1:55716082808:web:b144b953684fc9f80c698d",
      measurementId: "G-S6Q0H5RHR7"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let projects=[], tasks=[], users=[], vehicles=[], devices=[], logs=[], notifications=[];
    let currentUser=null, userRole='staff';
    let currentDate=new Date(), selectedDateStr=getCurrentDateStr(), isFirstLoad=true;
    let pickerYear = new Date().getFullYear(), editingUserEmail=null, editingVehicleId=null, editingDeviceId=null, editingProjectId=null;
    let editingTaskId = null;
    let custodyTargetId = null, custodyType = null;
    let currentReportFilter = 'all', currentReportDate = new Date().toISOString().slice(0, 7);

    // --- Gƒ∞Rƒ∞≈û KONTROL√ú VE VERƒ∞ Y√úKLEME ---
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            const userDoc = await getDoc(doc(db, "users", user.email));
            if (userDoc.exists()) {
                const userData = userDoc.data();
                currentUser = userData; userRole = userData.role;
                document.getElementById('welcomeUser').innerText = userData.name.split(' ')[0];
                
                // Profil verilerini doldur
                document.getElementById('profileName').innerText = userData.name;
                document.getElementById('profileRole').innerText = userData.title || (userData.role === 'admin' ? 'Y√∂netici' : 'Personel');
                document.getElementById('profileAvatar').innerText = userData.name.charAt(0);

                applyPermissions();
                document.getElementById('reportDateSelector').value = currentReportDate;
                startListeners();
            } else {
                alert("Kullanƒ±cƒ± kaydƒ±nƒ±z bulunamadƒ±.");
                signOut(auth).then(()=> window.location.href="login.html");
            }
        } else {
            window.location.href = "login.html";
        }
    });

    window.handleLogout = () => { signOut(auth).then(() => { window.location.href = "login.html"; }); };

    function applyPermissions() {
        document.querySelectorAll('.admin-only').forEach(el => el.style.display = (userRole === 'admin') ? 'block' : 'none');
        document.querySelectorAll('.nav-item.admin-only').forEach(el => el.style.display = (userRole === 'admin') ? 'flex' : 'none');
    }

    // --- TOAST MSG ---
    window.showToast = (msg, type = "success") => {
        const t = document.getElementById("toast-container");
        t.innerText = msg;
        t.className = type === "success" ? "toast-success" : "toast-error";
        t.style.display = "block";
        setTimeout(() => { t.style.display = "none"; }, 3000);
    }

    function startListeners() {
        const load = (col, arr, cb) => onSnapshot(collection(db, col), (s) => { 
            arr.length=0; s.docs.forEach(d=>arr.push({id:d.id, ...d.data()})); 
            if(cb) cb(); loadDropdowns();
        });
        load("projects", projects, renderProjects);
        load("vehicles", vehicles, renderVehicleList);
        load("devices", devices, renderDeviceList);
        onSnapshot(collection(db, "users"), (s) => { users=[]; s.docs.forEach(d=>users.push(d.data())); renderTeamStatus(); renderUserList(); loadDropdowns(); });
        
        const logsQuery = query(collection(db, "logs"), orderBy("date", "desc"), limit(500));
        onSnapshot(logsQuery, (s) => { logs = []; s.docs.forEach(d => logs.push(d.data())); filterReports(); });

        onSnapshot(collection(db, "tasks"), (snapshot) => {
            tasks=[]; snapshot.docs.forEach(d=>tasks.push({id:d.id, ...d.data()}));
            renderCalendar();
            if(document.querySelector('#taskModal').style.display === 'flex') openModalLogic(selectedDateStr);
            updateStats(new Date().toISOString().split('T')[0]); renderTeamStatus(); renderDeviceList(); renderVehicleList(); filterReports();
        });

        // --- Kƒ∞≈ûƒ∞SEL Bƒ∞LDƒ∞Rƒ∞MLERƒ∞ Dƒ∞NLEME ---
        const notifQuery = query(collection(db, "notifications"), where("target", "==", currentUser.name));
        onSnapshot(notifQuery, (s) => {
            notifications = [];
            s.docs.forEach(d => notifications.push({id:d.id, ...d.data()}));
            notifications.sort((a,b) => new Date(b.date) - new Date(a.date));
            renderNotifications();
        });
    }

    // --- PROFƒ∞L & ≈ûƒ∞FRE DEƒûƒ∞≈ûTƒ∞RME ---
    window.updateUserPassword = async () => {
        const p1 = document.getElementById('new-pass').value;
        const p2 = document.getElementById('new-pass-confirm').value;
        
        if(p1.length < 6) return showToast("≈ûifre en az 6 karakter olmalƒ±", "error");
        if(p1 !== p2) return showToast("≈ûifreler e≈üle≈ümiyor", "error");

        try {
            await updatePassword(auth.currentUser, p1);
            showToast("≈ûifre ba≈üarƒ±yla g√ºncellendi!", "success");
            document.getElementById('new-pass').value = "";
            document.getElementById('new-pass-confirm').value = "";
        } catch(e) {
            console.error(e);
            showToast("Hata: " + e.message, "error");
            if(e.code === 'auth/requires-recent-login') {
                alert("G√ºvenlik nedeniyle ≈üifre deƒüi≈ütirmek i√ßin yeniden giri≈ü yapmalƒ±sƒ±nƒ±z.");
                handleLogout();
            }
        }
    }

    // --- ADMIN LOG Y√ñNETƒ∞Mƒ∞ ---
    window.renderAdminLogs = (dateVal) => {
        const tbody = document.getElementById('adminLogBody');
        if(!dateVal) { tbody.innerHTML = '<tr><td colspan="4">Tarih se√ßiniz.</td></tr>'; return; }
        
        const filtered = logs.filter(l => l.date.startsWith(dateVal));
        if(filtered.length === 0) { tbody.innerHTML = '<tr><td colspan="4">Kayƒ±t yok.</td></tr>'; return; }

        tbody.innerHTML = filtered.map(l => {
            const d = new Date(l.date);
            const time = `${d.getHours()}:${d.getMinutes()}`;
            return `<tr><td>${time}</td><td>${l.admin || 'Sistem'}</td><td>${l.action}</td><td>${l.person} - ${l.item}</td></tr>`;
        }).join('');
    }

    window.exportLogsToWord = () => {
        const dateVal = document.getElementById('adminLogDate').value;
        if(!dateVal) return alert("√ñnce tarih se√ßiniz.");
        
        const html = document.getElementById('adminLogTable').outerHTML;
        const blob = new Blob(['<html><head><meta charset="UTF-8"></head><body>' + html + '</body></html>'], {
            type: 'application/msword'
        });
        
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `Gunluk_Log_${dateVal}.doc`;
        a.click();
    }

    // --- WHATSAPP Bƒ∞LDƒ∞Rƒ∞M Sƒ∞STEMƒ∞ (MOBƒ∞L UYUMLU & KURUMSAL) ---
    async function notifyUser(personName, message) {
        // 1. Firebase'e Kaydet (Uygulama ƒ∞√ßi Bildirim - √ñzet)
        try {
            // Firebase'e sadece kƒ±sa √∂zet kaydediyoruz
            const shortMsg = message.includes("Yeni G√∂rev") ? "Yeni g√∂rev atandƒ±. Detaylar i√ßin tƒ±klayƒ±n." : (message.includes("iade") ? "Zimmet iade alƒ±ndƒ±." : message);
            await addDoc(collection(db, "notifications"), {
                target: personName,
                msg: shortMsg,
                date: new Date().toISOString(),
                read: false
            });
        } catch(e) { console.error("Bildirim DB hatasƒ±", e); }

        // 2. WhatsApp'ƒ± A√ß (Mobilde √áalƒ±≈üan Y√∂ntem: api.whatsapp.com)
        const user = users.find(u => u.name === personName);
        if(user && user.phone) {
            let phone = user.phone.replace(/\D/g,''); 
            // URL Encode ederek mesajƒ± linke √ßevir
            const url = `https://api.whatsapp.com/send?phone=${phone}&text=${encodeURIComponent(message)}`;
            
            // Mobilde 'popup blocked' olmamasƒ± i√ßin window.open
            window.open(url, '_blank');
        } else {
            showToast(`${personName} i√ßin tel no yok.`, "error");
        }
    }

    // Bildirim Aray√ºz√º ƒ∞≈ülemleri
    window.toggleNotifications = () => {
        const drop = document.getElementById('notification-dropdown');
        drop.style.display = drop.style.display === 'block' ? 'none' : 'block';
    }

    document.addEventListener('click', function(event) {
        const drop = document.getElementById('notification-dropdown');
        const btn = document.querySelector('.icon-btn[onclick="toggleNotifications()"]');
        if (drop.style.display === 'block' && !drop.contains(event.target) && !btn.contains(event.target)) {
            drop.style.display = 'none';
        }
    });

    function renderNotifications() {
        const list = document.getElementById('notif-list');
        const badge = document.getElementById('notif-badge');
        
        if(notifications.length > 0) {
            badge.innerText = notifications.length;
            badge.style.display = 'flex';
        } else {
            badge.style.display = 'none';
        }

        if(notifications.length === 0) {
            list.innerHTML = '<div class="notif-empty">Bildirim yok.</div>';
            return;
        }

        list.innerHTML = notifications.map(n => {
            const d = new Date(n.date);
            const timeStr = `${d.getDate()}.${d.getMonth()+1} ${d.getHours()}:${d.getMinutes().toString().padStart(2,'0')}`;
            return `
            <div class="notif-item">
                ${n.msg}
                <small>${timeStr}</small>
            </div>
            `;
        }).join('');
    }

    window.clearAllNotifications = async () => {
        if(notifications.length === 0) return;
        if(!confirm("T√ºm bildirimler silinsin mi?")) return;
        const batch = writeBatch(db);
        notifications.forEach(n => {
            const ref = doc(db, "notifications", n.id);
            batch.delete(ref);
        });
        await batch.commit();
        showToast("Bildirimler temizlendi.");
    }

    // --- MEVCUT FONKSƒ∞YONLAR ---

    window.filterList = (input, listId, itemTag) => {
        const filter = input.value.toLowerCase();
        const list = document.getElementById(listId);
        const items = list.querySelectorAll(itemTag);
        items.forEach(item => {
            const text = item.textContent || item.innerText;
            item.style.display = text.toLowerCase().indexOf(filter) > -1 ? "" : "none";
        });
    }

    window.exportExcel = () => {
        if (typeof XLSX === 'undefined') return alert("Excel k√ºt√ºphanesi y√ºklenemedi. ƒ∞nternet baƒülantƒ±nƒ±zƒ± kontrol edin.");
        const [year, month] = currentReportDate.split('-').map(Number);
        const reportData = [];
        users.forEach(u => {
            let days = 0;
            tasks.forEach(t => {
                let start = new Date(t.startDate || parseDateStr(t.date));
                let end = new Date(t.endDate || parseDateStr(t.date));
                let loop = new Date(start);
                while(loop <= end) {
                    if (loop.getFullYear() === year && loop.getMonth() === (month - 1)) {
                         if (Array.isArray(t.person)) { if(t.person.includes(u.name)) days++; }
                         else if(t.person === u.name) days++;
                    }
                    loop.setDate(loop.getDate() + 1);
                }
            });
            reportData.push({ "Personel": u.name, "√áalƒ±≈üma G√ºn√º": days });
        });
        const ws = XLSX.utils.json_to_sheet(reportData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Efor");
        XLSX.writeFile(wb, `Personel_Efor_${currentReportDate}.xlsx`);
    }

    async function addLog(type, item, action, person) {
        await addDoc(collection(db, "logs"), { date: new Date().toISOString(), type: type, item: item, action: action, person: person, admin: currentUser.name });
    }
    window.setReportFilter = (filter, btn) => { currentReportFilter = filter; document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); filterReports(); }
    window.filterReports = () => { currentReportDate = document.getElementById('reportDateSelector').value; renderLogs(); renderPersonnelReport(); }
    
    function renderLogs() {
        const table = document.getElementById('logTable');
        const filteredLogs = logs.filter(l => {
            const logMonth = l.date.substring(0, 7); const typeMatch = currentReportFilter === 'all' || l.type === currentReportFilter;
            return logMonth === currentReportDate && typeMatch;
        });
        if (filteredLogs.length === 0) { table.innerHTML = '<tr><td>Kayƒ±t yok.</td></tr>'; return; }
        table.innerHTML = filteredLogs.map(l => {
            const d = new Date(l.date);
            const dateStr = `${d.getDate()}.${d.getMonth()+1} ${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}`;
            const actionClass = l.action === 'take' ? 'action-take' : 'action-return';
            const actionText = l.action === 'take' ? 'Aldƒ±' : 'Verdi';
            const icon = l.type === 'vehicle' ? 'üöó' : 'üß∞';
            return `<tr><td><span class="log-date">${dateStr}</span></td><td>${icon} <strong>${l.person}</strong><br>${l.item} <span class="log-action ${actionClass}">${actionText}</span></td></tr>`;
        }).join('');
    }
    function renderPersonnelReport() {
        const [year, month] = currentReportDate.split('-').map(Number);
        const reportData = {}; users.forEach(u => reportData[u.name] = 0);
        tasks.forEach(t => {
            let start = new Date(t.startDate || parseDateStr(t.date));
            let end = new Date(t.endDate || parseDateStr(t.date));
            let loop = new Date(start);
            while(loop <= end) {
                if (loop.getFullYear() === year && loop.getMonth() === (month - 1)) {
                    if (Array.isArray(t.person)) t.person.forEach(p => { if(reportData[p] !== undefined) reportData[p]++; });
                    else if(reportData[t.person] !== undefined) reportData[t.person]++;
                }
                loop.setDate(loop.getDate() + 1);
            }
        });
        document.getElementById('personnelReportBody').innerHTML = Object.keys(reportData).map(key => `<tr><td>${key}</td><td style="font-weight:bold;">${reportData[key]} G√ºn</td></tr>`).join('');
    }

    window.openCustodyModal = (type, id, name, extra) => {
        custodyType = type; custodyTargetId = id;
        document.getElementById('custodyItemName').innerText = `${name} (${extra||''})`;
        document.getElementById('c-person').innerHTML = users.map(u => `<option value="${u.name}">${u.name}</option>`).join('');
        document.getElementById('custodyModal').style.display = 'flex';
    }
    window.closeCustodyModal = () => document.getElementById('custodyModal').style.display = 'none';
    
    // Zƒ∞MMET KAYDI G√úNCELLENDƒ∞: Bƒ∞LDƒ∞Rƒ∞M EKLENDƒ∞
    window.saveCustody = async () => {
        try {
            const person = document.getElementById('c-person').value;
            const collectionName = custodyType === 'vehicle' ? 'vehicles' : 'devices';
            await updateDoc(doc(db, collectionName, custodyTargetId), { currentHolder: person });
            const itemName = document.getElementById('custodyItemName').innerText;
            await addLog(custodyType, itemName, 'take', person);
            
            // Bƒ∞LDƒ∞Rƒ∞M METNƒ∞ OLU≈ûTUR
            const msg = `*Sayƒ±n ${person},*\n\nTarafƒ±nƒ±za yeni bir zimmet atamasƒ± yapƒ±lmƒ±≈ütƒ±r.\n\nüì¶ *Zimmet:* ${itemName}\nüìÖ *Tarih:* ${new Date().toLocaleDateString('tr-TR')}\n\nL√ºtfen malzemeyi kontrol ediniz.`;
            notifyUser(person, msg);
            
            showToast("Zimmet Ba≈üarƒ±lƒ±", "success");
            closeCustodyModal();
        } catch(e) { showToast("Hata olu≈ütu", "error"); }
    }
    window.returnItem = async (type, id) => {
        if(confirm("ƒ∞ade?")) {
            try {
                const collectionName = type === 'vehicle' ? 'vehicles' : 'devices';
                let prevHolder = "Bilinmiyor";
                const itemDoc = type === 'vehicle' ? vehicles.find(v=>v.id===id) : devices.find(d=>d.id===id);
                if(itemDoc) prevHolder = itemDoc.currentHolder;
                await updateDoc(doc(db, collectionName, id), { currentHolder: null });
                let itemDetail = itemDoc ? (type==='vehicle' ? `${itemDoc.plate}` : `${itemDoc.name}`) : '';
                await addLog(type, itemDetail, 'return', prevHolder);
                
                // ƒ∞ADE Bƒ∞LDƒ∞Rƒ∞Mƒ∞ G√ñNDER
                if(prevHolder && prevHolder !== "Bilinmiyor") {
                    const itemLabel = type === 'vehicle' ? 'Ara√ß' : 'Cihaz';
                    const msg = `*Sayƒ±n ${prevHolder},*\n\n√úzerinizde bulunan zimmet iade alƒ±nmƒ±≈ütƒ±r.\n\nüì¶ *Tip:* ${itemLabel}\nüÜî *Detay:* ${itemDetail}\nüìÖ *Tarih:* ${new Date().toLocaleDateString('tr-TR')}\n\nSistemden d√º≈ü√ºm√º yapƒ±lmƒ±≈ütƒ±r.`;
                    notifyUser(prevHolder, msg);
                }

                showToast("ƒ∞ade Alƒ±ndƒ±", "success");
            } catch(e) { showToast("Hata olu≈ütu", "error"); }
        }
    }

    function setMultiSelectValues(id, values) {
        const inputs = document.querySelectorAll(`#${id} input`);
        inputs.forEach(input => {
            input.checked = values.includes(input.value);
        });
    }

    window.editTask = (id) => {
        const t = tasks.find(x => x.id === id);
        if(!t) return;
        editingTaskId = id;
        document.getElementById('taskFormTitle').innerText = "G√∂revi D√ºzenle";
        document.getElementById('btn-save-task').innerText = "G√ºncelle";
        document.getElementById('btn-cancel-task').style.display = "block";
        document.getElementById('btn-save-task').style.background = "#f39c12"; 
        document.getElementById('t-start-date').value = t.startDate || "";
        document.getElementById('t-end-date').value = t.endDate || "";
        document.getElementById('t-project-select').value = t.projectId || "";
        document.getElementById('t-loc').value = t.location || "";
        setMultiSelectValues('ms-person', Array.isArray(t.person) ? t.person : [t.person]);
        setMultiSelectValues('ms-device', Array.isArray(t.device) ? t.device : [t.device]);
        setMultiSelectValues('ms-plate', Array.isArray(t.plate) ? t.plate : [t.plate]);
    }

    window.cancelTaskEdit = () => {
        editingTaskId = null;
        document.getElementById('taskFormTitle').innerText = "Yeni Atama";
        document.getElementById('btn-save-task').innerText = "Kaydet";
        document.getElementById('btn-save-task').style.background = ""; 
        document.getElementById('btn-cancel-task').style.display = "none";
        document.getElementById('t-loc').value = "";
        document.getElementById('t-project-select').value = "";
        document.querySelectorAll('.multi-select-area input').forEach(c => c.checked = false);
        document.getElementById('t-start-date').value = selectedDateStr;
        document.getElementById('t-end-date').value = selectedDateStr;
    }

    // G√ñREV KAYDI G√úNCELLENDƒ∞: DETAYLI Bƒ∞LDƒ∞Rƒ∞M
    window.saveTask = async () => {
        const btn = document.getElementById('btn-save-task');
        btn.disabled = true; 
        try {
            const per = getMultiSelectValues('ms-person'), dev = getMultiSelectValues('ms-device'), plate = getMultiSelectValues('ms-plate');
            const projVal = document.getElementById('t-project-select').value;
            const sDate = document.getElementById('t-start-date').value;
            const eDate = document.getElementById('t-end-date').value;
            const loc = document.getElementById('t-loc').value;

            if(!projVal || per.length===0 || !sDate || !eDate) {
                showToast("Eksik bilgi: Personel, Proje ve Tarih se√ßiniz.", "error");
                btn.disabled = false; return;
            }
            if(sDate > eDate) {
                showToast("Ba≈ülangƒ±√ß tarihi biti≈üten b√ºy√ºk olamaz.", "error");
                btn.disabled = false; return;
            }

            let conflictMsg = "";
            dev.forEach(dName => {
                const deviceObj = devices.find(d => d.name === dName);
                if (deviceObj && deviceObj.currentHolder && !per.includes(deviceObj.currentHolder)) {
                    conflictMsg += `‚ö†Ô∏è ${dName} cihazƒ± ${deviceObj.currentHolder} zimmetinde!\n`;
                }
            });
            if (conflictMsg && !confirm(`Dƒ∞KKAT:\n${conflictMsg}\nYine de devam et?`)) {
                btn.disabled = false; return;
            }

            const projName = document.getElementById('t-project-select').options[document.getElementById('t-project-select').selectedIndex].text;
            const taskData = { 
                startDate: sDate, 
                endDate: eDate, 
                person: per, 
                projectName: projName, 
                projectId: projVal, 
                location: loc, 
                device: dev, 
                plate: plate 
            };

            if (editingTaskId) {
                await updateDoc(doc(db, "tasks", editingTaskId), taskData);
                showToast("G√∂rev g√ºncellendi!", "success");
                cancelTaskEdit(); 
            } else {
                await addDoc(collection(db, "tasks"), taskData);
                showToast("G√∂rev atandƒ±!", "success");
                
                // KURUMSAL MESAJI OLU≈ûTUR
                const teamStr = per.join(", ");
                const platesStr = plate.length > 0 ? plate.join(", ") : "Yok";
                const devStr = dev.length > 0 ? dev.join(", ") : "Yok";
                const dateRange = `${sDate.split('-').reverse().join('.')} - ${eDate.split('-').reverse().join('.')}`;
                const appLink = "https://yavuzdalgic18.github.io/EkipTakipApp/"; // Uygulama linki

                per.forEach(pName => {
                    const msg = `*Sayƒ±n ${pName},*\n\nA≈üaƒüƒ±daki detaylara sahip yeni bir g√∂reve atandƒ±nƒ±z.\n\nüìÇ *Proje:* ${projName}\nüìç *Konum:* ${loc}\nüìÖ *Tarih:* ${dateRange}\n\nüë• *Ekip:* ${teamStr}\nüöó *Ara√ßlar:* ${platesStr}\nüß∞ *Ekipman:* ${devStr}\n\nDetaylar ve i≈ülem yapmak i√ßin uygulamayƒ± kontrol ediniz:\nüîó ${appLink}`;
                    
                    notifyUser(pName, msg);
                });

                document.getElementById('t-loc').value=""; 
                document.querySelectorAll('.multi-select-area input').forEach(c=>c.checked=false);
            }
        } catch (error) {
            console.error(error);
            showToast("Hata: " + error.message, "error");
        } finally {
            btn.disabled = false; 
        }
    }
    
    window.delTask = async (id) => { 
        if(confirm("Silmek istiyor musunuz?")) {
            try { await deleteDoc(doc(db, "tasks", id)); showToast("Silindi.", "success"); } 
            catch(e) { showToast("Silinemedi.", "error"); }
        } 
    }

    window.addVehicle=async()=>{const p=document.getElementById('v-plate').value; if(!p)return; await addDoc(collection(db,"vehicles"),{plate:p,info:document.getElementById('v-info').value,inspectionDate:document.getElementById('v-inspection').value,currentHolder:null}); showToast("Ara√ß Eklendi"); resetVehicleForm();}
    window.updateVehicleDB=async()=>{await updateDoc(doc(db,"vehicles",editingVehicleId),{plate:document.getElementById('v-plate').value,info:document.getElementById('v-info').value,inspectionDate:document.getElementById('v-inspection').value}); showToast("Ara√ß G√ºncellendi"); resetVehicleForm();}
    window.editVehicle=(id)=>{const v=vehicles.find(x=>x.id===id); if(!v)return; document.getElementById('v-plate').value=v.plate; document.getElementById('v-info').value=v.info; document.getElementById('v-inspection').value=v.inspectionDate||""; editingVehicleId=id; document.getElementById('vehicleFormTitle').innerText="D√ºzenle"; document.getElementById('btn-v-save').style.display='none'; document.getElementById('btn-v-update').style.display='block'; document.getElementById('btn-v-cancel').style.display='block';}
    window.cancelVehicleEdit=resetVehicleForm;
    function resetVehicleForm(){editingVehicleId=null; document.getElementById('v-plate').value=""; document.getElementById('v-info').value=""; document.getElementById('v-inspection').value=""; document.getElementById('vehicleFormTitle').innerText="Yeni Ara√ß Ekle"; document.getElementById('btn-v-save').style.display='block'; document.getElementById('btn-v-update').style.display='none'; document.getElementById('btn-v-cancel').style.display='none';}
    window.deleteVehicle=async(id)=>{if(confirm("Sil?")) { await deleteDoc(doc(db,"vehicles",id)); showToast("Silindi"); }}
    
    // YENƒ∞LENEN ARA√á Lƒ∞STELEME FONKSƒ∞YONU (G√ñREV DURUMU EKLENDƒ∞)
    function renderVehicleList(){
        const todayISO = new Date().toISOString().split('T')[0];
        document.getElementById('vehicleListArea').innerHTML = vehicles.map(v => { 
            let inspHtml = v.inspectionDate ? (new Date(v.inspectionDate) < new Date() ? `<small style="color:red; display:block;">‚ö†Ô∏è Muayene: ${v.inspectionDate}</small>` : `<small style="color:#666;">üìÖ Muayene: ${v.inspectionDate}</small>`) : ""; 
            
            let statusBadge = `<span class="badge badge-green">BO≈ûTA</span>`;
            let zimmetHtml = ""; 

            if(v.currentHolder) { 
                statusBadge = `<span class="badge badge-orange">üë§ ${v.currentHolder}</span>`; 
                if(userRole==='admin') zimmetHtml = `<button class="btn-sm btn-outline-red" onclick="returnItem('vehicle','${v.id}')">ƒ∞ade Al</button>`; 
            } else if(userRole==='admin') { 
                zimmetHtml = `<button class="btn-sm btn-outline-blue" onclick="openCustodyModal('vehicle','${v.id}','${v.plate}','${v.info}')">Zimmetle</button>`; 
            } 

            // G√ñREVDE Mƒ∞ KONTROL√ú
            const at = tasks.find(t => {
                const s = t.startDate || parseDateStr(t.date).toISOString().split('T')[0];
                const e = t.endDate || parseDateStr(t.date).toISOString().split('T')[0];
                const inRange = todayISO >= s && todayISO <= e;
                const hasPlate = Array.isArray(t.plate) ? t.plate.includes(v.plate) : t.plate === v.plate;
                return inRange && hasPlate;
            });

            if(at) statusBadge += ` <span class="badge badge-red" style="margin-left:5px">G√ñREVDE</span>`;

            return `<div class="info-card ${v.currentHolder?'custody':'active'}"><div class="info-card-header"><div><strong>${v.plate}</strong><br><small>${v.info}</small>${inspHtml}</div>${userRole==='admin' ? `<div><button onclick="editVehicle('${v.id}')" style="border:none; bg:none; font-size:1.1rem;">‚úé</button><button onclick="deleteVehicle('${v.id}')" style="color:red; border:none; bg:none; font-size:1.1rem;">üóë</button></div>` : ''}</div><div style="display:flex; justify-content:space-between; align-items:center; margin-top:5px;">${statusBadge}${zimmetHtml}</div></div>`; 
        }).join('');
    }

    window.addDevice=async()=>{const n=document.getElementById('d-name').value; if(!n)return; await addDoc(collection(db,"devices"),{name:n,serial:document.getElementById('d-serial').value,calib:document.getElementById('d-calib').value,currentHolder:null}); showToast("Cihaz Eklendi"); document.getElementById('d-name').value="";}
    window.updateDeviceDB=async()=>{await updateDoc(doc(db,"devices",editingDeviceId),{name:document.getElementById('d-name').value,serial:document.getElementById('d-serial').value,calib:document.getElementById('d-calib').value}); showToast("G√ºncellendi"); resetDeviceForm();}
    window.editDevice=(id)=>{const d=devices.find(x=>x.id===id); if(!d)return; document.getElementById('d-name').value=d.name; document.getElementById('d-serial').value=d.serial; document.getElementById('d-calib').value=d.calib||""; editingDeviceId=id; document.getElementById('deviceFormTitle').innerText="D√ºzenle"; document.getElementById('btn-d-save').style.display='none'; document.getElementById('btn-d-update').style.display='block'; document.getElementById('btn-d-cancel').style.display='block';}
    window.cancelDeviceEdit=resetDeviceForm;
    function resetDeviceForm(){editingDeviceId=null; document.getElementById('d-name').value=""; document.getElementById('d-serial').value=""; document.getElementById('d-calib').value=""; document.getElementById('deviceFormTitle').innerText="Yeni Cihaz Ekle"; document.getElementById('btn-d-save').style.display='block'; document.getElementById('btn-d-update').style.display='none'; document.getElementById('btn-d-cancel').style.display='none';}
    window.deleteDevice=async(id)=>{if(confirm("Sil?")) { await deleteDoc(doc(db,"devices",id)); showToast("Silindi"); }}
    function renderDeviceList(){
        const todayISO = new Date().toISOString().split('T')[0];
        document.getElementById('deviceListArea').innerHTML = devices.map(d => { 
            let statusBadge = `<span class="badge badge-green">BO≈ûTA</span>`, zimmetHtml = ""; 
            if(d.currentHolder) { 
                statusBadge = `<span class="badge badge-orange">üë§ ${d.currentHolder}</span>`; 
                if(userRole==='admin') zimmetHtml = `<button class="btn-sm btn-outline-red" onclick="returnItem('device','${d.id}')">ƒ∞ade Al</button>`; 
            } else if(userRole==='admin') { 
                zimmetHtml = `<button class="btn-sm btn-outline-blue" onclick="openCustodyModal('device','${d.id}','${d.name}', '${d.serial}')">Zimmetle</button>`; 
            } 
            const at = tasks.find(t => {
                const s = t.startDate || parseDateStr(t.date).toISOString().split('T')[0];
                const e = t.endDate || parseDateStr(t.date).toISOString().split('T')[0];
                const inRange = todayISO >= s && todayISO <= e;
                const hasDev = Array.isArray(t.device) ? t.device.includes(d.name) : t.device === d.name;
                return inRange && hasDev;
            });
            if(at) statusBadge += ` <span class="badge badge-red" style="margin-left:5px">G√ñREVDE</span>`; 
            let calibHtml = d.calib ? `<br><small style="color:${new Date(d.calib) < new Date() ? 'red' : '#666'}">Kalibrasyon: ${d.calib}</small>` : ""; 
            return `<div class="info-card ${d.currentHolder?'custody':'active'}"><div class="info-card-header"><div><strong>${d.name}</strong> <small>(${d.serial})</small>${calibHtml}</div>${userRole==='admin' ? `<div><button onclick="editDevice('${d.id}')" style="border:none; bg:none; font-size:1.1rem;">‚úé</button><button onclick="deleteDevice('${d.id}')" style="color:red; border:none; bg:none; font-size:1.1rem;">üóë</button></div>` : ''}</div><div style="display:flex; justify-content:space-between; align-items:center; margin-top:5px;">${statusBadge}${zimmetHtml}</div></div>`; 
        }).join('');
    }

    window.addUserToDB=async()=>{const n=document.getElementById('u-name').value; const e=document.getElementById('u-email').value.trim(); const r=document.getElementById('u-role').value; const t=document.getElementById('u-title').value; const ph=document.getElementById('u-phone').value; if(!n || !e) return alert("Ad ve E-posta zorunludur."); await setDoc(doc(db,"users",e), {name:n, email:e, role:r, title:t, phone:ph}); showToast("Yetkili Eklendi"); cancelUserEdit();}
    window.editUser=(e)=>{const u=users.find(x=>x.email===e); if(!u)return; document.getElementById('u-name').value=u.name; document.getElementById('u-title').value=u.title||''; document.getElementById('u-email').value=u.email; document.getElementById('u-email').disabled=true; document.getElementById('u-phone').value=u.phone||''; document.getElementById('u-role').value=u.role; editingUserEmail=e; document.getElementById('userFormTitle').innerText="D√ºzenle"; document.getElementById('btn-user-add').style.display='none'; document.getElementById('btn-user-update').style.display='block'; document.getElementById('btn-user-cancel').style.display='block';}
    window.updateUserDB=async()=>{await updateDoc(doc(db,"users",editingUserEmail),{name:document.getElementById('u-name').value,title:document.getElementById('u-title').value,role:document.getElementById('u-role').value,phone:document.getElementById('u-phone').value}); showToast("Kullanƒ±cƒ± G√ºncellendi"); cancelUserEdit();}
    window.cancelUserEdit=()=>{editingUserEmail=null; document.getElementById('u-name').value=""; document.getElementById('u-title').value=""; document.getElementById('u-email').value=""; document.getElementById('u-phone').value=""; document.getElementById('u-email').disabled=false; document.getElementById('userFormTitle').innerText="Yeni Kullanƒ±cƒ±"; document.getElementById('btn-user-add').style.display='block'; document.getElementById('btn-user-update').style.display='none'; document.getElementById('btn-user-cancel').style.display='none';}
    window.deleteUser=async(e)=>{if(confirm("Sil?")) { await deleteDoc(doc(db,"users",e)); showToast("Kullanƒ±cƒ± Silindi"); }}
    function renderUserList(){document.getElementById('userListArea').innerHTML=users.map(u=>`<div class="user-card" style="padding:10px; border-bottom:1px solid #eee; display:flex; justify-content:space-between;"><div><strong>${u.name}</strong> <small>(${u.title||''})</small><br><small>${u.email}</small><br><small>üìû ${u.phone||'-'}</small></div><div><span class="badge badge-gray">${u.role}</span>${userRole==='admin' ? `<button onclick="editUser('${u.email}')" style="border:none; bg:none; margin-right:5px;">‚úé</button><button onclick="deleteUser('${u.email}')" style="color:red; border:none; bg:none;">üóë</button>` : ''}</div></div>`).join('');}
    
    window.submitProject=async()=>{const n=document.getElementById('p-name').value; if(!n)return; await addDoc(collection(db,"projects"),{name:n,manager:document.getElementById('p-manager').value,start:document.getElementById('p-start').value,end:document.getElementById('p-end').value,cost:document.getElementById('p-cost').value,offer:document.getElementById('p-offer').value}); showToast("Proje Eklendi"); document.getElementById('p-name').value="";}
    window.updateProjectDB=async()=>{await updateDoc(doc(db,"projects",editingProjectId),{name:document.getElementById('p-name').value,manager:document.getElementById('p-manager').value,start:document.getElementById('p-start').value,end:document.getElementById('p-end').value,cost:document.getElementById('p-cost').value,offer:document.getElementById('p-offer').value}); showToast("Proje G√ºncellendi"); cancelProjectEdit();}
    window.editProject=(id)=>{const p=projects.find(x=>x.id===id); if(!p)return; document.getElementById('p-name').value=p.name; document.getElementById('p-manager').value=p.manager; document.getElementById('p-start').value=p.start||""; document.getElementById('p-end').value=p.end||""; document.getElementById('p-cost').value=p.cost; document.getElementById('p-offer').value=p.offer; editingProjectId=id; document.getElementById('projectFormTitle').innerText="Proje D√ºzenle"; document.getElementById('btn-p-save').style.display='none'; document.getElementById('btn-p-update').style.display='block'; document.getElementById('btn-p-cancel').style.display='block';}
    window.cancelProjectEdit=()=>{editingProjectId=null; document.getElementById('p-name').value=""; document.getElementById('p-cost').value=""; document.getElementById('p-offer').value=""; document.getElementById('p-start').value=""; document.getElementById('p-end').value=""; document.getElementById('projectFormTitle').innerText="Yeni Proje"; document.getElementById('btn-p-save').style.display='block'; document.getElementById('btn-p-update').style.display='none'; document.getElementById('btn-p-cancel').style.display='none';}
    window.deleteProject=async(id)=>{if(confirm("Sil?")) { await deleteDoc(doc(db,"projects",id)); showToast("Silindi"); }}
    function renderProjects(){document.getElementById('projectListBody').innerHTML=projects.map(p=>{const pf=p.offer-p.cost; return `<div style="padding:15px; border-bottom:1px solid #eee;"><strong>${p.name}</strong> (${p.start||'-'} / ${p.end||'?'})<br><small>${p.manager||'-'} | Kar: ${pf}</small> ${userRole==='admin' ? `<div style="float:right;"><button onclick="editProject('${p.id}')" style="border:none; bg:none; font-size:1.1rem;">‚úé</button><button onclick="deleteProject('${p.id}')" style="color:red; border:none; bg:none; font-size:1.1rem;">üóë</button></div>` : ''}</div>`;}).join('');}
    
    function renderTeamStatus(){
        const todayStr=new Date().toISOString().split('T')[0];
        document.getElementById('teamListArea').innerHTML=users.map(u=>{
            const at = tasks.find(t => {
                const s = t.startDate || parseDateStr(t.date).toISOString().split('T')[0];
                const e = t.endDate || parseDateStr(t.date).toISOString().split('T')[0];
                const inRange = todayStr >= s && todayStr <= e;
                const hasPerson = Array.isArray(t.person) ? t.person.includes(u.name) : t.person === u.name;
                return inRange && hasPerson;
            });
            let statusHtml=at?`<div class="badge badge-green">SAHADA</div>`:`<div class="badge badge-gray">BO≈ûTA</div>`;
            const upcoming = tasks.filter(t => (t.startDate || parseDateStr(t.date).toISOString().split('T')[0]) > todayStr && (Array.isArray(t.person) ? t.person.includes(u.name) : t.person === u.name)).sort((a,b) => (a.startDate||a.date).localeCompare(b.startDate||b.date))[0];
            let futureHtml = upcoming ? `<small style="color:#e67e22; display:block; margin-top:5px;">üìÖ Sonraki: ${upcoming.startDate || upcoming.date} - ${upcoming.projectName}</small>` : '';
            return `<div class="person-row"><div style="display:flex; align-items:center;"><div class="avatar" style="margin-right:10px;">${u.name.charAt(0)}</div><div><div style="font-weight:600;">${u.name}</div><small>${u.title||''}</small>${futureHtml}</div></div>${statusHtml}</div>`;
        }).join('');
    }

    function updateStats(todayISO){
        let activeSet = new Set();
        tasks.forEach(t => {
            const s = t.startDate || parseDateStr(t.date).toISOString().split('T')[0];
            const e = t.endDate || parseDateStr(t.date).toISOString().split('T')[0];
            if (todayISO >= s && todayISO <= e) {
                if(Array.isArray(t.person)) t.person.forEach(p=>activeSet.add(p)); else activeSet.add(t.person);
            }
        });
        document.getElementById('stat-total').innerText=users.length; 
        document.getElementById('stat-active').innerText=activeSet.size; 
        document.getElementById('stat-idle').innerText=Math.max(0,users.length-activeSet.size);
    }

    function loadDropdowns(){
        if(document.getElementById('p-manager')) document.getElementById('p-manager').innerHTML=users.map(u=>`<option>${u.name}</option>`).join('');
        if(document.getElementById('t-project-select')) document.getElementById('t-project-select').innerHTML=`<option value="">Se√ß</option>`+projects.map(p=>`<option value="${p.id}">${p.name}</option>`).join('');
        if(document.getElementById('c-person')) document.getElementById('c-person').innerHTML=users.map(u=>`<option value="${u.name}">${u.name}</option>`).join('');
        const fillMulti=(id,arr,k)=>{const el=document.getElementById(id);if(el)el.innerHTML=arr.map(i=>`<div class="ms-item"><input type="checkbox" value="${i[k]}">${i[k]}</div>`).join('')};
        fillMulti('ms-person',users,'name'); fillMulti('ms-device',devices,'name'); fillMulti('ms-plate',vehicles,'plate');
    }
    function getMultiSelectValues(id){return Array.from(document.querySelectorAll(`#${id} input:checked`)).map(i=>i.value);}
    
    // DRAG AND SCROLL √ñZELLƒ∞ƒûƒ∞ (YENƒ∞)
    const nav = document.querySelector('.bottom-nav');
    let isDown = false;
    let startX;
    let scrollLeft;

    nav.addEventListener('mousedown', (e) => {
        isDown = true;
        nav.classList.add('active');
        startX = e.pageX - nav.offsetLeft;
        scrollLeft = nav.scrollLeft;
    });
    nav.addEventListener('mouseleave', () => {
        isDown = false;
        nav.classList.remove('active');
    });
    nav.addEventListener('mouseup', () => {
        isDown = false;
        nav.classList.remove('active');
    });
    nav.addEventListener('mousemove', (e) => {
        if(!isDown) return;
        e.preventDefault();
        const x = e.pageX - nav.offsetLeft;
        const walk = (x - startX) * 2; // Kaydƒ±rma hƒ±zƒ±
        nav.scrollLeft = scrollLeft - walk;
    });

    // MOUSE WHEEL SCROLL
    nav.addEventListener('wheel', (e) => {
        if (e.deltaY !== 0) {
            e.preventDefault();
            nav.scrollLeft += e.deltaY;
        }
    });

    window.switchTab = (tab) => { document.querySelectorAll('.view-section').forEach(e=>e.classList.remove('active')); document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('active')); document.getElementById('view-'+tab).classList.add('active'); event.currentTarget.classList.add('active'); if(tab==='reports') filterReports(); }
    window.changeMonth = (d) => { currentDate.setMonth(currentDate.getMonth()+d); renderCalendar(); }
    window.toggleDatePicker = () => { document.getElementById('month-picker-modal').style.display = document.getElementById('month-picker-modal').style.display === 'block' ? 'none' : 'block'; pickerYear = currentDate.getFullYear(); document.getElementById('pick-year-val').innerText = pickerYear; }
    window.changePickYear = (d) => { pickerYear += d; document.getElementById('pick-year-val').innerText = pickerYear; }
    window.goToMonth = (m) => { currentDate.setFullYear(pickerYear); currentDate.setMonth(m); renderCalendar(); document.getElementById('month-picker-modal').style.display = 'none'; }
    function getCurrentDateStr() { const d=new Date(); return `${d.getDate()}-${d.getMonth()}-${d.getFullYear()}`; }
    function parseDateStr(str) { if(!str) return new Date(); const parts = str.split('-'); return new Date(parts[2], parts[1], parts[0]); }
    
    function renderCalendar() {
        const grid = document.getElementById('calendarGrid'); 
        grid.innerHTML = `<div class="day-head">Pt</div><div class="day-head">Sa</div><div class="day-head">√áa</div><div class="day-head">Pe</div><div class="day-head">Cu</div><div class="day-head">Ct</div><div class="day-head">Pz</div>`;
        const y = currentDate.getFullYear(), m = currentDate.getMonth();
        const names = ["Ocak", "≈ûubat", "Mart", "Nisan", "Mayƒ±s", "Haziran", "Temmuz", "Aƒüustos", "Eyl√ºl", "Ekim", "Kasƒ±m", "Aralƒ±k"];
        document.getElementById('monthDisplay').innerText = `${names[m]} ${y}`;
        const first = new Date(y, m, 1).getDay(), start = first===0?6:first-1, days = new Date(y, m+1, 0).getDate();
        for(let i=0; i<start; i++) grid.innerHTML+='<div></div>';
        const todayObj = new Date();
        const todayISO = todayObj.toISOString().split('T')[0];
        for(let d=1; d<=days; d++) {
            const cellDate = new Date(y, m, d);
            const offset = cellDate.getTimezoneOffset();
            const cellISO = new Date(cellDate.getTime() - (offset*60*1000)).toISOString().split('T')[0];
            let dots = "";
            tasks.forEach(t => {
                const s = t.startDate || parseDateStr(t.date).toISOString().split('T')[0];
                const e = t.endDate || parseDateStr(t.date).toISOString().split('T')[0];
                if (cellISO >= s && cellISO <= e) {
                    if(Array.isArray(t.person)) t.person.forEach(p => dots += `<span class="task-dot">${p}</span>`);
                    else dots += `<span class="task-dot">${t.person}</span>`;
                }
            });
            let cls = (cellISO === todayISO) ? "day-cell today" : "day-cell";
            grid.innerHTML += `<div class="${cls}" onclick="openModal('${cellISO}')"><b>${d}</b>${dots}</div>`;
        }
    }

    window.openModal = (isoDate) => { 
        selectedDateStr = isoDate; 
        document.getElementById('modalDateText').innerText = isoDate.split('-').reverse().join('.'); 
        if(!editingTaskId) {
            document.getElementById('t-start-date').value = isoDate;
            document.getElementById('t-end-date').value = isoDate;
        }
        openModalLogic(isoDate); 
        document.querySelector('#taskModal').style.display = 'flex'; 
    }
    window.closeModal = () => {
        document.querySelector('#taskModal').style.display = 'none';
        cancelTaskEdit(); 
    }
    
    function openModalLogic(isoDate) {
        const dt = tasks.filter(t => {
            const s = t.startDate || parseDateStr(t.date).toISOString().split('T')[0];
            const e = t.endDate || parseDateStr(t.date).toISOString().split('T')[0];
            return isoDate >= s && isoDate <= e;
        });

        document.getElementById('dayTaskList').innerHTML = dt.length ? dt.map(t => {
            const pStr = Array.isArray(t.person) ? t.person.join(", ") : t.person;
            const rangeStr = (t.startDate && t.endDate) ? `<br><small>üìÖ ${t.startDate.split('-').reverse().join('.')} - ${t.endDate.split('-').reverse().join('.')}</small>` : '';
            return `
            <div style="padding:10px; background:#f9f9f9; border-radius:8px; margin-bottom:5px; border-left:4px solid #764ba2;">
                <strong>${pStr}</strong><br>
                üìç ${t.projectName} ${rangeStr}
                ${userRole==='admin' ? `
                <div style="float:right;">
                    <button onclick="editTask('${t.id}')" style="border:none; background:none; font-size:1.1rem; margin-right:5px; cursor:pointer;" title="D√ºzenle">‚úé</button>
                    <button onclick="delTask('${t.id}')" style="color:red; border:none; background:none; font-size:1.1rem; cursor:pointer;" title="Sil">üóë</button>
                </div>
                ` : ''}
            </div>`;
        }).join('') : 'Bu tarihte g√∂rev yok.';
    }
</script>
</body>
</html>
