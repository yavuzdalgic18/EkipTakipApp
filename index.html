<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ekip Takip Pro (V39 - Stabil)</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4facfe">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>

    <style>
        :root { --primary-grad: linear-gradient(135deg, #667eea 0%, #764ba2 100%); --bg-color: #f3f5f9; --text-main: #2d3436; --nav-height: 75px; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Poppins', sans-serif; background-color: var(--bg-color); margin: 0; padding: 0; padding-bottom: 120px; color: var(--text-main); }

        /* TOAST */
        #toast-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 9999; width: 90%; max-width: 400px; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
        .toast { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); display: flex; align-items: center; justify-content: space-between; animation: slideDown 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); pointer-events: all; border-left: 6px solid #ccc; font-weight: 500; font-size: 0.9rem; }
        .toast.success { border-left-color: #27ae60; color: #27ae60; }
        .toast.error { border-left-color: #e74c3c; color: #e74c3c; }
        .toast.info { border-left-color: #3498db; color: #3498db; }
        @keyframes slideDown { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; transform: scale(1); } to { opacity: 0; transform: scale(0.9); } }

        /* Gƒ∞Rƒ∞≈û EKRANI */
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--primary-grad); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; overflow-y: auto; }
        .login-box { background: white; padding: 30px; border-radius: 20px; width: 100%; max-width: 350px; text-align: center; box-shadow: 0 20px 40px rgba(0,0,0,0.2); margin: auto; }
        .login-box input { width: 100%; padding: 15px; margin: 10px 0; border: 1px solid #ddd; border-radius: 12px; background: #f9f9f9; font-size: 16px; }
        .login-box button { width: 100%; padding: 15px; background: #764ba2; color: white; border: none; border-radius: 12px; font-weight: 600; cursor: pointer; margin-top: 10px; }

        /* SAYFA YAPISI - KESƒ∞N AYRIM */
        .view-section { display: none; width: 100%; animation: fadeIn 0.3s; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* UI ELEMENTS */
        .hidden { display: none !important; } 
        .admin-only { display: none; } 
        .container { max-width: 1100px; margin: 0 auto; padding: 0 15px; }
        
        .app-header { padding: 20px; display: flex; justify-content: space-between; align-items: center; }
        .icon-btn { width: 40px; height: 40px; background: white; border-radius: 50%; display: flex; justify-content: center; align-items: center; border: none; box-shadow: 0 2px 5px rgba(0,0,0,0.1); cursor: pointer; font-size: 1.2rem; }
        
        .bottom-nav { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: 95%; max-width: 500px; background: white; height: 75px; border-radius: 25px; display: flex; align-items: center; box-shadow: 0 15px 35px rgba(0,0,0,0.15); z-index: 1000; overflow-x: auto; padding: 0 10px; gap: 10px; -ms-overflow-style: none; scrollbar-width: none; }
        .nav-item { display: flex; flex-direction: column; align-items: center; font-size: 0.7rem; color: #b2bec3; min-width: 60px; cursor: pointer; transition: 0.3s; }
        .nav-item .icon { font-size: 1.5rem; margin-bottom: 2px; }
        .nav-item.active { color: #764ba2; transform: translateY(-3px); font-weight: 600; }

        .modern-card { background: white; border-radius: 20px; padding: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); margin-bottom: 15px; }
        .hero-card { background: var(--primary-grad); border-radius: 25px; padding: 25px; color: white; margin-bottom: 20px; box-shadow: 0 10px 20px rgba(118, 75, 162, 0.3); }
        .hero-stat-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-top: 15px; text-align: center; }
        .hero-stat-item span { font-size: 1.8rem; font-weight: 700; display: block; }
        
        .info-card { background: white; padding: 15px; border-radius: 12px; margin-bottom: 10px; border-left: 5px solid #ccc; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .info-card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
        .info-card.active { border-left-color: #27ae60; } 
        .info-card.custody { border-left-color: #f39c12; }
        .badge { padding: 4px 8px; border-radius: 6px; font-size: 0.75rem; font-weight: bold; }
        .badge-green { background: #d1fae5; color: #065f46; } 
        .badge-red { background: #fee2e2; color: #991b1b; } 
        .badge-orange { background: #ffedd5; color: #9a3412; } 
        .badge-gray { background: #f3f4f6; color: #374151; }
        
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; }
        .day-head { text-align: center; font-size: 0.8rem; color: #888; margin-bottom: 5px; }
        .day-cell { background: #f8f9fa; height: 100px; border-radius: 8px; padding: 4px; font-size: 0.8rem; position: relative; cursor: pointer; display: flex; flex-direction: column; overflow-y: auto; }
        .day-cell.today { border: 2px solid #764ba2; background: white; }
        .task-dot { font-size: 0.65rem; background: #e0e7ff; color: #4338ca; padding: 3px 5px; margin-bottom: 2px; border-radius: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; flex-shrink: 0; }

        input, select { width: 100%; padding: 12px; border: 1px solid #eee; background: #f9f9f9; border-radius: 10px; margin-bottom: 10px; font-size: 16px; outline: none; transition: 0.3s; }
        .btn-main { width: 100%; padding: 12px; background: var(--primary-grad); color: white; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; margin-bottom: 5px; }
        .btn-sm { padding: 5px 10px; font-size: 0.8rem; border-radius: 6px; border: none; cursor: pointer; margin-left: 5px; }
        .filter-btn { padding: 8px 15px; border: 1px solid #eee; border-radius: 20px; background: #fff; cursor: pointer; font-size: 0.8rem; }
        .filter-btn.active { background: var(--primary-grad); color: white; border: none; }
        
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; display: none; justify-content: center; align-items: end; }
        .modal-card { background: white; width: 100%; max-width: 500px; border-radius: 20px 20px 0 0; padding: 25px; max-height: 85vh; overflow-y: auto; }
        .multi-select-area { background: #f9f9f9; border: 1px solid #eee; border-radius: 10px; padding: 10px; max-height: 150px; overflow-y: auto; margin-bottom: 10px; }
        .ms-item { display: flex; align-items: center; margin-bottom: 8px; } .ms-item input { width: 20px; margin: 0 10px 0 0; }
        .log-table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
        .log-table th { text-align: left; padding: 10px; background: #f4f6f8; }
        .log-table td { padding: 10px; border-bottom: 1px solid #eee; }
    </style>
</head>
<body>

<div id="toast-container"></div>

<div id="login-screen">
    <div class="login-box">
        <h2>Ekip Takip Pro</h2>
        <input type="email" id="loginEmail" placeholder="E-Posta">
        <input type="password" id="loginPass" placeholder="≈ûifre">
        <button onclick="handleLogin()">Giri≈ü Yap</button>
        <div id="loginError" style="color:red; margin-top:10px; font-size:0.8rem;"></div>
        
        <p style="margin-top:20px; color:#764ba2; cursor:pointer; font-size:0.9rem;" onclick="document.getElementById('registerArea').classList.toggle('hidden')">Hesabƒ±mƒ± Tamamla / Kayƒ±t Ol</p>
        <div id="registerArea" class="hidden" style="margin-top:15px;">
            <div style="background:#fff3cd; color:#856404; padding:10px; border-radius:8px; font-size:0.75rem; margin-bottom:10px;">
                ‚ö†Ô∏è Sadece y√∂neticinin sisteme tanƒ±mladƒ±ƒüƒ± mail adresi ile kayƒ±t olabilirsiniz.
            </div>
            <input type="text" id="regName" placeholder="Ad Soyad">
            <input type="text" id="regTitle" placeholder="√únvan">
            <input type="email" id="regEmail" placeholder="E-Posta (Tanƒ±mlƒ± Mail)">
            <input type="password" id="regPass" placeholder="≈ûifre Belirle">
            <button onclick="handleRegister()" style="background:#27ae60;">Kaydƒ± Tamamla</button>
        </div>
    </div>
</div>

<div id="app-screen" class="hidden">
    <div class="app-header">
        <div><small style="color:#888;">Merhaba,</small><h2 style="margin:0;" id="welcomeUser">Kullanƒ±cƒ±</h2></div>
        <div class="header-icons"><button class="icon-btn" onclick="requestNotificationPermission()">üîî</button><button class="icon-btn" onclick="handleLogout()">üö™</button></div>
    </div>

    <div class="container">
        
        <div id="view-calendar" class="view-section active">
            <div class="hero-card">
                <div class="hero-stat-grid">
                    <div class="hero-stat-item"><span id="stat-total">0</span><small>Ekip</small></div>
                    <div class="hero-stat-item"><span id="stat-active">0</span><small>Sahada</small></div>
                    <div class="hero-stat-item"><span id="stat-idle">0</span><small>Bo≈üta</small></div>
                </div>
            </div>
            <div class="modern-card">
                <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                    <button class="icon-btn" style="width:35px; height:35px;" onclick="changeMonth(-1)">‚óÄ</button>
                    <h3 style="margin:0; cursor:pointer; text-decoration:underline;" id="monthDisplay">Takvim</h3>
                    <button class="icon-btn" style="width:35px; height:35px;" onclick="changeMonth(1)">‚ñ∂</button>
                </div>
                <div class="calendar-grid" id="calendarGrid"></div>
            </div>
        </div>

        <div id="view-projects" class="view-section">
            <input type="text" class="search-bar" placeholder="Proje Ara..." onkeyup="filterList(this, 'projectListBody', 'div')">
            <div class="admin-only modern-card" id="projectFormContainer">
                <h3>Yeni Proje</h3>
                <input type="text" id="p-name" placeholder="Proje Adƒ±">
                <select id="p-manager"></select>
                <div style="display:flex; gap:5px;">
                    <div style="flex:1"><label style="font-size:0.7rem;">Ba≈ülangƒ±√ß</label><input type="date" id="p-start"></div>
                    <div style="flex:1"><label style="font-size:0.7rem;">Biti≈ü</label><input type="date" id="p-end"></div>
                </div>
                <div style="display:flex; gap:5px;"><input type="number" id="p-cost" placeholder="Maliyet"><input type="number" id="p-offer" placeholder="Teklif"></div>
                <button class="btn-main" id="btn-p-save" onclick="submitProject()">Kaydet</button>
                <button class="btn-main" id="btn-p-update" onclick="updateProjectDB()" style="background:#f39c12; display:none;">G√ºncelle</button>
                <button class="btn-main" id="btn-p-cancel" onclick="cancelProjectEdit()" style="background:#95a5a6; display:none;">Vazge√ß</button>
            </div>
            <div class="modern-card" id="projectListBody"></div>
        </div>

        <div id="view-team" class="view-section">
            <input type="text" class="search-bar" placeholder="Personel Ara..." onkeyup="filterList(this, 'teamListArea', 'div.person-row')">
            <div class="modern-card" id="teamListArea"></div>
        </div>

        <div id="view-vehicles" class="view-section">
            <input type="text" class="search-bar" placeholder="Ara√ß Ara..." onkeyup="filterList(this, 'vehicleListArea', 'div.info-card')">
            <div class="admin-only modern-card" id="vehicleFormContainer">
                <h3>Yeni Ara√ß</h3>
                <input type="text" id="v-plate" placeholder="Plaka">
                <input type="text" id="v-info" placeholder="Model">
                <label>Muayene Tarihi:</label><input type="date" id="v-inspection">
                <button class="btn-main" id="btn-v-save" onclick="addVehicle()">Kaydet</button>
                <button class="btn-main" id="btn-v-update" onclick="updateVehicleDB()" style="background:#f39c12; display:none;">G√ºncelle</button>
                <button class="btn-main" id="btn-v-cancel" onclick="cancelVehicleEdit()" style="background:#95a5a6; display:none;">Vazge√ß</button>
            </div>
            <div class="modern-card"><div id="vehicleListArea" class="card-list"></div></div>
        </div>

        <div id="view-devices" class="view-section">
            <input type="text" class="search-bar" placeholder="Cihaz Ara..." onkeyup="filterList(this, 'deviceListArea', 'div.info-card')">
            <div class="admin-only modern-card" id="deviceFormContainer">
                <h3>Yeni Cihaz</h3>
                <input type="text" id="d-name" placeholder="Cihaz Adƒ±">
                <input type="text" id="d-serial" placeholder="Seri No">
                <label>Kalibrasyon:</label><input type="date" id="d-calib">
                <button class="btn-main" id="btn-d-save" onclick="addDevice()">Ekle</button>
                <button class="btn-main" id="btn-d-update" onclick="updateDeviceDB()" style="background:#f39c12; display:none;">G√ºncelle</button>
                <button class="btn-main" id="btn-d-cancel" onclick="cancelDeviceEdit()" style="background:#95a5a6; display:none;">Vazge√ß</button>
            </div>
            <div class="modern-card"><div id="deviceListArea" class="card-list"></div></div>
        </div>

        <div id="view-users" class="view-section admin-only">
            <div class="modern-card">
                <h3>Kullanƒ±cƒ± Tanƒ±mla (√ñn Onay)</h3>
                <p style="font-size:0.8rem; color:#666;">Personel sisteme kayƒ±t olmadan √∂nce buradan eklemelisiniz.</p>
                <input type="text" id="u-name" placeholder="Ad Soyad">
                <input type="text" id="u-title" placeholder="√únvan">
                <input type="email" id="u-email" placeholder="E-Posta">
                <select id="u-role"><option value="staff">Personel</option><option value="admin">Y√∂netici</option></select>
                <button class="btn-main" id="btn-user-add" onclick="addUserToDB()">Tanƒ±mla (Ekle)</button>
                <button class="btn-main" id="btn-user-update" onclick="updateUserDB()" style="background:#f39c12; display:none;">G√ºncelle</button>
                <button class="btn-main" id="btn-user-cancel" onclick="cancelUserEdit()" style="background:#95a5a6; display:none;">Vazge√ß</button>
            </div>
            <div class="modern-card" id="userListArea"></div>
            <div class="modern-card" style="border: 2px solid red; background: #fff5f5;">
                <h3 style="color:#c0392b; margin-top:0;">‚ö†Ô∏è Tehlikeli B√∂lge</h3>
                <button class="btn-main" onclick="clearAllTasks()" style="background:#e74c3c;">‚ö†Ô∏è T√úM G√ñREVLERƒ∞ Sƒ∞L VE SIFIRLA</button>
            </div>
        </div>

        <div id="view-reports" class="view-section admin-only">
            <div class="modern-card">
                <label>D√∂nem:</label>
                <input type="month" id="reportDateSelector" onchange="filterReports()" style="width:100%;">
            </div>
            <div class="modern-card">
                <h3>Zimmet Ge√ßmi≈üi</h3>
                <div style="display:flex; gap:5px; margin-bottom:10px;">
                    <button class="filter-btn active" onclick="setReportFilter('all', this)">T√ºm√º</button>
                    <button class="filter-btn" onclick="setReportFilter('vehicle', this)">Ara√ß</button>
                    <button class="filter-btn" onclick="setReportFilter('device', this)">Cihaz</button>
                </div>
                <div style="max-height:300px; overflow-y:auto;">
                    <table class="log-table" id="logTable" style="width:100%; font-size:0.8rem;"></table>
                </div>
            </div>
             <div class="modern-card">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h3>Personel Aylƒ±k √áalƒ±≈üma</h3>
                    <button class="btn-sm" style="background:#27ae60; color:white; border:none; border-radius:5px;" onclick="exportExcel()">Excel</button>
                </div>
                <table class="log-table" id="personnelReportTable" style="width:100%;"><tbody id="personnelReportBody"></tbody></table>
            </div>
        </div>

    </div>

    <div class="bottom-nav">
        <div class="nav-item active" onclick="switchTab('calendar')"><span class="icon">üìÖ</span>Takvim</div>
        <div class="nav-item" onclick="switchTab('projects')"><span class="icon">üìÇ</span>Proje</div>
        <div class="nav-item" onclick="switchTab('team')"><span class="icon">üë•</span>Ekip</div>
        <div class="nav-item" onclick="switchTab('vehicles')"><span class="icon">üöó</span>Ara√ß</div>
        <div class="nav-item" onclick="switchTab('devices')"><span class="icon">üß∞</span>Cihaz</div>
        <div class="nav-item admin-only" onclick="switchTab('users')"><span class="icon">‚öôÔ∏è</span>Yetki</div>
        <div class="nav-item admin-only" onclick="switchTab('reports')"><span class="icon">üìä</span>Rapor</div>
    </div>
</div>

<div class="modal-overlay" id="custodyModal" onclick="if(event.target===this) closeCustodyModal()">
    <div class="modal-card">
        <h3>Zimmetle</h3>
        <p id="custodyItemName" style="color:#666;"></p>
        <label>Personel Se√ß:</label><select id="c-person"></select>
        <button class="btn-main" onclick="saveCustody()">Kaydet</button>
        <button class="btn-main" onclick="closeCustodyModal()" style="background:#95a5a6; margin-top:10px;">ƒ∞ptal</button>
    </div>
</div>

<div class="modal-overlay" id="taskModal" onclick="if(event.target===this) closeModal()">
    <div class="modal-card">
        <div style="display:flex; justify-content:space-between; margin-bottom:20px;"><h2>G√∂revler</h2><span onclick="closeModal()" style="font-size:1.5rem; cursor:pointer;">‚úï</span></div>
        <p id="modalDateText" style="margin-bottom:10px; font-weight:bold; color:#764ba2;"></p>
        <div id="dayTaskList" style="margin-bottom:20px; max-height: 200px; overflow-y: auto;"></div>
        <div class="admin-only" id="assignForm">
            <h3 id="taskFormTitle">Yeni Atama</h3>
            <div style="display:flex; gap:10px;">
                <div style="flex:1;"><label>Ba≈ülangƒ±√ß</label><input type="date" id="t-start-date"></div>
                <div style="flex:1;"><label>Biti≈ü</label><input type="date" id="t-end-date"></div>
            </div>
            <label>Personel</label><div class="multi-select-area" id="ms-person"></div>
            <label>Proje</label><select id="t-project-select"></select>
            <input type="text" id="t-loc" placeholder="Konum">
            <label>Ara√ßlar</label><div class="multi-select-area" id="ms-plate"></div>
            <label>Cihazlar</label><div class="multi-select-area" id="ms-device"></div>
            <div id="conflictWarning" style="color:red; font-size:0.8rem; margin:10px 0;"></div>
            <button class="btn-main" id="btn-save-task" onclick="saveTask()">Kaydet</button>
            <button class="btn-main" id="btn-update-task" onclick="updateTaskDB()" style="background:#f39c12; display:none;">G√ºncelle</button>
            <button class="btn-main" id="btn-cancel-task" onclick="cancelTaskEdit()" style="background:#95a5a6; display:none;">Vazge√ß</button>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, deleteDoc, updateDoc, doc, onSnapshot, query, orderBy, setDoc, getDoc, limit, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const k1 = "AIzaSyD4XZR8JAMe-"; const k2 = "Qr2Oj2UGnp9mFc8En38gxY";
    const firebaseConfig = { apiKey: k1+k2, authDomain: "ekiptakipapp.firebaseapp.com", projectId: "ekiptakipapp", storageBucket: "ekiptakipapp.firebasestorage.app", messagingSenderId: "55716082808", appId: "1:55716082808:web:b144b953684fc9f80c698d", measurementId: "G-S6Q0H5RHR7" };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    window.OneSignalDeferred = window.OneSignalDeferred || [];
    OneSignalDeferred.push(function(OneSignal) { OneSignal.init({ appId: "08d90e98-c6b4-429c-aab5-f11164ddc881" }); });

    let projects=[], tasks=[], users=[], vehicles=[], devices=[], logs=[];
    let currentUser=null, userRole='staff';
    let currentDate=new Date(), selectedDateStr=getCurrentDateStr(), isFirstLoad=true;
    let editingTaskId=null, editingVehicleId=null, editingDeviceId=null, editingProjectId=null, editingUserEmail=null;
    let custodyTargetId = null, custodyType = null;
    let currentReportFilter = 'all', currentReportDate = new Date().toISOString().slice(0, 7);

    // TOAST
    window.showToast = (msg, type='success') => {
        const t = document.createElement('div'); t.className = `toast ${type}`; t.innerText = msg;
        document.getElementById('toast-container').appendChild(t);
        setTimeout(() => { t.style.animation = "fadeOut 0.3s forwards"; setTimeout(() => t.remove(), 300); }, 3000);
    }

    // AUTH & INIT
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            const userDoc = await getDoc(doc(db, "users", user.email));
            if (userDoc.exists()) {
                const userData = userDoc.data();
                currentUser = userData; userRole = userData.role;
                document.getElementById('welcomeUser').innerText = userData.name.split(' ')[0];
                
                // SAYFA Gƒ∞ZLƒ∞Lƒ∞ƒûƒ∞Nƒ∞ AYARLA
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('app-screen').classList.remove('hidden');
                
                // YETKƒ∞YE G√ñRE MEN√úLERƒ∞ G√ñSTER
                if(userRole === 'admin') {
                    document.querySelectorAll('.admin-only').forEach(el => {
                        if(el.classList.contains('nav-item')) el.style.display = 'flex';
                    });
                }

                // TABLARI SIFIRLA VE ƒ∞LK TABI A√á
                switchTab('calendar'); 

                OneSignalDeferred.push(function(OneSignal) { OneSignal.login(user.email); });
                document.getElementById('reportDateSelector').value = currentReportDate;
                startListeners();
            } else {
                await setDoc(doc(db, "users", user.email), { name: "Y√∂netici", email: user.email, role: 'admin' });
                window.location.reload();
            }
        } else {
            document.getElementById('login-screen').classList.remove('hidden');
            document.getElementById('app-screen').classList.add('hidden');
        }
    });

    window.handleLogin = () => { signInWithEmailAndPassword(auth, document.getElementById('loginEmail').value, document.getElementById('loginPass').value).catch(err => document.getElementById('loginError').innerText = err.message); };
    window.handleLogout = () => { signOut(auth); window.location.reload(); };
    
    window.handleRegister = async () => { 
        const email = document.getElementById('regEmail').value.trim();
        const pass = document.getElementById('regPass').value;
        const name = document.getElementById('regName').value;
        const title = document.getElementById('regTitle').value;
        if(!email || !pass) return showToast("E-posta ve ≈üifre zorunlu", "error");
        try {
            const userRef = doc(db, "users", email);
            const userDoc = await getDoc(userRef);
            if (!userDoc.exists()) return showToast("Bu mail yetkili listesinde yok!", "error");
            await createUserWithEmailAndPassword(auth, email, pass);
            await updateDoc(userRef, { name: name, title: title }); 
            showToast("Kayƒ±t Ba≈üarƒ±lƒ±! Giri≈ü yapƒ±lƒ±yor...", "success");
        } catch (err) { 
            if(err.code === 'auth/email-already-in-use') showToast("Mail zaten kayƒ±tlƒ±.", "info");
            else showToast(err.message, "error"); 
        } 
    };

    // NAVIGATION (TAB Sƒ∞STEMƒ∞ - D√úZELTƒ∞LEN KISIM)
    window.switchTab = (tab) => {
        // 1. T√úM SAYFALARI Gƒ∞ZLE
        document.querySelectorAll('.view-section').forEach(el => {
            el.style.display = 'none'; 
            el.classList.remove('active');
        });
        
        // 2. T√úM MEN√ú BUTONLARINI PASƒ∞F YAP
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));

        // 3. HEDEF SAYFAYI G√ñSTER (EƒûER YETKƒ∞ VARSA)
        const targetView = document.getElementById('view-' + tab);
        if (targetView) {
            // Admin kontrol√º: Eƒüer sayfa admin-only ise ve kullanƒ±cƒ± admin deƒüilse g√∂sterme
            if(targetView.classList.contains('admin-only') && userRole !== 'admin') return;
            
            targetView.style.display = 'block';
            setTimeout(() => targetView.classList.add('active'), 10);
        }

        // 4. MEN√ú BUTONUNU AKTƒ∞F YAP
        const clickedNavItem = event ? event.currentTarget : document.querySelector(`.nav-item[onclick="switchTab('${tab}')"]`);
        if(clickedNavItem) clickedNavItem.classList.add('active');

        // 5. √ñZEL DURUMLAR
        if(tab === 'reports' && userRole === 'admin') filterReports();
    }

    // DATA LISTENERS
    function startListeners() {
        const load = (col, arr, cb) => onSnapshot(collection(db, col), (s) => { arr.length=0; s.docs.forEach(d=>arr.push({id:d.id, ...d.data()})); if(cb) cb(); loadDropdowns(); });
        load("projects", projects, renderProjects);
        load("vehicles", vehicles, renderVehicleList);
        load("devices", devices, renderDeviceList);
        onSnapshot(collection(db, "users"), (s) => { users=[]; s.docs.forEach(d=>users.push(d.data())); renderTeamStatus(); renderUserList(); loadDropdowns(); });
        onSnapshot(query(collection(db, "logs"), orderBy("date", "desc"), limit(500)), (s) => { logs = []; s.docs.forEach(d => logs.push(d.data())); if(userRole==='admin') filterReports(); });

        onSnapshot(collection(db, "tasks"), (snapshot) => {
            tasks=[]; snapshot.docs.forEach(d=>tasks.push({id:d.id, ...d.data()}));
            renderCalendar();
            if(document.querySelector('#taskModal').style.display === 'flex') openModalLogic(selectedDateStr);
            updateStats(new Date().toISOString().split('T')[0]); renderTeamStatus(); renderDeviceList(); if(userRole==='admin') filterReports();
        });
    }

    window.filterList = (input, listId, itemTag) => { const filter = input.value.toLowerCase(); document.getElementById(listId).querySelectorAll(itemTag).forEach(item => { item.style.display = (item.textContent || item.innerText).toLowerCase().indexOf(filter) > -1 ? "" : "none"; }); }

    // LOGIC HELPER FUNCTIONS
    async function addLog(type, item, action, person) { await addDoc(collection(db, "logs"), { date: new Date().toISOString(), type: type, item: item, action: action, person: person, admin: currentUser.name }); }
    window.setReportFilter = (filter, btn) => { currentReportFilter = filter; document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); filterReports(); }
    window.filterReports = () => { currentReportDate = document.getElementById('reportDateSelector').value; renderLogs(); renderPersonnelReport(); }
    
    function renderLogs() {
        const table = document.getElementById('logTable');
        const filteredLogs = logs.filter(l => currentReportFilter === 'all' || l.type === currentReportFilter);
        if (filteredLogs.length === 0) { table.innerHTML = '<tr><td>Kayƒ±t yok.</td></tr>'; return; }
        table.innerHTML = filteredLogs.map(l => {
            const d = new Date(l.date);
            const dateStr = `${d.getDate()}.${d.getMonth()+1} ${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}`;
            const actionText = l.action === 'take' ? 'Aldƒ±' : 'Verdi';
            const icon = l.type === 'vehicle' ? 'üöó' : 'üß∞';
            return `<tr><td><span style="font-size:0.7rem; color:#888;">${dateStr}</span></td><td>${icon} <strong>${l.person}</strong><br>${l.item} <span style="color:${l.action==='take'?'green':'red'}; font-weight:bold;">${actionText}</span></td></tr>`;
        }).join('');
    }

    function renderPersonnelReport() {
        const [year, month] = currentReportDate.split('-').map(Number);
        const reportData = {}; users.forEach(u => reportData[u.name] = 0);
        tasks.forEach(t => {
            let start = new Date(t.startDate || parseDateStr(t.date));
            let end = new Date(t.endDate || parseDateStr(t.date));
            let loop = new Date(start);
            while(loop <= end) {
                if (loop.getFullYear() === year && loop.getMonth() === (month - 1)) {
                    if (Array.isArray(t.person)) t.person.forEach(p => { if(reportData[p] !== undefined) reportData[p]++; });
                    else if(reportData[t.person] !== undefined) reportData[t.person]++;
                }
                loop.setDate(loop.getDate() + 1);
            }
        });
        document.getElementById('personnelReportBody').innerHTML = Object.keys(reportData).map(key => `<tr><td>${key}</td><td style="font-weight:bold;">${reportData[key]} G√ºn</td></tr>`).join('');
    }

    window.saveTask = async () => {
        const btn = document.getElementById('btn-save-task');
        const per = getMultiSelectValues('ms-person'), dev = getMultiSelectValues('ms-device'), plate = getMultiSelectValues('ms-plate');
        const projVal = document.getElementById('t-project-select').value;
        const sDate = document.getElementById('t-start-date').value;
        const eDate = document.getElementById('t-end-date').value;
        if(!projVal || per.length===0 || !sDate || !eDate) return showToast("Eksik bilgi", "error");
        if(sDate > eDate) return showToast("Tarih hatasƒ±", "error");
        
        let conflictMsg = "";
        dev.forEach(dName => {
            const deviceObj = devices.find(d => d.name === dName);
            if (deviceObj && deviceObj.currentHolder && !per.includes(deviceObj.currentHolder)) { conflictMsg += `‚ö†Ô∏è ${dName} cihazƒ± ≈üu an ${deviceObj.currentHolder} zimmetinde!\n`; }
        });
        if (conflictMsg && !confirm(`Dƒ∞KKAT:\n${conflictMsg}\nYine de atamak istiyor musunuz?`)) return;

        btn.disabled = true; btn.innerText = "Kaydediliyor...";
        try {
            const projName = document.getElementById('t-project-select').options[document.getElementById('t-project-select').selectedIndex].text;
            await addDoc(collection(db, "tasks"), { startDate: sDate, endDate: eDate, person: per, projectName: projName, projectId: projVal, location: document.getElementById('t-loc').value, device: dev, plate: plate });
            showToast("G√∂rev atandƒ±!", "success");
            closeModal();
        } catch (e) { showToast("Hata: " + e.message, "error"); } finally { btn.disabled = false; btn.innerText = "Kaydet"; }
    }

    window.delTask = async (id) => { if(confirm("Silmek istediƒüine emin misin?")) { await deleteDoc(doc(db, "tasks", id)); showToast("Silindi", "error"); closeModal(); } }
    window.clearAllTasks = async () => { if(!confirm("T√ºm veriler silinecek?")) return; const q = query(collection(db, "tasks")); const querySnapshot = await getDocs(q); const batch = writeBatch(db); querySnapshot.forEach((doc) => batch.delete(doc.ref)); await batch.commit(); showToast("Temizlik Tamam", "success"); }

    // STANDARD CRUD HELPERS
    window.addVehicle=async()=>{const p=document.getElementById('v-plate').value; if(!p)return; await addDoc(collection(db,"vehicles"),{plate:p,info:document.getElementById('v-info').value,inspectionDate:document.getElementById('v-inspection').value,currentHolder:null}); showToast("Ara√ß eklendi"); resetVehicleForm();}
    window.updateVehicleDB=async()=>{await updateDoc(doc(db,"vehicles",editingVehicleId),{plate:document.getElementById('v-plate').value,info:document.getElementById('v-info').value,inspectionDate:document.getElementById('v-inspection').value}); showToast("Ara√ß g√ºncellendi"); resetVehicleForm();}
    window.editVehicle=(id)=>{const v=vehicles.find(x=>x.id===id); if(!v)return; document.getElementById('v-plate').value=v.plate; document.getElementById('v-info').value=v.info; document.getElementById('v-inspection').value=v.inspectionDate||""; editingVehicleId=id; document.getElementById('btn-v-save').style.display='none'; document.getElementById('btn-v-update').style.display='block'; document.getElementById('btn-v-cancel').style.display='block';}
    window.cancelVehicleEdit=resetVehicleForm;
    function resetVehicleForm(){editingVehicleId=null; document.getElementById('v-plate').value=""; document.getElementById('v-info').value=""; document.getElementById('v-inspection').value=""; document.getElementById('btn-v-save').style.display='block'; document.getElementById('btn-v-update').style.display='none'; document.getElementById('btn-v-cancel').style.display='none';}
    window.deleteVehicle=async(id)=>{if(confirm("Sil?")) { await deleteDoc(doc(db,"vehicles",id)); showToast("Ara√ß silindi", "error"); }}

    window.addDevice=async()=>{const n=document.getElementById('d-name').value; if(!n)return; await addDoc(collection(db,"devices"),{name:n,serial:document.getElementById('d-serial').value,calib:document.getElementById('d-calib').value,currentHolder:null}); showToast("Cihaz eklendi"); document.getElementById('d-name').value="";document.getElementById('d-serial').value="";document.getElementById('d-calib').value="";}
    window.updateDeviceDB=async()=>{await updateDoc(doc(db,"devices",editingDeviceId),{name:document.getElementById('d-name').value,serial:document.getElementById('d-serial').value,calib:document.getElementById('d-calib').value}); showToast("Cihaz g√ºncellendi"); resetDeviceForm();}
    window.editDevice=(id)=>{const d=devices.find(x=>x.id===id); if(!d)return; document.getElementById('d-name').value=d.name; document.getElementById('d-serial').value=d.serial; document.getElementById('d-calib').value=d.calib||""; editingDeviceId=id; document.getElementById('btn-d-save').style.display='none'; document.getElementById('btn-d-update').style.display='block'; document.getElementById('btn-d-cancel').style.display='block';}
    window.cancelDeviceEdit=resetDeviceForm;
    function resetDeviceForm(){editingDeviceId=null; document.getElementById('d-name').value=""; document.getElementById('d-serial').value=""; document.getElementById('d-calib').value=""; document.getElementById('btn-d-save').style.display='block'; document.getElementById('btn-d-update').style.display='none'; document.getElementById('btn-d-cancel').style.display='none';}
    window.deleteDevice=async(id)=>{if(confirm("Sil?")) { await deleteDoc(doc(db,"devices",id)); showToast("Cihaz silindi", "error"); }}

    window.addUserToDB=async()=>{const n=document.getElementById('u-name').value,e=document.getElementById('u-email').value,r=document.getElementById('u-role').value; if(!n)return; await setDoc(doc(db,"users",e),{name:n,email:e,role:r,title:document.getElementById('u-title').value}); showToast("Kullanƒ±cƒ± Tanƒ±mlandƒ±");}
    window.editUser=(e)=>{const u=users.find(x=>x.email===e); if(!u)return; document.getElementById('u-name').value=u.name; document.getElementById('u-title').value=u.title||''; document.getElementById('u-email').value=u.email; document.getElementById('u-email').disabled=true; document.getElementById('u-role').value=u.role; editingUserEmail=e; document.getElementById('btn-user-add').style.display='none'; document.getElementById('btn-user-update').style.display='block'; document.getElementById('btn-user-cancel').style.display='block';}
    window.updateUserDB=async()=>{await updateDoc(doc(db,"users",editingUserEmail),{name:document.getElementById('u-name').value,title:document.getElementById('u-title').value,role:document.getElementById('u-role').value}); showToast("Kullanƒ±cƒ± g√ºncellendi"); cancelUserEdit();}
    window.cancelUserEdit=()=>{editingUserEmail=null; document.getElementById('u-name').value=""; document.getElementById('u-title').value=""; document.getElementById('u-email').value=""; document.getElementById('u-email').disabled=false; document.getElementById('btn-user-add').style.display='block'; document.getElementById('btn-user-update').style.display='none'; document.getElementById('btn-user-cancel').style.display='none';}
    window.deleteUser=async(e)=>{if(confirm("Sil?")) { await deleteDoc(doc(db,"users",e)); showToast("Kullanƒ±cƒ± silindi", "error"); }}
    
    window.submitProject=async()=>{const n=document.getElementById('p-name').value; if(!n)return; await addDoc(collection(db,"projects"),{name:n,manager:document.getElementById('p-manager').value,start:document.getElementById('p-start').value,end:document.getElementById('p-end').value,cost:document.getElementById('p-cost').value,offer:document.getElementById('p-offer').value}); showToast("Proje eklendi"); document.getElementById('p-name').value="";}
    window.updateProjectDB=async()=>{await updateDoc(doc(db,"projects",editingProjectId),{name:document.getElementById('p-name').value,manager:document.getElementById('p-manager').value,start:document.getElementById('p-start').value,end:document.getElementById('p-end').value,cost:document.getElementById('p-cost').value,offer:document.getElementById('p-offer').value}); showToast("Proje g√ºncellendi"); cancelProjectEdit();}
    window.editProject=(id)=>{const p=projects.find(x=>x.id===id); if(!p)return; document.getElementById('p-name').value=p.name; document.getElementById('p-manager').value=p.manager; document.getElementById('p-start').value=p.start||""; document.getElementById('p-end').value=p.end||""; document.getElementById('p-cost').value=p.cost; document.getElementById('p-offer').value=p.offer; editingProjectId=id; document.getElementById('btn-p-save').style.display='none'; document.getElementById('btn-p-update').style.display='block'; document.getElementById('btn-p-cancel').style.display='block';}
    window.cancelProjectEdit=()=>{editingProjectId=null; document.getElementById('p-name').value=""; document.getElementById('p-cost').value=""; document.getElementById('p-offer').value=""; document.getElementById('p-start').value=""; document.getElementById('p-end').value=""; document.getElementById('btn-p-save').style.display='block'; document.getElementById('btn-p-update').style.display='none'; document.getElementById('btn-p-cancel').style.display='none';}
    window.deleteProject=async(id)=>{if(confirm("Sil?")) { await deleteDoc(doc(db,"projects",id)); showToast("Proje silindi", "error"); }}

    function renderTeamStatus(){
        const todayStr=new Date().toISOString().split('T')[0];
        document.getElementById('teamListArea').innerHTML=users.map(u=>{
            const at = tasks.find(t => { const s = t.startDate||parseDateStr(t.date).toISOString().split('T')[0]; const e = t.endDate||parseDateStr(t.date).toISOString().split('T')[0]; return todayStr >= s && todayStr <= e && (Array.isArray(t.person) ? t.person.includes(u.name) : t.person === u.name); });
            let statusHtml=at?`<div class="badge badge-green">SAHADA</div>`:`<div class="badge badge-gray">BO≈ûTA</div>`;
            const upcoming = tasks.filter(t => (t.startDate||parseDateStr(t.date).toISOString().split('T')[0]) > todayStr && (Array.isArray(t.person) ? t.person.includes(u.name) : t.person === u.name)).sort((a,b) => (a.startDate||a.date).localeCompare(b.startDate||b.date))[0];
            let futureHtml = upcoming ? `<small style="color:#e67e22; display:block; margin-top:5px;">üìÖ Sonraki: ${upcoming.startDate || upcoming.date} - ${upcoming.projectName}</small>` : '';
            return `<div class="person-row"><div style="display:flex; align-items:center;"><div class="avatar" style="margin-right:10px;">${u.name.charAt(0)}</div><div><div style="font-weight:600;">${u.name}</div><small>${u.title||''}</small>${futureHtml}</div></div>${statusHtml}</div>`;
        }).join('');
    }
    function updateStats(todayISO){ let activeSet = new Set(); tasks.forEach(t => { const s = t.startDate||parseDateStr(t.date).toISOString().split('T')[0]; const e = t.endDate||parseDateStr(t.date).toISOString().split('T')[0]; if (todayISO >= s && todayISO <= e) { if(Array.isArray(t.person)) t.person.forEach(p=>activeSet.add(p)); else activeSet.add(t.person); } }); document.getElementById('stat-total').innerText=users.length; document.getElementById('stat-active').innerText=activeSet.size; document.getElementById('stat-idle').innerText=Math.max(0,users.length-activeSet.size); }
    function loadDropdowns(){ if(document.getElementById('p-manager')) document.getElementById('p-manager').innerHTML=users.map(u=>`<option>${u.name}</option>`).join(''); if(document.getElementById('t-project-select')) document.getElementById('t-project-select').innerHTML=`<option value="">Se√ß</option>`+projects.map(p=>`<option value="${p.id}">${p.name}</option>`).join(''); if(document.getElementById('c-person')) document.getElementById('c-person').innerHTML=users.map(u=>`<option value="${u.name}">${u.name}</option>`).join(''); const fillMulti=(id,arr,k)=>{const el=document.getElementById(id);if(el)el.innerHTML=arr.map(i=>`<div class="ms-item"><input type="checkbox" value="${i[k]}">${i[k]}</div>`).join('')}; fillMulti('ms-person',users,'name'); fillMulti('ms-device',devices,'name'); fillMulti('ms-plate',vehicles,'plate'); }
    function getMultiSelectValues(id){return Array.from(document.querySelectorAll(`#${id} input:checked`)).map(i=>i.value);}
    
    window.changeMonth = (d) => { currentDate.setMonth(currentDate.getMonth()+d); renderCalendar(); }
    window.toggleDatePicker = () => { document.getElementById('month-picker-modal').style.display = document.getElementById('month-picker-modal').style.display === 'block' ? 'none' : 'block'; pickerYear = currentDate.getFullYear(); document.getElementById('pick-year-val').innerText = pickerYear; }
    window.changePickYear = (d) => { pickerYear += d; document.getElementById('pick-year-val').innerText = pickerYear; }
    window.goToMonth = (m) => { currentDate.setFullYear(pickerYear); currentDate.setMonth(m); renderCalendar(); document.getElementById('month-picker-modal').style.display = 'none'; }
    function getCurrentDateStr() { const d=new Date(); return `${d.getDate()}-${d.getMonth()}-${d.getFullYear()}`; }
    function parseDateStr(str) { if(!str) return new Date(); const parts = str.split('-'); return new Date(parts[2], parts[1], parts[0]); }
    
    function renderCalendar() {
        const grid = document.getElementById('calendarGrid'); 
        grid.innerHTML = `<div class="day-head">Pt</div><div class="day-head">Sa</div><div class="day-head">√áa</div><div class="day-head">Pe</div><div class="day-head">Cu</div><div class="day-head">Ct</div><div class="day-head">Pz</div>`;
        const y = currentDate.getFullYear(), m = currentDate.getMonth();
        const names = ["Ocak", "≈ûubat", "Mart", "Nisan", "Mayƒ±s", "Haziran", "Temmuz", "Aƒüustos", "Eyl√ºl", "Ekim", "Kasƒ±m", "Aralƒ±k"];
        document.getElementById('monthDisplay').innerText = `${names[m]} ${y}`;
        const first = new Date(y, m, 1).getDay(), start = first===0?6:first-1, days = new Date(y, m+1, 0).getDate();
        for(let i=0; i<start; i++) grid.innerHTML+='<div></div>';
        const todayISO = new Date().toISOString().split('T')[0];

        for(let d=1; d<=days; d++) {
            const cellDate = new Date(y, m, d);
            const offset = cellDate.getTimezoneOffset();
            const cellISO = new Date(cellDate.getTime() - (offset*60*1000)).toISOString().split('T')[0];
            let dots = "";
            tasks.forEach(t => {
                const s = t.startDate || parseDateStr(t.date).toISOString().split('T')[0];
                const e = t.endDate || parseDateStr(t.date).toISOString().split('T')[0];
                if (cellISO >= s && cellISO <= e) {
                    if(Array.isArray(t.person)) t.person.forEach(p => dots += `<span class="task-dot">${p}</span>`);
                    else dots += `<span class="task-dot">${t.person}</span>`;
                }
            });
            let cls = (cellISO === todayISO) ? "day-cell today" : "day-cell";
            grid.innerHTML += `<div class="${cls}" onclick="openModal('${cellISO}')"><b>${d}</b>${dots}</div>`;
        }
    }

    window.openModal = (isoDate) => { 
        selectedDateStr = isoDate; 
        document.getElementById('modalDateText').innerText = isoDate.split('-').reverse().join('.'); 
        cancelTaskEdit(); 
        document.getElementById('t-start-date').value = isoDate;
        document.getElementById('t-end-date').value = isoDate;
        openModalLogic(isoDate); 
        document.querySelector('#taskModal').style.display = 'flex'; 
    }
    window.closeModal = () => document.querySelector('#taskModal').style.display = 'none';
    
    function openModalLogic(isoDate) {
        const dt = tasks.filter(t => {
            const s = t.startDate || parseDateStr(t.date).toISOString().split('T')[0];
            const e = t.endDate || parseDateStr(t.date).toISOString().split('T')[0];
            return isoDate >= s && isoDate <= e;
        });

        document.getElementById('dayTaskList').innerHTML = dt.length ? dt.map(t => {
            const pStr = Array.isArray(t.person) ? t.person.join(", ") : t.person;
            const rangeStr = (t.startDate && t.endDate) ? `<br><small>üìÖ ${t.startDate.split('-').reverse().join('.')} - ${t.endDate.split('-').reverse().join('.')}</small>` : '';
            let actions = '';
            if(userRole === 'admin') {
                actions = `
                    <div style="float:right;">
                        <button onclick="editTask('${t.id}')" style="border:none; background:none; font-size:1.2rem; cursor:pointer;">‚úèÔ∏è</button>
                        <button onclick="delTask('${t.id}')" style="border:none; background:none; color:red; font-size:1.2rem; cursor:pointer;">üóë</button>
                    </div>`;
            }
            return `<div style="padding:10px; background:#f9f9f9; border-radius:8px; margin-bottom:5px; border-left:4px solid #764ba2;">${actions}<strong>${pStr}</strong><br>üìç ${t.projectName} ${rangeStr}</div>`;
        }).join('') : 'Bu tarihte g√∂rev yok.';
    }

    window.openCustodyModal = (type, id, name, extra) => {
        custodyType = type; custodyTargetId = id;
        document.getElementById('custodyItemName').innerText = `${name} (${extra||''})`;
        document.getElementById('c-person').innerHTML = users.map(u => `<option value="${u.name}">${u.name}</option>`).join('');
        document.getElementById('custodyModal').style.display = 'flex';
    }
    window.closeCustodyModal = () => document.getElementById('custodyModal').style.display = 'none';
    window.saveCustody = async () => {
        const person = document.getElementById('c-person').value;
        const collectionName = custodyType === 'vehicle' ? 'vehicles' : 'devices';
        await updateDoc(doc(db, collectionName, custodyTargetId), { currentHolder: person });
        const itemName = document.getElementById('custodyItemName').innerText;
        await addLog(custodyType, itemName, 'take', person);
        showToast("Zimmetlendi", "success");
        closeCustodyModal();
    }
    window.returnItem = async (type, id) => {
        if(confirm("ƒ∞ade alƒ±nsƒ±n mƒ±?")) {
            const collectionName = type === 'vehicle' ? 'vehicles' : 'devices';
            let prevHolder = "Bilinmiyor";
            const itemDoc = type === 'vehicle' ? vehicles.find(v=>v.id===id) : devices.find(d=>d.id===id);
            if(itemDoc) prevHolder = itemDoc.currentHolder;
            await updateDoc(doc(db, collectionName, id), { currentHolder: null });
            let itemDetail = itemDoc ? (type==='vehicle' ? `${itemDoc.plate}` : `${itemDoc.name}`) : '';
            await addLog(type, itemDetail, 'return', prevHolder);
            showToast("ƒ∞ade alƒ±ndƒ±", "success");
        }
    }
    window.exportExcel = () => {
        if (typeof XLSX === 'undefined') return showToast("Excel mod√ºl√º y√ºklenemedi", "error");
        const [year, month] = currentReportDate.split('-').map(Number);
        const reportData = [];
        users.forEach(u => {
            let days = 0;
            tasks.forEach(t => {
                let start = new Date(t.startDate || parseDateStr(t.date));
                let end = new Date(t.endDate || parseDateStr(t.date));
                let loop = new Date(start);
                while(loop <= end) {
                    if (loop.getFullYear() === year && loop.getMonth() === (month - 1)) {
                         if (Array.isArray(t.person)) { if(t.person.includes(u.name)) days++; }
                         else if(t.person === u.name) days++;
                    }
                    loop.setDate(loop.getDate() + 1);
                }
            });
            reportData.push({ "Personel": u.name, "√áalƒ±≈üma G√ºn√º": days });
        });
        const ws = XLSX.utils.json_to_sheet(reportData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Efor");
        XLSX.writeFile(wb, `Personel_Efor_${currentReportDate}.xlsx`);
    }
    function renderVehicleList(){document.getElementById('vehicleListArea').innerHTML = vehicles.map(v => { 
        let zimmetHtml = v.currentHolder ? `<div style="margin-top:5px;"><span class="badge badge-orange">üë§ ${v.currentHolder}</span> ${userRole==='admin'?`<button class="btn-sm btn-outline-red" onclick="returnItem('vehicle','${v.id}')">ƒ∞ade Al</button>`:''}</div>` : (userRole==='admin' ? `<div style="margin-top:5px;"><button class="btn-sm btn-outline-blue" onclick="openCustodyModal('vehicle','${v.id}','${v.plate}','${v.info}')">Zimmetle</button></div>` : ''); 
        let actionHtml = userRole==='admin' ? `<div><button onclick="editVehicle('${v.id}')" style="border:none; bg:none; font-size:1.1rem;">‚úé</button><button onclick="deleteVehicle('${v.id}')" style="color:red; border:none; bg:none; font-size:1.1rem;">üóë</button></div>` : '';
        return `<div class="info-card ${v.currentHolder?'custody':'active'}"><div class="info-card-header"><div><strong>${v.plate}</strong><br><small>${v.info}</small></div>${actionHtml}</div>${zimmetHtml}</div>`; 
    }).join('');}

    function renderDeviceList(){
        const todayISO = new Date().toISOString().split('T')[0];
        document.getElementById('deviceListArea').innerHTML = devices.map(d => { 
            let statusBadge = `<span class="badge badge-green">BO≈ûTA</span>`, zimmetHtml = ""; 
            if(d.currentHolder) { statusBadge = `<span class="badge badge-orange">üë§ ${d.currentHolder}</span>`; if(userRole==='admin') zimmetHtml = `<button class="btn-sm btn-outline-red" onclick="returnItem('device','${d.id}')">ƒ∞ade Al</button>`; } 
            else if(userRole==='admin') { zimmetHtml = `<button class="btn-sm btn-outline-blue" onclick="openCustodyModal('device','${d.id}','${d.name}', '${d.serial}')">Zimmetle</button>`; } 
            const at = tasks.find(t => { const s = t.startDate||parseDateStr(t.date).toISOString().split('T')[0]; const e = t.endDate||parseDateStr(t.date).toISOString().split('T')[0]; return todayISO >= s && todayISO <= e && (Array.isArray(t.device) ? t.device.includes(d.name) : t.device === d.name); });
            if(at) statusBadge += ` <span class="badge badge-red" style="margin-left:5px">G√ñREVDE</span>`; 
            let actionHtml = userRole==='admin' ? `<div><button onclick="editDevice('${d.id}')" style="border:none; bg:none; font-size:1.1rem;">‚úé</button><button onclick="deleteDevice('${d.id}')" style="color:red; border:none; bg:none; font-size:1.1rem;">üóë</button></div>` : '';
            return `<div class="info-card ${d.currentHolder?'custody':'active'}"><div class="info-card-header"><div><strong>${d.name}</strong> <small>(${d.serial})</small></div>${actionHtml}</div><div style="display:flex; justify-content:space-between; align-items:center; margin-top:5px;">${statusBadge}${zimmetHtml}</div></div>`; 
        }).join('');
    }
    
    function renderProjects(){document.getElementById('projectListBody').innerHTML=projects.map(p=>{
        let actionHtml = userRole==='admin' ? `<div style="float:right;"><button onclick="editProject('${p.id}')" style="border:none; bg:none; font-size:1.1rem;">‚úé</button><button onclick="deleteProject('${p.id}')" style="color:red; border:none; bg:none; font-size:1.1rem;">üóë</button></div>` : '';
        return `<div style="padding:15px; border-bottom:1px solid #eee;"><strong>${p.name}</strong> (${p.start||'-'} / ${p.end||'?'})<br><small>${p.manager||'-'}</small> ${actionHtml}</div>`;}).join('');
    }

    function renderUserList(){document.getElementById('userListArea').innerHTML=users.map(u=>{
        let actionHtml = userRole==='admin' ? `<div><button onclick="editUser('${u.email}')" style="border:none; bg:none; margin-right:5px;">‚úé</button><button onclick="deleteUser('${u.email}')" style="color:red; border:none; bg:none;">üóë</button></div>` : '';
        return `<div class="user-card" style="padding:10px; border-bottom:1px solid #eee; display:flex; justify-content:space-between;"><div><strong>${u.name}</strong> <small>(${u.title||''})</small><br><small>${u.email}</small></div>${actionHtml}</div>`}).join('');
    }

    window.editTask = (id) => {
        const t = tasks.find(x => x.id === id);
        if (!t) return;
        editingTaskId = id;
        document.getElementById('taskFormTitle').innerText = "G√∂revi D√ºzenle";
        document.getElementById('t-start-date').value = t.startDate || "";
        document.getElementById('t-end-date').value = t.endDate || "";
        document.getElementById('t-project-select').value = t.projectId || "";
        document.getElementById('t-loc').value = t.location || "";
        setMultiSelectValues('ms-person', Array.isArray(t.person) ? t.person : [t.person]);
        setMultiSelectValues('ms-device', Array.isArray(t.device) ? t.device : [t.device]);
        setMultiSelectValues('ms-plate', Array.isArray(t.plate) ? t.plate : [t.plate]);
        document.getElementById('btn-save-task').style.display = 'none';
        document.getElementById('btn-update-task').style.display = 'block';
        document.getElementById('btn-cancel-task').style.display = 'block';
        document.getElementById('assignForm').scrollIntoView({behavior: 'smooth'});
    }
    window.updateTaskDB = async () => {
        const per = getMultiSelectValues('ms-person'), dev = getMultiSelectValues('ms-device'), plate = getMultiSelectValues('ms-plate');
        const projVal = document.getElementById('t-project-select').value;
        const projName = document.getElementById('t-project-select').options[document.getElementById('t-project-select').selectedIndex].text;
        await updateDoc(doc(db, "tasks", editingTaskId), { startDate: document.getElementById('t-start-date').value, endDate: document.getElementById('t-end-date').value, person: per, projectName: projName, projectId: projVal, location: document.getElementById('t-loc').value, device: dev, plate: plate });
        showToast("G√∂rev g√ºncellendi!", "success"); cancelTaskEdit();
    }
    window.cancelTaskEdit = () => {
        editingTaskId = null;
        document.getElementById('taskFormTitle').innerText = "Yeni Atama";
        document.getElementById('btn-save-task').style.display = 'block';
        document.getElementById('btn-update-task').style.display = 'none';
        document.getElementById('btn-cancel-task').style.display = 'none';
        document.getElementById('t-loc').value = "";
        document.querySelectorAll('.multi-select-area input').forEach(c => c.checked = false);
    }
    function setMultiSelectValues(id, values) { if(!values) return; document.querySelectorAll(`#${id} input`).forEach(cb => { cb.checked = values.includes(cb.value); }); }
</script>
</body>
</html>
