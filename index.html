<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ekip Takip (Kurtarma S√ºr√ºm√º)</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4facfe">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">

    <style>
        :root { --primary: #667eea; --secondary: #764ba2; --bg: #f3f5f9; --text: #2d3436; --nav-height: 70px; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Poppins', sans-serif; background: var(--bg); margin: 0; padding: 0; padding-bottom: 100px; color: var(--text); }

        /* Gƒ∞Rƒ∞≈û EKRANI */
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, var(--primary), var(--secondary)); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
        .login-box { background: white; padding: 30px; border-radius: 20px; width: 100%; max-width: 350px; text-align: center; box-shadow: 0 20px 40px rgba(0,0,0,0.2); }
        .login-box input { width: 100%; padding: 15px; margin: 10px 0; border: 1px solid #ddd; border-radius: 12px; background: #f9f9f9; font-size: 16px; }
        .login-box button { width: 100%; padding: 15px; background: var(--secondary); color: white; border: none; border-radius: 12px; font-weight: 600; cursor: pointer; margin-top: 10px; }
        
        /* GENEL UI */
        .hidden { display: none !important; }
        .admin-only { display: none; }
        .view-section { display: none; animation: fadeIn 0.3s; } .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .app-header { padding: 20px; display: flex; justify-content: space-between; align-items: center; background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .container { max-width: 1000px; margin: 20px auto; padding: 0 15px; }

        /* KARTLAR */
        .hero-card { background: linear-gradient(135deg, var(--primary), var(--secondary)); border-radius: 20px; padding: 25px; color: white; margin-bottom: 20px; box-shadow: 0 10px 20px rgba(118, 75, 162, 0.3); }
        .hero-stats { display: flex; justify-content: space-around; margin-top: 15px; text-align: center; }
        .hero-stats span { font-size: 1.5rem; font-weight: bold; display: block; }
        
        .modern-card { background: white; border-radius: 15px; padding: 15px; margin-bottom: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        
        /* TAKVƒ∞M */
        .cal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; }
        .day-head { text-align: center; font-size: 0.7rem; color: #888; }
        .day { background: #f8f9fa; min-height: 80px; border-radius: 8px; padding: 5px; font-size: 0.8rem; cursor: pointer; display: flex; flex-direction: column; }
        .day.today { border: 2px solid var(--secondary); background: white; }
        .task-dot { font-size: 0.6rem; background: #e0e7ff; color: #4338ca; padding: 2px 4px; margin-top: 2px; border-radius: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* Lƒ∞STE ELEMANLARI */
        .item-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #eee; }
        .info-card { background: white; padding: 15px; border-radius: 12px; margin-bottom: 10px; border-left: 5px solid #ccc; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .info-card.active { border-left-color: #27ae60; } .info-card.busy { border-left-color: #e74c3c; } .info-card.custody { border-left-color: #f39c12; }
        .badge { padding: 4px 8px; border-radius: 6px; font-size: 0.7rem; font-weight: bold; }
        .bg-green { background: #d1fae5; color: #065f46; } .bg-red { background: #fee2e2; color: #991b1b; } .bg-orange { background: #ffedd5; color: #9a3412; }

        /* FORM */
        input, select { width: 100%; padding: 12px; border: 1px solid #eee; background: #f9f9f9; border-radius: 10px; margin-bottom: 10px; outline: none; }
        .btn { width: 100%; padding: 12px; background: var(--secondary); color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; margin-top: 5px;}
        .btn-sm { padding: 5px 10px; font-size: 0.8rem; width: auto; border-radius: 6px; }

        /* ALT MEN√ú */
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: white; height: var(--nav-height); border-top-left-radius: 20px; border-top-right-radius: 20px; display: flex; align-items: center; box-shadow: 0 -5px 20px rgba(0,0,0,0.05); z-index: 1000; overflow-x: auto; padding: 0 10px; }
        .nav-item { flex: 1; min-width: 70px; display: flex; flex-direction: column; align-items: center; font-size: 0.7rem; color: #999; cursor: pointer; }
        .nav-item.active { color: var(--secondary); font-weight: bold; }
        .nav-item span { font-size: 1.4rem; margin-bottom: 2px; }

        /* MODAL */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; display: none; justify-content: center; align-items: center; }
        .modal-content { background: white; width: 90%; max-width: 500px; padding: 25px; border-radius: 20px; max-height: 85vh; overflow-y: auto; }
        
        /* Multi Select */
        .ms-area { border: 1px solid #eee; border-radius: 10px; padding: 10px; max-height: 120px; overflow-y: auto; margin-bottom: 10px; }
        .ms-opt { display: flex; align-items: center; margin-bottom: 5px; } .ms-opt input { width: auto; margin-right: 10px; }

        /* Table */
        .log-table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
        .log-table td { padding: 8px; border-bottom: 1px solid #eee; }
    </style>
</head>
<body>

<div id="login-screen">
    <div class="login-box">
        <h2>Ekip Takip</h2>
        <input type="email" id="lemail" placeholder="E-Posta">
        <input type="password" id="lpass" placeholder="≈ûifre">
        <button onclick="login()">Giri≈ü Yap</button>
        <p onclick="document.getElementById('reg-area').classList.toggle('hidden')" style="margin-top:15px; cursor:pointer; color:#667eea;">Hesap Olu≈ütur</p>
        <div id="reg-area" class="hidden">
            <input type="text" id="rname" placeholder="Ad Soyad">
            <input type="text" id="rtitle" placeholder="√únvan">
            <input type="email" id="remail" placeholder="E-Posta">
            <input type="password" id="rpass" placeholder="≈ûifre">
            <button onclick="register()">Kaydol</button>
        </div>
    </div>
</div>

<div id="app-screen" class="hidden">
    <div class="app-header">
        <h3 style="margin:0;" id="user-display">Kullanƒ±cƒ±</h3>
        <button class="btn btn-sm" onclick="logout()" style="background:#e74c3c;">√áƒ±kƒ±≈ü</button>
    </div>

    <div class="container">
        
        <div id="tab-cal" class="view-section active">
            <div class="hero-card">
                <h2 style="margin:0;" id="stats-date">Bug√ºn</h2>
                <div class="hero-stats">
                    <div class="stat-item"><span id="s-total">0</span>Ekip</div>
                    <div class="stat-item"><span id="s-active">0</span>Sahada</div>
                    <div class="stat-item"><span id="s-idle">0</span>Bo≈üta</div>
                </div>
            </div>
            <div class="modern-card">
                <div class="cal-header">
                    <button class="btn-sm" onclick="moveMonth(-1)">‚óÄ</button>
                    <h3 style="margin:0;" id="month-label">Ay</h3>
                    <button class="btn-sm" onclick="moveMonth(1)">‚ñ∂</button>
                </div>
                <div class="cal-grid" id="cal-grid"></div>
            </div>
        </div>

        <div id="tab-proj" class="view-section">
            <div class="admin-only modern-card">
                <h3>Yeni Proje</h3>
                <input type="text" id="p-name" placeholder="Proje Adƒ±">
                <select id="p-man"></select>
                <div style="display:flex; gap:5px;"><input type="date" id="p-start"><input type="date" id="p-end"></div>
                <div style="display:flex; gap:5px;"><input type="number" id="p-cost" placeholder="Maliyet"><input type="number" id="p-offer" placeholder="Teklif"></div>
                <button class="btn" onclick="addProj()">Kaydet</button>
            </div>
            <div class="modern-card" id="proj-list"></div>
        </div>

        <div id="tab-team" class="view-section">
            <div class="modern-card" id="team-list"></div>
        </div>

        <div id="tab-dev" class="view-section">
            <div class="admin-only modern-card">
                <h3>Yeni Cihaz</h3>
                <input type="text" id="d-name" placeholder="Ad">
                <input type="text" id="d-ser" placeholder="Seri No">
                <input type="date" id="d-cal">
                <button class="btn" onclick="addDev()">Ekle</button>
            </div>
            <div id="dev-list"></div>
        </div>

        <div id="tab-veh" class="view-section">
            <div class="admin-only modern-card">
                <h3>Yeni Ara√ß</h3>
                <input type="text" id="v-plate" placeholder="Plaka">
                <input type="text" id="v-info" placeholder="Model">
                <input type="date" id="v-insp">
                <button class="btn" onclick="addVeh()">Ekle</button>
            </div>
            <div id="veh-list"></div>
        </div>

        <div id="tab-user" class="view-section admin-only">
            <div class="modern-card">
                <h3>Kullanƒ±cƒ± Ekle</h3>
                <input type="text" id="u-name" placeholder="Ad">
                <input type="text" id="u-title" placeholder="√únvan">
                <input type="email" id="u-email" placeholder="E-Posta">
                <select id="u-role"><option value="staff">Personel</option><option value="admin">Y√∂netici</option></select>
                <button class="btn" onclick="addUser()">Ekle</button>
            </div>
            <div class="modern-card" id="user-list"></div>
        </div>

        <div id="tab-rep" class="view-section admin-only">
            <div class="modern-card">
                <label>Ay Se√ß:</label>
                <input type="month" id="r-date" onchange="renderLogs()">
            </div>
            <div class="modern-card">
                <h3>Zimmet Ge√ßmi≈üi</h3>
                <div style="max-height:300px; overflow-y:auto;"><table class="log-table" id="log-table"></table></div>
            </div>
            <div class="modern-card">
                <h3>√áalƒ±≈üma G√ºnleri</h3>
                <table class="log-table" id="eff-table"></table>
            </div>
        </div>
    </div>

    <div class="bottom-nav">
        <div class="nav-item active" onclick="goTab('cal')"><span>üìÖ</span>Takvim</div>
        <div class="nav-item" onclick="goTab('proj')"><span>üìÇ</span>Proje</div>
        <div class="nav-item" onclick="goTab('team')"><span>üë•</span>Ekip</div>
        <div class="nav-item" onclick="goTab('veh')"><span>üöó</span>Ara√ß</div>
        <div class="nav-item" onclick="goTab('dev')"><span>üß∞</span>Cihaz</div>
        <div class="nav-item admin-only" onclick="goTab('user')"><span>‚öôÔ∏è</span>Yetki</div>
        <div class="nav-item admin-only" onclick="goTab('rep')"><span>üìä</span>Rapor</div>
    </div>
</div>

<div class="modal" id="taskModal">
    <div class="modal-content">
        <h3>G√∂revler <span onclick="document.getElementById('taskModal').style.display='none'" style="float:right;cursor:pointer;">‚úï</span></h3>
        <p id="tm-date"></p>
        <div id="tm-list" style="margin-bottom:15px;"></div>
        <div class="admin-only">
            <hr>
            <h4>Atama Yap</h4>
            <label>Personel:</label><div class="ms-area" id="ms-per"></div>
            <label>Proje:</label><select id="t-proj"></select>
            <input type="text" id="t-loc" placeholder="Konum">
            <label>Ara√ß:</label><div class="ms-area" id="ms-veh"></div>
            <label>Cihaz:</label><div class="ms-area" id="ms-dev"></div>
            <button class="btn" onclick="saveTask()">Kaydet</button>
        </div>
    </div>
</div>

<div class="modal" id="custodyModal">
    <div class="modal-content">
        <h3>Zimmetle</h3>
        <p id="cm-name"></p>
        <select id="c-per"></select>
        <button class="btn" onclick="saveCustody()">Kaydet</button>
        <button class="btn" style="background:#ccc" onclick="document.getElementById('custodyModal').style.display='none'">ƒ∞ptal</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, deleteDoc, updateDoc, doc, onSnapshot, query, orderBy, setDoc, getDoc, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyD4XZR8JAMe-Qr2Oj2UGnp9mFc8En38gxY",
      authDomain: "ekiptakipapp.firebaseapp.com",
      projectId: "ekiptakipapp",
      storageBucket: "ekiptakipapp.firebasestorage.app",
      messagingSenderId: "55716082808",
      appId: "1:55716082808:web:b144b953684fc9f80c698d",
      measurementId: "G-S6Q0H5RHR7"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let users=[], projects=[], tasks=[], vehicles=[], devices=[], logs=[];
    let curUser, role='staff', curDate=new Date(), selDate;
    let custodyId, custodyType;

    onAuthStateChanged(auth, async (user) => {
        if (user) {
            const u = await getDoc(doc(db, "users", user.email));
            if (u.exists()) {
                curUser=u.data(); role=curUser.role;
                document.getElementById('welcomeUser').innerText = curUser.name.split(' ')[0];
                document.querySelectorAll('.admin-only').forEach(e=>e.style.display=(role==='admin'?'block':'none'));
                document.querySelectorAll('.nav-item.admin-only').forEach(e=>e.style.display=(role==='admin'?'flex':'none'));
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('app-screen').classList.remove('hidden');
                document.getElementById('r-date').value = new Date().toISOString().slice(0,7);
                startData();
            } else {
                await setDoc(doc(db,"users",user.email),{name:"Y√∂netici",email:user.email,role:"admin"});
                window.location.reload();
            }
        } else {
            document.getElementById('login-screen').classList.remove('hidden');
            document.getElementById('app-screen').classList.add('hidden');
        }
    });

    window.login = () => signInWithEmailAndPassword(auth, document.getElementById('lemail').value, document.getElementById('lpass').value).catch(e=>alert(e.message));
    window.logout = () => signOut(auth).then(()=>window.location.reload());
    window.register = async () => {
        try {
            const em=document.getElementById('remail').value;
            await createUserWithEmailAndPassword(auth, em, document.getElementById('rpass').value);
            await setDoc(doc(db,"users",em), {name:document.getElementById('rname').value, title:document.getElementById('rtitle').value, email:em, role:'admin'});
        } catch(e){alert(e.message)}
    }

    function startData() {
        const load = (c, arr, cb) => onSnapshot(collection(db, c), s => { arr.length=0; s.forEach(d=>arr.push({id:d.id,...d.data()})); if(cb)cb(); loadDrops(); });
        load("users", users, renderUsers);
        load("projects", projects, renderProjects);
        load("vehicles", vehicles, renderVehicles);
        load("devices", devices, renderDevices);
        
        onSnapshot(query(collection(db, "logs"), orderBy("date", "desc"), limit(100)), s=>{ logs=[]; s.forEach(d=>logs.push(d.data())); renderLogs(); });

        onSnapshot(collection(db, "tasks"), s => {
            tasks=[]; s.forEach(d=>tasks.push({id:d.id,...d.data()}));
            renderCal(); renderTeam(); updateStats(new Date().toISOString().split('T')[0]); renderLogs();
        });
    }

    // TABS
    window.goTab = (t) => {
        document.querySelectorAll('.view-section').forEach(e=>e.classList.remove('active'));
        document.getElementById('tab-'+t).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('active'));
        event.currentTarget.classList.add('active');
    }

    // CALENDAR
    window.moveMonth = (m) => { curDate.setMonth(curDate.getMonth()+m); renderCal(); }
    function renderCal() {
        const m=curDate.getMonth(), y=curDate.getFullYear();
        document.getElementById('monthDisplay').innerText = `${m+1}/${y}`;
        const first=new Date(y,m,1).getDay(), days=new Date(y,m+1,0).getDate();
        let h = ""; for(let i=0; i<(first===0?6:first-1); i++) h+=`<div></div>`;
        const today = new Date().toISOString().split('T')[0];
        for(let d=1; d<=days; d++) {
            const dk = `${d}-${m}-${y}`;
            const dt = tasks.filter(t=>t.date===dk);
            let dots=""; dt.forEach(t=>{ if(Array.isArray(t.person)) t.person.forEach(p=>dots+=`<span class="task-dot">${p}</span>`); else dots+=`<span class="task-dot">${t.person}</span>`; });
            h+=`<div class="day-cell ${dk===today?'today':''}" onclick="openModal('${dk}')"><b>${d}</b>${dots}</div>`;
        }
        document.getElementById('calGrid').innerHTML = h;
    }
    window.openModal = (dk) => {
        selDate=dk; document.getElementById('tm-date').innerText=dk;
        const dt=tasks.filter(t=>t.date===dk);
        document.getElementById('tm-list').innerHTML = dt.map(t=>`
            <div style="padding:10px; background:#f9f9f9; border-radius:8px; margin-bottom:5px;">
                <strong>${Array.isArray(t.person)?t.person.join(', '):t.person}</strong><br>${t.projectName}
                ${role==='admin'?`<button onclick="delTask('${t.id}')" style="float:right; color:red; border:none;">üóë</button>`:''}
            </div>`).join('') || 'G√∂rev Yok';
        document.getElementById('taskModal').style.display='flex';
    }

    // CRUD
    window.saveTask = async () => {
        const per = getMulti('ms-per'), dev = getMulti('ms-dev'), veh = getMulti('ms-veh');
        const pid = document.getElementById('t-proj').value;
        if(!pid || per.length===0) return alert("Eksik");
        const pn = projects.find(p=>p.id===pid).name;
        await addDoc(collection(db,"tasks"), { date:selDate, person:per, projectName:pn, projectId:pid, location:document.getElementById('t-loc').value, device:dev, plate:veh });
        document.getElementById('taskModal').style.display='none';
    }
    window.delTask = (id) => deleteDoc(doc(db,"tasks",id)).then(()=>document.getElementById('taskModal').style.display='none');
    
    window.addProj = () => addDoc(collection(db,"projects"),{name:document.getElementById('p-name').value, manager:document.getElementById('p-man').value, start:document.getElementById('p-start').value, end:document.getElementById('p-end').value, cost:document.getElementById('p-cost').value, offer:document.getElementById('p-offer').value}).then(()=>document.getElementById('p-name').value="");
    window.addVeh = () => addDoc(collection(db,"vehicles"),{plate:document.getElementById('v-plate').value, info:document.getElementById('v-info').value, inspectionDate:document.getElementById('v-insp').value, currentHolder:null}).then(()=>document.getElementById('v-plate').value="");
    window.addDev = () => addDoc(collection(db,"devices"),{name:document.getElementById('d-name').value, serial:document.getElementById('d-ser').value, calib:document.getElementById('d-cal').value, currentHolder:null}).then(()=>document.getElementById('d-name').value="");
    window.addUser = () => setDoc(doc(db,"users",document.getElementById('u-email').value),{name:document.getElementById('u-name').value, title:document.getElementById('u-title').value, email:document.getElementById('u-email').value, role:document.getElementById('u-role').value}).then(()=>alert("Eklendi"));

    // ZIMMET
    window.openCustody = (type, id, name) => { custodyType=type; custodyId=id; document.getElementById('cm-name').innerText=name; document.getElementById('custodyModal').style.display='flex'; }
    window.saveCustody = async () => {
        const p = document.getElementById('c-per').value;
        await updateDoc(doc(db, custodyType==='vehicle'?'vehicles':'devices', custodyId), {currentHolder:p});
        await addDoc(collection(db,"logs"), {date:new Date().toISOString(), type:custodyType, item:document.getElementById('cm-name').innerText, action:'take', person:p, admin:curUser.name});
        document.getElementById('custodyModal').style.display='none';
    }
    window.dropItem = async (col, id, name) => {
        if(confirm("ƒ∞ade?")) {
            await updateDoc(doc(db,col,id), {currentHolder:null});
            await addDoc(collection(db,"logs"), {date:new Date().toISOString(), type:col, item:name, action:'return', person:'-', admin:curUser.name});
        }
    }

    // RENDERS
    function renderProjects() { document.getElementById('projectList').innerHTML=projects.map(p=>`<div class="info-card"><strong>${p.name}</strong> (${p.start||'-'})<br><small>${p.manager}</small></div>`).join(''); }
    function renderVehicles() { document.getElementById('veh-list').innerHTML=vehicles.map(v=>`<div class="info-card ${v.currentHolder?'custody':'active'}"><div><strong>${v.plate}</strong> ${v.info}</div>${v.currentHolder?`<span class="badge bg-orange">${v.currentHolder}</span> ${role==='admin'?`<button class="btn-sm btn-outline-red" onclick="dropItem('vehicles','${v.id}','${v.plate}')">ƒ∞ade</button>`:''}` : (role==='admin'?`<button class="btn-sm btn-outline-blue" onclick="openCustody('vehicle','${v.id}','${v.plate}')">Ver</button>`:'<span class="badge bg-green">BO≈ûTA</span>')}</div>`).join(''); }
    function renderDevices() { document.getElementById('dev-list').innerHTML=devices.map(d=>`<div class="info-card ${d.currentHolder?'custody':'active'}"><div><strong>${d.name}</strong> (${d.serial})</div>${d.currentHolder?`<span class="badge bg-orange">${d.currentHolder}</span> ${role==='admin'?`<button class="btn-sm btn-outline-red" onclick="dropItem('devices','${d.id}','${d.name}')">ƒ∞ade</button>`:''}` : (role==='admin'?`<button class="btn-sm btn-outline-blue" onclick="openCustody('device','${d.id}','${d.name}')">Ver</button>`:'<span class="badge bg-green">BO≈ûTA</span>')}</div>`).join(''); }
    function renderUsers() { document.getElementById('userList').innerHTML=users.map(u=>`<div class="info-card"><strong>${u.name}</strong> <small>${u.title||''}</small><br>${u.email}</div>`).join(''); }
    
    function renderTeam() {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('teamList').innerHTML=users.map(u=>{
            const dt = tasks.filter(t=>t.date===today);
            const at = dt.find(t=>Array.isArray(t.person)?t.person.includes(u.name):t.person===u.name);
            return `<div class="person-row"><div style="display:flex;align-items:center;"><div class="avatar">${u.name.charAt(0)}</div><strong>${u.name}</strong></div><span class="badge ${at?'bg-green':'bg-gray'}">${at?'SAHADA':'BO≈ûTA'}</span></div>`;
        }).join('');
    }
    function updateStats() {
        const today = new Date().toISOString().split('T')[0];
        const dt = tasks.filter(t=>t.date===today);
        let act=0; dt.forEach(t=>{ if(Array.isArray(t.person)) act+=t.person.length; else act++; });
        document.getElementById('s-total').innerText=users.length; document.getElementById('s-active').innerText=act; document.getElementById('s-idle').innerText=Math.max(0,users.length-act);
    }
    function renderLogs() {
        const ym = document.getElementById('r-date').value; 
        if(!ym) return;
        const fl = logs.filter(l=>l.date.startsWith(ym));
        document.getElementById('log-table').innerHTML = fl.map(l=>`<tr><td>${l.date.slice(0,10)}</td><td>${l.person} ${l.action==='take'?'Aldƒ±':'Verdi'}: ${l.item}</td></tr>`).join('');
        
        // Efor
        const cnt={}; users.forEach(u=>cnt[u.name]=0);
        tasks.forEach(t=>{
            if(t.date.startsWith(ym.split('-')[1])) { // Basit tarih kontrol√º
                 if(Array.isArray(t.person)) t.person.forEach(p=>{if(cnt[p]!==undefined)cnt[p]++}); else if(cnt[t.person]!==undefined)cnt[t.person]++;
            }
        });
        document.getElementById('eff-table').innerHTML=Object.keys(cnt).map(k=>`<tr><td>${k}</td><td>${cnt[k]} G√ºn</td></tr>`).join('');
    }

    // DROPDOWNS
    function loadDrops() {
        const sel = (id, arr) => { if(document.getElementById(id)) document.getElementById(id).innerHTML=arr.map(x=>`<option>${x.name}</option>`).join(''); }
        const ms = (id, arr, k) => { if(document.getElementById(id)) document.getElementById(id).innerHTML=arr.map(x=>`<div class="ms-opt"><input type="checkbox" value="${x[k]}">${x[k]}</div>`).join(''); }
        sel('p-man', users); sel('c-per', users);
        ms('ms-per', users, 'name'); ms('ms-veh', vehicles, 'plate'); ms('ms-dev', devices, 'name');
        if(document.getElementById('t-proj')) document.getElementById('t-proj').innerHTML=`<option value="">Se√ß</option>`+projects.map(p=>`<option value="${p.id}">${p.name}</option>`).join('');
    }
    function getMulti(id){return Array.from(document.querySelectorAll(`#${id} input:checked`)).map(i=>i.value);}
</script>
</body>
</html>
